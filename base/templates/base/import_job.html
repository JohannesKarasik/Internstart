<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Internstart Scraper</title>
  <style>
    :root {
      --accent:#FF2F5A; --bg:#0B0F1A; --bg-2:#0E1324;
      --card:rgba(18,22,36,.72); --stroke:rgba(255,255,255,.08);
      --text:#E7ECF3; --muted:#A6B0C3; --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    @media(prefers-color-scheme:light){
      :root{--bg:#F6F8FF;--bg-2:#EEF1FF;--card:#fff;--text:#0B0F1A;--muted:#596177;--stroke:rgba(10,15,30,.08);}
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(180deg,var(--bg),var(--bg-2));color:var(--text);font:500 16px/1.5 Inter,system-ui}
    .ai-shell{position:relative;min-height:100dvh;overflow-x:hidden}
    .wrap{max-width:1000px;margin:clamp(24px,5vw,60px) auto;padding:0 clamp(20px,5vw,32px);}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;
      box-shadow:var(--shadow);padding:clamp(18px,3vw,28px);}
    .title{display:flex;align-items:center;gap:10px;font-size:clamp(22px,3.2vw,28px);}
    .subtitle{color:var(--muted);margin-bottom:12px;}
    .select{width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);font-weight:600;margin-bottom:8px;}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px;}
    .btn{background:var(--accent);color:#0B0F1A;border:none;border-radius:12px;padding:12px 16px;
      font-weight:700;cursor:pointer;}
    .btn:hover{filter:brightness(1.05);}
    .results-container{margin-top:24px;display:flex;flex-direction:column;gap:16px;}
    .job-row{background:rgba(255,255,255,.05);border:1px solid var(--stroke);border-radius:14px;padding:16px 18px;}
    .muted{text-align:center;color:var(--muted);}
  </style>
</head>
<body>
  <div class="ai-shell">
    <main class="wrap">
      <section class="card">
        <header>
          <h1 class="title">Import Jobs from Scraper</h1>
          <p class="subtitle">Run a scraper, review results, then import each listing with AI-powered company detection.</p>
        </header>

        <!-- Filters -->
        <div class="filters">
          <label>Country</label>
          <select id="countrySelect" class="select">
            <option value="">Select a country</option>
            <option value="DK">ğŸ‡©ğŸ‡° Denmark</option>
            <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
            <option value="UK">ğŸ‡¬ğŸ‡§ United Kingdom</option>
            <option value="FRA">ğŸ‡«ğŸ‡· France</option>
            <option value="GER">ğŸ‡©ğŸ‡ª Germany</option>
          </select>

          <label>Industry</label>
          <select id="industrySelect" class="select">
            <option value="">Select an industry</option>
            <option value="business_finance">Business & Finance</option>
            <option value="marketing">Marketing & Communications</option>
            <option value="software_backend">Software Development (Backend)</option>
            <option value="software_frontend">Software Development (Frontend)</option>
            <option value="sales_customer">Sales & Customer Relations</option>
          </select>

          <label>Job Type</label>
          <select id="jobTypeSelect" class="select">
            <option value="">Select a job type</option>
            <option value="internship">Internship</option>
            <option value="student_job">Student Job</option>
            <option value="full_time">Full Time Job</option>
          </select>

          <!-- ğŸ†• Scraper Type -->
          <label>Scraper Type</label>
          <select id="scraperSelect" class="select">
            <option value="uk_marketing">ğŸ‡¬ğŸ‡§ UK â€“ Marketing & Communications</option>
            <option value="uk_finance">ğŸ‡¬ğŸ‡§ UK â€“ Business & Finance</option>
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
          <button type="button" id="scrapeBtn" class="btn">Run Scraper</button>
          <button type="button" id="addToDBBtn" class="btn" style="background:#7B61FF;">Add Results to Database</button>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="results-container">
          {% if results %}
            {% for job in results %}
              <div class="job-row">
                <strong>{{ job.title }}</strong><br>
                <a href="{{ job.link }}" target="_blank">{{ job.link }}</a><br>
                <small>{{ job.snippet }}</small>
              </div>
            {% endfor %}
          {% elif error %}
            <p class="muted">âš ï¸ {{ error }}</p>
          {% else %}
            <p class="muted">No results yet â€” run a scraper first.</p>
          {% endif %}
        </div>
      </section>
    </main>
  </div>

  <script>
    window.addEventListener("load", () => {
      const scrapeBtn = document.getElementById("scrapeBtn");
      const addBtn = document.getElementById("addToDBBtn");
      const resultsContainer = document.getElementById("resultsContainer");
    
      let cachedResults = [];
    
      function validateSelections() {
        const country = document.getElementById("countrySelect").value;
        const industry = document.getElementById("industrySelect").value;
        const jobType = document.getElementById("jobTypeSelect").value;
    
        if (!country || !industry || !jobType) {
          alert("Please select Country, Industry, and Job Type before running the scraper.");
          return false;
        }
        return true;
      }
    
      // 1ï¸âƒ£ Run Scraper (improved: show errors + debug info)
      scrapeBtn.addEventListener("click", async () => {
        if (!validateSelections()) return;
    
        resultsContainer.innerHTML = "<p class='muted'>ğŸ”„ Running scraper...</p>";
        scrapeBtn.disabled = true;
    
        try {
          const scraperType = document.getElementById("scraperSelect").value || "uk_marketing";
          const res = await fetch(`/run_scraper/?type=${scraperType}`);
          const isJson = res.headers.get("content-type")?.includes("application/json");
          const data = isJson ? await res.json() : { error: "Non-JSON response from server." };
    
          console.log("[run_scraper] response:", data);
    
          if (!res.ok || data.error) {
            resultsContainer.innerHTML = `
              <div class="job-row">
                <strong>âš ï¸ Scraper error</strong><br>
                <small>${(data.error || "Unknown error").toString().replace(/</g,"&lt;")}</small>
                ${data.stdout ? `<pre style="white-space:pre-wrap;margin-top:8px;">STDOUT:\n${data.stdout.replace(/</g,"&lt;")}</pre>` : ""}
                ${data.stderr ? `<pre style="white-space:pre-wrap;margin-top:8px;">STDERR:\n${data.stderr.replace(/</g,"&lt;")}</pre>` : ""}
              </div>
            `;
            scrapeBtn.disabled = false;
            return;
          }
    
          cachedResults = Array.isArray(data.results) ? data.results : [];
          const totalCount = data.count ?? cachedResults.length;
    
          if (!cachedResults.length) {
            resultsContainer.innerHTML = `
              <div class="job-row">
                <strong>No jobs found.</strong><br>
                <small>Latest file: ${data.latest_file || "â€”"}</small>
                ${data.stdout ? `<pre style="white-space:pre-wrap;margin-top:8px;">STDOUT:\n${data.stdout.replace(/</g,"&lt;")}</pre>` : ""}
              </div>
            `;
            scrapeBtn.disabled = false;
            return;
          }


          function renderResults(filteredResults, count) {
            const totalCount = cachedResults.length;
            const scraperLabel = scraperType.includes("finance") ? "finance-related" : "marketing-related";
            const header = `
              <div class="job-row">
                <strong>âœ… Found ${count} ${scraperLabel} jobs</strong><br>
                <small>Filtered from ${totalCount} total results</small>
                ${data.latest_file ? `<br><small>Latest file: ${data.latest_file}</small>` : ""}
              </div>
            `;
            const list = filteredResults.map((job, i) => `
              <div class="job-row" id="job-${i}">
                <strong>${job.title || "Untitled Job"}</strong><br>
                <a href="${job.link}" target="_blank">${job.link}</a><br>
                <small>${job.snippet || ""}</small><br>
                <span class="status muted">â¸ Waiting...</span>
              </div>
            `).join("");
            resultsContainer.innerHTML = header + list;
          }


    
          // ğŸ¯ Dynamic filtering by scraper type
          let keywordSet = [];

          // ğŸ§  If finance scraper selected â€” show all results (no filtering)
          if (scraperType.includes("finance")) {
            console.log("ğŸ’¼ Finance scraper selected â€” skipping keyword filtering.");
            const filteredResults = cachedResults;
            const count = filteredResults.length;
            console.log(`ğŸ¯ Showing all ${count} finance-related jobs (no filtering).`);
            renderResults(filteredResults, count); // â¬…ï¸ helper weâ€™ll add below
            return;
          } else {
            // ğŸª„ Keep normal marketing filters
            keywordSet = [
              "marketing", "digital", "seo", "sem", "ppc", "social media",
              "content", "copywriter", "copywriting", "pr", "public relations",
              "communications", "brand", "advertising", "creative", "growth",
              "email", "campaign", "media", "community", "influencer",
              "affiliate", "crm", "performance", "ecommerce", "demand gen",
              "account manager", "marcom"
            ];
          }


          const keywordsLower = keywordSet.map(k => k.toLowerCase());

          const filteredResults = cachedResults.filter(job => {
            const text = ((job.title || "") + " " + (job.snippet || "")).toLowerCase();
            return keywordsLower.some(keyword => text.includes(keyword));
          });

          const count = filteredResults.length;
          console.log(`ğŸ¯ Filtered ${count} ${scraperType.includes("finance") ? "finance" : "marketing"}-related jobs out of ${cachedResults.length}`);

    
          if (!count) {
            resultsContainer.innerHTML = `
              <div class="job-row">
                <strong>âš ï¸ No marketing listings found after keyword filtering.</strong><br>
                <small>Try rerunning the scraper or broadening the keyword set.</small>
              </div>
            `;
            scrapeBtn.disabled = false;
            return;
          }
    
          // Render jobs + debug header
          const scraperLabel = scraperType.includes("finance") ? "finance-related" : "marketing-related";
          const header = `
            <div class="job-row">
              <strong>âœ… Found ${count} ${scraperLabel} jobs</strong><br>
              <small>Filtered from ${totalCount} total results</small>
              ${data.latest_file ? `<br><small>Latest file: ${data.latest_file}</small>` : ""}
              ${data.stdout ? `<details style="margin-top:8px;"><summary>Show scraper log</summary><pre style="white-space:pre-wrap;margin-top:8px;">${data.stdout.replace(/</g,"&lt;")}</pre></details>` : ""}
              ${data.stderr ? `<details style="margin-top:8px;"><summary>Show errors</summary><pre style="white-space:pre-wrap;margin-top:8px;">${data.stderr.replace(/</g,"&lt;")}</pre></details>` : ""}
            </div>
          `;
    
          const list = filteredResults.map((job, i) => `
            <div class="job-row" id="job-${i}">
              <strong>${job.title || "Untitled Job"}</strong><br>
              <a href="${job.link}" target="_blank">${job.link}</a><br>
              <small>${job.snippet || ""}</small><br>
              <span class="status muted">â¸ Waiting...</span>
            </div>
          `).join("");
    
          resultsContainer.innerHTML = header + list;
        } catch (err) {
          console.error("run_scraper failed:", err);
          resultsContainer.innerHTML = `<p class='muted'>âŒ Failed to call /run_scraper â€” check console/network tab.</p>`;
        } finally {
          scrapeBtn.disabled = false;
        }
      });
    
      // 2ï¸âƒ£ Process loop (unchanged)
      addBtn.addEventListener("click", async () => {
        if (!cachedResults.length) {
          alert("Run the scraper first.");
          return;
        }
    
        const country = document.getElementById("countrySelect").value;
        const jobType = document.getElementById("jobTypeSelect").value;
        const industry = document.getElementById("industrySelect").value;
    
        addBtn.textContent = "Processing...";
        addBtn.disabled = true;
    
        for (let i = 0; i < cachedResults.length; i++) {
          const job = cachedResults[i];
          const jobEl = document.getElementById(`job-${i}`);
          const statusEl = jobEl.querySelector(".status");
    
          statusEl.textContent = "ğŸ¤– Processing...";
          statusEl.style.color = "#7B61FF";
    
          try {
            const res = await fetch("/process_job_with_ai_bulk/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                title: job.title,
                link: job.link,
                snippet: job.snippet,
                country,
                job_type: jobType,
                industry
              })
            });
    
            const data = await res.json();
    
            if (data.success) {
              statusEl.textContent = `âœ… Added: ${data.company}`;
              statusEl.style.color = "#4CAF50";
            } else {
              statusEl.textContent = "âŒ Failed";
              statusEl.style.color = "#ff2f5a";
            }
          } catch (err) {
            console.error("âŒ Error on job", i + 1, err);
            statusEl.textContent = "âŒ Error";
            statusEl.style.color = "#ff2f5a";
          }
    
          await new Promise(r => setTimeout(r, 2000));
        }
    
        addBtn.textContent = "âœ… Done";
        addBtn.disabled = false;
      });
    });
    </script>
    
</body>
</html>
