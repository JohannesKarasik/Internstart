{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listings Insights</title>

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b0d12;
      --surface: #0f1320;
      --card: #111629;
      --muted: #8b93a7;
      --text: #e6e9f2;
      --text-weak:#b8bfd2;
      --brand: #7c5cff;         /* primary */
      --brand-2:#00e0a4;        /* accent */
      --ring: rgba(124,92,255,.35);
      --ok:#28c76f; --warn:#ff9f43; --err:#ff5b5b;
      --border: #1e2438;
      --chip:#141a2e;
      --chip-text:#c6ccdd;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      --radius: 14px;
      --radius-sm: 10px;
      --grid: rgba(255,255,255,.06);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#ffffff; --card:#ffffff;
      --text:#111827; --text-weak:#4b5563; --muted:#6b7280;
      --border:#e8eaf2; --chip:#f2f3f8; --chip-text:#374151;
      --shadow: 0 8px 24px rgba(16,24,40,.08);
      --grid: rgba(0,0,0,.06);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(1200px 800px at -10% 10%, rgba(0,224,164,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.4;
    }

    .container{max-width:1260px;margin:32px auto;padding:0 20px}
    header.hero{
      position:relative;
      padding:26px 24px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--surface);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:18px; justify-content:space-between; flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap:14px;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--brand));
      box-shadow: 0 6px 18px rgba(124,92,255,.35);
    }
    h1{font-size: clamp(20px, 2.2vw, 26px); margin:0; font-weight:700; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:14px; margin-top:4px}

    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--border); color:var(--text);
      background:var(--card); padding:10px 12px; border-radius:10px;
      font-weight:600; font-size:14px; display:inline-flex; align-items:center; gap:8px;
      cursor:pointer; transition:.2s transform, .2s box-shadow, .2s border-color;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.08); border-color:var(--ring)}
    .btn.primary{background:linear-gradient(180deg, rgba(124,92,255,.15), rgba(124,92,255,.05)), var(--card); border-color:var(--ring)}
    .btn .dot{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .seg{display:flex; background:var(--chip); border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .seg button{background:none; border:none; color:var(--chip-text); padding:8px 12px; font-weight:600; cursor:pointer}
    .seg button.active{background:var(--brand); color:white}

    /* sticky toolbar */
    .toolbar{
      position:sticky; top:10px; z-index:50; margin-top:18px; padding:12px;
      background: var(--surface); border:1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:grid; grid-template-columns: 1.2fr repeat(4, 1fr) auto; gap:10px; align-items:center;
    }
    .field{
      display:flex; align-items:center; gap:8px; background:var(--chip); border:1px solid var(--border);
      padding:8px 10px; border-radius:10px;
    }
    .field input, .field select{
      width:100%; background:transparent; border:none; color:var(--text); outline:none; font-size:14px;
    }
    .switch{display:inline-flex; align-items:center; gap:8px; color:var(--text-weak); font-size:13px}
    .switch input{appearance:none; width:38px; height:22px; background:#cbd5e1; border-radius:999px; position:relative; outline:none; cursor:pointer}
    .switch input:checked{background:var(--brand)}
    .switch input::after{content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; background:white; border-radius:50%; transition:.2s}
    .switch input:checked::after{transform:translateX(16px)}

    /* KPI badges */
    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:14px}
    .kpi{
      background:var(--surface); border:1px solid var(--border); border-radius: var(--radius-sm);
      padding:16px; box-shadow: var(--shadow);
    }
    .kpi h4{margin:0; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em}
    .kpi .val{margin-top:8px; font-weight:700; font-size:24px}
    .kpi .delta{margin-top:6px; font-size:12px; color:var(--muted)}
    .kpi .delta.positive{color:var(--ok)} .kpi .delta.negative{color:var(--err)}

    /* Chart Card */
    .card{
      margin-top:18px; background:var(--surface); border:1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding:16px 16px 6px;
    }
    .card h3{margin:6px 6px 12px; font-size:16px}
    .card .hint{color:var(--muted); font-size:12px; margin:0 6px 12px}
    .chart-block{padding:10px 8px 22px; border-top:1px dashed var(--border); margin-top:12px}
    .chart-wrap{position:relative; height:520px}
    canvas{width:100% !important; height:100% !important}

    /* Empty & skeleton states */
    .empty{
      text-align:center; color:var(--muted); padding:40px 10px;
      border:1px dashed var(--border); border-radius:12px; background:var(--chip)
    }
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.12), rgba(255,255,255,0));
      background-size:200% 100%; animation:shimmer 1.1s infinite; border-radius:10px; height:14px}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}

    /* Responsive */
    @media (max-width: 980px){
      .toolbar{grid-template-columns:1fr 1fr; row-gap:8px}
      .kpis{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 560px){
      .kpis{grid-template-columns: 1fr}
      .chart-wrap{height:460px}
    }

    /* Tooltips for help icons */
    .help{position:relative; display:inline-flex; align-items:center; gap:6px; color:var(--muted)}
    .help .tt{position:absolute; top:120%; left:0; display:none; background:var(--card); color:var(--text);
      border:1px solid var(--border); padding:8px 10px; border-radius:8px; font-size:12px; width:max-content; max-width:260px}
    .help:hover .tt{display:block}
  </style>
</head>

<body>
  <div class="container">
    <header class="hero" aria-label="Insights Header">
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Listings Insights</h1>
          <div class="subtitle">Explore performance by Country ¬∑ Industry ¬∑ Job Type</div>
        </div>
      </div>
      <div class="actions">
        <div class="seg" role="tablist" aria-label="Theme">
          <button id="lightBtn" class="active" role="tab" aria-selected="true">‚òÄÔ∏è Light</button>
          <button id="darkBtn" role="tab" aria-selected="false">üåô Dark</button>
        </div>
        <button id="pngBtn" class="btn" aria-label="Download chart as PNG">‚¨áÔ∏è PNG</button>
        <button id="csvBtn" class="btn" aria-label="Download data as CSV">‚¨áÔ∏è CSV</button>
        <button id="resetBtn" class="btn">‚Ü∫ Reset</button>
        <button id="liveBtn" class="btn primary"><span class="dot" aria-hidden="true"></span>Live</button>
      </div>
    </header>

    <!-- KPI row -->
    <section class="kpis" aria-label="Key Performance Indicators">
      <div class="kpi">
        <h4>Total Listings</h4>
        <div class="val" id="kpiTotal">‚Äî</div>
        <div class="delta positive">Updated now</div>
      </div>
      <div class="kpi">
        <h4>Countries</h4>
        <div class="val" id="kpiCountries">‚Äî</div>
        <div class="delta">Unique ISO codes</div>
      </div>
      <div class="kpi">
        <h4>Industries</h4>
        <div class="val" id="kpiIndustries">‚Äî</div>
        <div class="delta">Active only</div>
      </div>
      <div class="kpi">
        <h4>Job Types</h4>
        <div class="val" id="kpiJobTypes">‚Äî</div>
        <div class="delta">Active only</div>
      </div>
    </section>

    <!-- Sticky toolbar -->
    <nav class="toolbar" aria-label="Filters & Controls">
      <label class="field" aria-label="Search">
        üîé
        <input id="q" type="search" placeholder="Search country, industry or job type‚Ä¶" autocomplete="off" />
      </label>
      <label class="field">
        üåç
        <select id="country">
          <option value="">All countries</option>
        </select>
      </label>
      <label class="field">
        üè≠
        <select id="industry">
          <option value="">All industries</option>
        </select>
      </label>
      <label class="field">
        üíº
        <select id="jobtype">
          <option value="">All job types</option>
        </select>
      </label>
      <label class="field">
        üìè
        <select id="chunkSize">
          <option value="25">25 per group</option>
          <option value="35" selected>35 per group</option>
          <option value="50">50 per group</option>
        </select>
      </label>
      <label class="switch">
        <input id="showZero" type="checkbox" checked />
        Show zeroes
      </label>
    </nav>

    <!-- Chart card -->
    <section class="card" aria-label="Charts">
      <h3>Combinations Overview</h3>
      <p class="hint">
        Horizontal bars improve label legibility. Sorts automatically by volume. 
        <span class="help">‚ÑπÔ∏è <span class="tt">Each bar = Country √ó Industry √ó Job Type combination. Colors are stable per combination.</span></span>
      </p>

      <div id="chartWrapper">
        <div class="chart-block">
          <div class="chart-wrap"><div class="skeleton" style="height:100%"></div></div>
        </div>
      </div>

      <div class="chart-block" style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
        <span class="help">üîÑ <span class="tt">Navigate groups when there are many categories.</span></span>
        <button id="prev" class="btn" aria-label="Previous group">‚Üê Prev</button>
        <div class="btn" id="pager" aria-live="polite">Group 1 / 1</div>
        <button id="next" class="btn" aria-label="Next group">Next ‚Üí</button>
      </div>
    </section>
  </div>


  

  <!-- JSON data safely embedded -->
<script id="combo-data" type="application/json">
    {{ combo_data|safe }}
  </script>
  
  <script>
    /* --------- Load + Validate Data --------- */
    let rawData = [];
    try {
      rawData = JSON.parse(document.getElementById("combo-data").textContent.trim());
      console.log("‚úÖ Loaded", rawData.length, "records");
    } catch (e) {
      console.error("‚ùå Failed to parse combo_data JSON:", e);
    }
  
    /* --------- Utilities --------- */
    const labelOrUnknown = (v) => (v && String(v).trim() !== "" ? v : "Unknown");
    const flagMap = { DK:"üá©üá∞", US:"üá∫üá∏", UK:"üá¨üáß", GB:"üá¨üáß", DE:"üá©üá™", GER:"üá©üá™", FR:"üá´üá∑", FRA:"üá´üá∑", SE:"üá∏üá™", NO:"üá≥üá¥", NL:"üá≥üá±", ES:"üá™üá∏", IT:"üáÆüáπ", Unknown:"‚ùì" };
    const flag = (c) => flagMap[c] || "‚ùì";
    const fmt = (n) => new Intl.NumberFormat().format(n);
  
    // Stable HSL color generator
    function hashStr(s) {
      let h = 0;
      for (let i = 0; i < s.length; i++) {
        h = (h << 5) - h + s.charCodeAt(i);
        h |= 0;
      }
      return Math.abs(h);
    }
    function colorFor(key, alpha = 0.9) {
      const h = hashStr(key) % 360;
      return `hsla(${h}, 68%, 56%, ${alpha})`;
    }
  
    // Helpers
    const chunkArray = (arr, size) => {
      const out = [];
      for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
      return out;
    };
    function toCSV(rows, header) {
      const esc = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
      return [header.map(esc).join(","), ...rows.map((r) => r.map(esc).join(","))].join("\n");
    }
  
    /* --------- Theme --------- */
    const root = document.documentElement;
    const setTheme = (mode) => {
      document.documentElement.setAttribute("data-theme", mode);
      document.getElementById("lightBtn").classList.toggle("active", mode === "light");
      document.getElementById("darkBtn").classList.toggle("active", mode === "dark");
      localStorage.setItem("theme", mode);
      if (currentChart) {
        const grid = getComputedStyle(root).getPropertyValue("--grid").trim();
        currentChart.options.scales.x.grid.color = grid;
        currentChart.options.scales.y.grid.color = grid;
        currentChart.update("none");
      }
    };
    const savedTheme =
      localStorage.getItem("theme") ||
      (matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark");
    setTheme(savedTheme);
    document.getElementById("lightBtn").onclick = () => setTheme("light");
    document.getElementById("darkBtn").onclick = () => setTheme("dark");
  
    /* --------- Filters + KPIs --------- */
    const countries = [...new Set(rawData.map((d) => labelOrUnknown(d.country)))].sort();
    const industries = [...new Set(rawData.map((d) => labelOrUnknown(d.industry)))].sort();
    const jobtypes = [...new Set(rawData.map((d) => labelOrUnknown(d.job_type)))].sort();
  
    function fillSelect(sel, arr) {
      const el = document.getElementById(sel);
      arr.forEach((v) => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        el.appendChild(o);
      });
    }
    fillSelect("country", countries);
    fillSelect("industry", industries);
    fillSelect("jobtype", jobtypes);
  
    document.getElementById("kpiTotal").textContent = fmt(
      rawData.reduce((a, b) => a + (+b.total || 0), 0)
    );
    document.getElementById("kpiCountries").textContent = countries.length;
    document.getElementById("kpiIndustries").textContent = industries.length;
    document.getElementById("kpiJobTypes").textContent = jobtypes.length;
  
    /* --------- Filtering + State --------- */
    const state = {
      q: "",
      country: "",
      industry: "",
      jobtype: "",
      showZero: true,
      chunkSize: 35,
      page: 0,
    };
    const $ = (id) => document.getElementById(id);
  
    $("q").addEventListener("input", (e) => {
      state.q = e.target.value.toLowerCase();
      state.page = 0;
      render();
    });
    $("country").addEventListener("change", (e) => {
      state.country = e.target.value;
      state.page = 0;
      render();
    });
    $("industry").addEventListener("change", (e) => {
      state.industry = e.target.value;
      state.page = 0;
      render();
    });
    $("jobtype").addEventListener("change", (e) => {
      state.jobtype = e.target.value;
      state.page = 0;
      render();
    });
    $("showZero").addEventListener("change", (e) => {
      state.showZero = e.target.checked;
      state.page = 0;
      render();
    });
    $("chunkSize").addEventListener("change", (e) => {
      state.chunkSize = +e.target.value;
      state.page = 0;
      render();
    });
    $("resetBtn").onclick = () => {
      $("q").value = "";
      $("country").value = "";
      $("industry").value = "";
      $("jobtype").value = "";
      $("showZero").checked = true;
      $("chunkSize").value = "35";
      state.q = "";
      state.country = "";
      state.industry = "";
      state.jobtype = "";
      state.showZero = true;
      state.chunkSize = 35;
      state.page = 0;
      render();
    };
  
    /* --------- Chart Rendering --------- */
    let currentChart = null;
    const wrapper = document.getElementById("chartWrapper");
  
    function filterAndSort() {
      let rows = rawData.map((d) => ({
        country: labelOrUnknown(d.country),
        industry: labelOrUnknown(d.industry),
        job_type: labelOrUnknown(d.job_type),
        total: +d.total || 0,
      }));
  
      if (!state.showZero) rows = rows.filter((r) => r.total > 0);
      if (state.country) rows = rows.filter((r) => r.country === state.country);
      if (state.industry) rows = rows.filter((r) => r.industry === state.industry);
      if (state.jobtype) rows = rows.filter((r) => r.job_type === state.jobtype);
      if (state.q) {
        rows = rows.filter((r) =>
          (r.country + r.industry + r.job_type).toLowerCase().includes(state.q)
        );
      }
  
      rows.sort(
        (a, b) =>
          b.total - a.total ||
          (a.country + a.industry + a.job_type).localeCompare(
            b.country + b.industry + b.job_type
          )
      );
      return rows;
    }
  
    function makeChartData(chunk) {
      const labels = chunk.map(
        (d) => `${flag(d.country)} ${d.country} ‚Äî ${d.industry} ¬∑ ${d.job_type}`
      );
      const data = chunk.map((d) => d.total);
      const colors = chunk.map((d) =>
        colorFor(`${d.country}|${d.industry}|${d.job_type}`, 0.88)
      );
      return { labels, data, colors };
    }
  
    function draw(chunk, groupIndex, totalGroups) {
      wrapper.innerHTML = "";
      const block = document.createElement("div");
      block.className = "chart-block";
      const chartArea = document.createElement("div");
      chartArea.className = "chart-wrap";
      const canvas = document.createElement("canvas");
      chartArea.appendChild(canvas);
      block.appendChild(chartArea);
      wrapper.appendChild(block);
  
      const { labels, data, colors } = makeChartData(chunk);
  
      if (currentChart) {
        try {
          currentChart.destroy();
        } catch (e) {}
      }
  
      currentChart = new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Listings",
              data,
              backgroundColor: colors,
              borderRadius: 8,
              borderSkipped: false,
              barThickness: "flex",
              maxBarThickness: 36,
            },
          ],
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: 8 },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                color: getComputedStyle(root).getPropertyValue("--text-weak").trim(),
              },
              grid: { color: getComputedStyle(root).getPropertyValue("--grid").trim() },
            },
            y: {
              ticks: {
                color: getComputedStyle(root).getPropertyValue("--text").trim(),
                font: { size: 12 },
                callback: (v, idx) => {
                  const full = labels[idx] || "";
                  return full.length > 56 ? full.slice(0, 54) + "‚Ä¶" : full;
                },
              },
              grid: { display: false },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => items[0]?.label || "",
                label: (ctx) => `Listings: ${fmt(ctx.parsed.x)}`,
              },
            },
            datalabels: {
              color: getComputedStyle(root).getPropertyValue("--text").trim(),
              anchor: "end",
              align: "right",
              offset: 6,
              formatter: (v) => (v > 0 ? fmt(v) : ""),
              font: { weight: 700, size: 12 },
              clip: true,
            },
          },
        },
        plugins: [ChartDataLabels],
      });
  
      const pager = document.getElementById("pager");
      pager.textContent = `Group ${groupIndex + 1} / ${totalGroups}`;
      document.getElementById("prev").disabled = groupIndex <= 0;
      document.getElementById("next").disabled = groupIndex >= totalGroups - 1;
    }
  
    function render() {
      const rows = filterAndSort();
      console.log("Rendering", rows.length, "rows");
      const groups = chunkArray(rows, state.chunkSize);
      if (groups.length === 0) {
        wrapper.innerHTML = `<div class="empty">No data for current filters.</div>`;
        document.getElementById("pager").textContent = `Group 0 / 0`;
        return;
      }
      if (state.page >= groups.length) state.page = groups.length - 1;
      draw(groups[state.page], state.page, groups.length);
    }
  
    document.getElementById("prev").onclick = () => {
      state.page = Math.max(0, state.page - 1);
      render();
    };
    document.getElementById("next").onclick = () => {
      const rows = filterAndSort();
      const groups = chunkArray(rows, state.chunkSize);
      state.page = Math.min(groups.length - 1, state.page + 1);
      render();
    };
  
    /* --------- Downloads --------- */
    document.getElementById("pngBtn").onclick = () => {
      if (!currentChart) return;
      const a = document.createElement("a");
      a.href = currentChart.toBase64Image("image/png", 1);
      a.download = `listings-insights-${new Date().toISOString().slice(0, 10)}.png`;
      a.click();
    };
  
    document.getElementById("csvBtn").onclick = () => {
      const rows = filterAndSort().map((d) => [d.country, d.industry, d.job_type, d.total]);
      const csv = toCSV(rows, ["country", "industry", "job_type", "total"]);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `listings-insights-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };
  
    /* --------- Init --------- */
    render();
  </script>
  