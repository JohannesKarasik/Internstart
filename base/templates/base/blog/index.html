{% extends "main.html" %}
{% block content %}
<section class="container" id="blog-catalog" role="main" aria-label="Blog catalog">
  <!-- Filters -->
  <div class="filters" aria-label="Search and sort">
    <div class="searchbox" role="search">
      <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m21 21-4.2-4.2m1.2-4.8a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="q" type="search" placeholder="Search blog posts…" aria-label="Search posts" />
    </div>
    <div class="sort">
      <label for="sort" class="sr-only">Sort</label>
      <select id="sort" class="select" aria-label="Sort posts">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="popular">Most popular</option>
      </select>
    </div>
  </div>

  <!-- Grid -->
  <section class="grid" id="grid" aria-label="Posts grid">
    {% for p in posts %}
    <article class="card" data-title="{{ p.title|lower }}" data-views="{{ p.views|default(0) }}" data-date="{{ p.date }}">
      <div class="thumb" aria-hidden="true">
        {% if p.featured %}<span class="badge">Featured</span>{% endif %}
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 5.5h16a1.5 1.5 0 0 1 1.5 1.5v10a1.5 1.5 0 0 1-1.5 1.5H4A1.5 1.5 0 0 1 2.5 17V7A1.5 1.5 0 0 1 4 5.5Z" stroke="currentColor" stroke-width="2"/>
          <path d="M7 15l3.5-4 3 3 2-2 1.5 3H7Z" fill="currentColor" opacity=".25"/>
          <circle cx="8.5" cy="9" r="1.25" fill="currentColor"/>
        </svg>
      </div>
      <div class="content">
        <h2 class="title"><a href="{{ p.url }}">{{ p.title }}</a></h2>
        <p class="excerpt">{{ p.excerpt }}</p>
        <div class="meta">
          <span data-date>{{ p.date }}</span>
          <span>•</span>
          <span>{{ p.read|default('5 min') }}</span>
          {% if p.views is defined %}
          <span>•</span>
          <span>{{ (p.views/1000)|round(1) }}k views</span>
          {% endif %}
        </div>
        {% if p.tags %}
        <div class="tags">
          {% for t in p.tags %}
          <span class="tag">{{ t }}</span>
          {% endfor %}
        </div>
        {% endif %}
        <a class="more" href="{{ p.url }}" aria-label="Read {{ p.title }}">Read more</a>
      </div>
    </article>
    {% endfor %}
  </section>

  <!-- Pagination (client-side demo) -->
  <nav class="pagination" id="pagination" role="navigation" aria-label="Pagination"></nav>
</section>

<style>
  :root{
    --accent:#FF2F5A; --accent-700:#e0244d; --bg:#fff; --ink:#111318; --ink-2:#3a3f47;
    --muted:#6b7280; --line:#e5e7eb; --card:#fff; --shadow:0 1px 2px rgba(17,19,24,.06),0 6px 20px rgba(17,19,24,.06);
    --radius:14px; --radius-sm:10px;
  }
  .container{max-width:1200px;margin-inline:auto;padding:28px 20px}

  /* Filters */
  .filters{display:grid;gap:14px;margin:12px 0 22px;grid-template-columns:1fr}
  .searchbox{
    display:flex;align-items:center;gap:10px;border:1.5px solid var(--line);background:#fff;border-radius:999px;
    padding:8px 12px;transition:border-color .15s ease, box-shadow .15s ease;
  }
  .searchbox:focus-within{border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,47,90,.12)}
  .searchbox input{border:0;outline:0;flex:1;font-size:15px;background:transparent;color:var(--ink)}
  .sort{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  .select{border:1.5px solid var(--line);border-radius:12px;padding:8px 12px;background:#fff;color:var(--ink-2);font-weight:600}

  /* Grid & cards */
  .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;
    box-shadow:var(--shadow);transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;min-height:100%;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 2px 10px rgba(17,19,24,.08),0 10px 30px rgba(17,19,24,.08)}
  .thumb{
    aspect-ratio:16/9;background:
      radial-gradient(1200px 500px at 0% 0%, rgba(255,47,90,.08), transparent 60%),
      linear-gradient(135deg,#fff 0%,#fff 20%,#ffe6eb 20%,#ffe6eb 100%);
    display:grid;place-items:center;position:relative;
  }
  .thumb svg{width:48px;height:48px;opacity:.8;color:var(--accent)}
  .badge{position:absolute;top:10px;left:10px;background:#fff;color:var(--accent);border:1px solid rgba(255,47,90,.35);
    padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
  .content{padding:16px;display:flex;flex-direction:column;gap:10px}
  .title{font-size:clamp(18px,1.3vw + 14px,20px);line-height:1.3;font-weight:800;letter-spacing:.2px}
  .excerpt{color:var(--ink-2)}
  .meta{display:flex;gap:12px;color:var(--muted);font-size:13px;flex-wrap:wrap}
  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
  .tag{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,47,90,.08);color:var(--accent);border:1px solid rgba(255,47,90,.25);font-weight:700}
  .card a.more{margin-top:10px;align-self:flex-start;color:var(--accent);font-weight:800;border-bottom:2px solid rgba(255,47,90,.25);padding-bottom:2px}
  .card a.more:focus{outline:none;box-shadow:0 0 0 4px rgba(255,47,90,.15);border-radius:6px}

  /* Pagination */
  .pagination{display:flex;justify-content:center;gap:8px;margin:26px 0 10px;flex-wrap:wrap}
  .page{border:1.5px solid var(--line);background:#fff;border-radius:10px;min-width:36px;height:36px;display:grid;place-items:center;font-weight:700;color:var(--ink-2);cursor:pointer}
  .page[aria-current="page"]{border-color:rgba(255,47,90,.35);background:rgba(255,47,90,.08);color:var(--accent)}
  .page:hover{border-color:var(--accent)}

  @media (min-width: 900px){ .filters{grid-template-columns:minmax(0,1fr) auto} }
  @media (prefers-reduced-motion: reduce){ *{transition:none !important} }
  :focus-visible{outline:3px solid rgba(255,47,90,.35);outline-offset:2px;border-radius:6px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>

<script>
  // Client-side search/sort + simple pagination over server-sent list
  const PAGE_SIZE = 9;

  const $grid = document.getElementById('grid');
  const $q = document.getElementById('q');
  const $sort = document.getElementById('sort');
  const $pagination = document.getElementById('pagination');

  // Extract posts from DOM to keep template simple
  const POSTS = [...$grid.querySelectorAll('.card')].map(card => ({
    el: card,
    title: card.dataset.title || '',
    date: card.dataset.date || '',
    views: Number(card.dataset.views || 0)
  }));

  let state = { q:'', sort:'newest', page:1 };

  function parseDateISO(iso){ return iso ? new Date(iso) : new Date(0); }

  function applyFilters(){
    let rows = POSTS.slice();

    const q = state.q.trim().toLowerCase();
    if(q){
      rows = rows.filter(p => p.title.includes(q) || p.el.querySelector('.excerpt')?.textContent.toLowerCase().includes(q));
    }

    if(state.sort === 'newest') rows.sort((a,b)=> parseDateISO(b.date)-parseDateISO(a.date));
    if(state.sort === 'oldest') rows.sort((a,b)=> parseDateISO(a.date)-parseDateISO(b.date));
    if(state.sort === 'popular') rows.sort((a,b)=> b.views-a.views);

    return rows;
    }

  function render(){
    const rows = applyFilters();
    const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
    state.page = Math.min(state.page, totalPages);

    // Clear grid
    $grid.innerHTML = '';

    const start = (state.page - 1) * PAGE_SIZE;
    const visible = rows.slice(start, start + PAGE_SIZE);

    if(visible.length === 0){
      $grid.innerHTML = `<p role="status">No posts match your search.</p>`;
    } else {
      visible.forEach(p => $grid.appendChild(p.el));
    }

    // Pagination buttons
    let pages = '';
    for(let i=1;i<=totalPages;i++){
      pages += `<button class="page" ${i===state.page?'aria-current="page"':''} data-page="${i}" aria-label="Go to page ${i}">${i}</button>`;
    }
    $pagination.innerHTML = pages;
  }

  $q.addEventListener('input', e => { state.q = e.target.value; state.page=1; render(); });
  $sort.addEventListener('change', e => { state.sort = e.target.value; render(); });
  $pagination.addEventListener('click', e=>{
    const btn = e.target.closest('.page'); if(!btn) return;
    state.page = +btn.dataset.page; render();
    $grid.setAttribute('tabindex','-1'); $grid.focus({preventScroll:false});
  });

  // Format any plain ISO date text nodes into locale format
  document.querySelectorAll('[data-date]').forEach(node=>{
    const iso = node.textContent.trim();
    const d = iso ? new Date(iso) : null;
    if(d && !isNaN(+d)) node.textContent = d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
  });

  render();
</script>
{% endblock %}
