{% extends 'main.html' %}
{% load static %}

{% block content %}
<style>
  :root {
    --accent: #FF2F5A;
    --accent-600: #ff3f67;
    --accent-700: #ff5176;
    --bg-0: #ffffff;
    --bg-1: #f9fafb;
    --text-0: #0f172a; /* slate-900 */
    --text-1: #475569; /* slate-600 */
    --muted: #e5e7eb;  /* gray-200 */
  }

  /* ---------- Reset (scoped) ---------- */
  .ai-wait * { box-sizing: border-box; }
  .ai-wait { font-family: 'Manrope', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: var(--text-0); }

  /* ---------- Fullscreen Overlay ---------- */
  .ai-wait__overlay {
    position: fixed;
    inset: 0;
    background:
      radial-gradient(1200px 800px at 80% -10%, rgba(255,47,90,0.10), transparent 60%),
      radial-gradient(900px 700px at -10% 100%, rgba(255,47,90,0.08), transparent 60%),
      linear-gradient(135deg, var(--bg-0), var(--bg-1));
    display: grid;
    place-items: center;
    z-index: 9999;
    padding: clamp(16px, 3vw, 40px);
  }

  /* Subtle animated grid pattern */
  .ai-wait__overlay::before {
    content: "";
    position: absolute; inset: 0;
    background:
      linear-gradient(90deg, rgba(2,6,23,0.03) 1px, transparent 1px),
      linear-gradient(0deg, rgba(2,6,23,0.03) 1px, transparent 1px);
    background-size: 22px 22px, 22px 22px;
    mask: radial-gradient(ellipse at center, rgba(0,0,0,0.85), transparent 70%);
    animation: grid-pan 18s linear infinite;
    pointer-events: none;
  }
  @keyframes grid-pan { to { transform: translateX(22px); } }

  /* ---------- Card ---------- */
  .ai-card {
    position: relative;
    width: min(860px, 92vw);
    border-radius: 20px;
    background: color-mix(in oklab, white 92%, var(--bg-1));
    box-shadow:
      0 10px 30px rgba(2,6,23,0.06),
      0 2px 8px rgba(2,6,23,0.04);
    padding: clamp(20px, 4vw, 36px);
    overflow: hidden;
    border: 1px solid rgba(2,6,23,0.06);
  }

  /* Animated accent border */
  .ai-card::before {
    content: "";
    position: absolute; inset: -1px;
    background:
      conic-gradient(from 180deg,
        transparent 0 28%,
        color-mix(in oklab, var(--accent) 70%, white) 28% 40%,
        transparent 40% 68%,
        color-mix(in oklab, var(--accent) 70%, white) 68% 80%,
        transparent 80% 100%);
    filter: blur(6px);
    opacity: .25;
    animation: border-sweep 6s linear infinite;
    pointer-events: none;
  }
  @keyframes border-sweep { to { transform: rotate(360deg); } }

  .ai-card__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: clamp(18px, 3vw, 28px);
    align-items: center;
  }
  @media (min-width: 880px) {
    .ai-card__grid { grid-template-columns: 340px 1fr; }
  }

  /* ---------- Left: Hero + Orbit animation ---------- */
  .ai-hero {
    display: grid;
    place-items: center;
    padding: clamp(10px, 2vw, 18px);
  }

  .ai-orbit {
    position: relative;
    width: min(260px, 52vw);
    aspect-ratio: 1;
    border-radius: 50%;
    background:
      radial-gradient(circle at 50% 50%, rgba(255,47,90,0.10), transparent 55%),
      conic-gradient(from 0deg, rgba(255,47,90,0.25), rgba(255,47,90,0.05), rgba(255,47,90,0.25));
    box-shadow:
      inset 0 0 30px rgba(255,47,90,0.15),
      0 10px 30px rgba(2,6,23,0.08);
    display: grid;
    place-items: center;
    isolation: isolate;
  }
  /* inner core */
  .ai-orbit__core {
    width: 36%;
    aspect-ratio: 1;
    border-radius: 50%;
    background:
      radial-gradient(circle at 30% 30%, #fff, #ffe5ea 70%),
      radial-gradient(circle at 70% 70%, rgba(255,47,90,0.35), rgba(255,47,90,0.0) 60%);
    border: 1px solid rgba(255,47,90,0.35);
    box-shadow: 0 6px 20px rgba(255,47,90,0.22);
  }
  /* ring */
  .ai-orbit__ring {
    position: absolute; inset: 10%;
    border-radius: 50%;
    border: 1px dashed rgba(255,47,90,0.35);
    animation: ring-spin 12s linear infinite;
  }
  @keyframes ring-spin { to { transform: rotate(360deg); } }

  /* orbiting dots */
  .ai-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 6px rgba(255,47,90,0.10); }
  .ai-dot--1 { animation: orbit-1 6s linear infinite; }
  .ai-dot--2 { animation: orbit-2 8s linear infinite reverse; background: var(--accent-700); }
  .ai-dot--3 { animation: orbit-3 10s linear infinite; background: var(--accent-600); }
  @keyframes orbit-1 { to { transform: rotate(360deg); } }
  @keyframes orbit-2 { to { transform: rotate(360deg); } }
  @keyframes orbit-3 { to { transform: rotate(360deg); } }
  /* place dots using translate on a rotated container */
  .ai-dot > span { display:block; width:10px; height:10px; border-radius:50%; }
  .ai-dot--1 { transform-origin: 50% 50%; }
  .ai-dot--1 > span { transform: translate(0, -120px); }
  .ai-dot--2 > span { transform: translate(100px, 0); }
  .ai-dot--3 > span { transform: translate(-70px, 60px); }

  /* ---------- Right: Copy + Progress ---------- */
  .ai-copy h1 {
    font-size: clamp(26px, 4.4vw, 42px);
    line-height: 1.1;
    font-weight: 800;
    margin: 0 0 10px;
    letter-spacing: -0.02em;
  }
  .ai-copy h1 .accent { color: var(--accent); }

  .ai-copy p {
    color: var(--text-1);
    font-size: clamp(15px, 1.6vw, 18px);
    line-height: 1.6;
    margin: 0 0 18px;
  }

  .ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    background: #fff;
    border: 1px solid rgba(2,6,23,0.06);
    box-shadow: 0 3px 10px rgba(2,6,23,0.06);
    color: var(--text-1);
    font-weight: 600;
    margin-bottom: 8px;
  }
  .ai-badge__dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 0 6px rgba(255,47,90,0.10);
    animation: pulse 1.8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 6px rgba(255,47,90,0.10); }
    50% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(255,47,90,0.16); }
  }

  /* Progress */
  .ai-progress {
    margin-top: 14px;
    background: #fff;
    border: 1px solid var(--muted);
    border-radius: 999px;
    height: 12px;
    overflow: hidden;
    position: relative;
  }
  .ai-progress__bar {
    --w: 12%;
    width: var(--w);
    height: 100%;
    background:
      linear-gradient(90deg, var(--accent), var(--accent-600)),
      repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.35) 0 8px,
        rgba(255,255,255,0.15) 8px 16px
      );
    background-blend-mode: overlay;
    box-shadow: inset 0 0 8px rgba(255, 255, 255, .35);
    transition: width .6s cubic-bezier(.22,1,.36,1);
  }

  .ai-steps {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .ai-step {
    padding: 6px 10px;
    border-radius: 8px;
    background: linear-gradient(180deg, #fff, #fafafa);
    border: 1px solid rgba(2,6,23,0.06);
    color: var(--text-1);
    font-size: 12px;
    font-weight: 600;
    opacity: .65;
    transition: opacity .3s ease;
  }
  .ai-step.is-active { opacity: 1; border-color: rgba(255,47,90,0.45); color: var(--text-0); }

  /* Rotating status lines */
  .ai-status {
    position: relative;
    height: 22px;
    overflow: hidden;
    margin-top: 10px;
    color: var(--text-1);
    font-size: 14px;
  }
  .ai-status__inner {
    display: grid;
    gap: 0;
    animation: slide-status 8s ease-in-out infinite;
  }
  @keyframes slide-status {
    0%, 20%   { transform: translateY(0%); }
    25%, 45%  { transform: translateY(-100%); }
    50%, 70%  { transform: translateY(-200%); }
    75%, 95%  { transform: translateY(-300%); }
    100%      { transform: translateY(0%); }
  }

  /* Button (optional, non-interactive here) */
  .ai-ghost {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-top: 16px;
    padding: 10px 14px;
    border-radius: 10px;
    background: #fff;
    border: 1px solid rgba(2,6,23,0.08);
    color: var(--text-0);
    text-decoration: none;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(2,6,23,0.05);
  }
  .ai-ghost .dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
  }

  /* Accessibility: respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .ai-wait__overlay::before,
    .ai-card::before,
    .ai-orbit__ring,
    .ai-dot--1, .ai-dot--2, .ai-dot--3,
    .ai-status__inner,
    .ai-badge__dot { animation: none !important; }
  }
</style>

{% if not user.ready %}
<div class="ai-wait">
  <div class="ai-wait__overlay" role="status" aria-live="polite">
    <div class="ai-card">
      <div class="ai-card__grid">
        <!-- Left: Animation -->
        <div class="ai-hero">
          <div class="ai-orbit">
            <div class="ai-orbit__ring"></div>
            <div class="ai-orbit__core" aria-hidden="true"></div>
            <div class="ai-dot ai-dot--1"><span></span></div>
            <div class="ai-dot ai-dot--2"><span></span></div>
            <div class="ai-dot ai-dot--3"><span></span></div>
          </div>
        </div>

        <!-- Right: Copy -->
        <div class="ai-copy">
          <div class="ai-badge">
            <span class="ai-badge__dot" aria-hidden="true"></span>
            <span>AI matching in progress</span>
          </div>

          <h1>
            Gathering <span class="accent">{{ user.desired_job_title|default:"new"|lower }}</span> roles tailored to your resume
          </h1>
          <p>
            We‚Äôre scanning fresh openings, ranking them by fit, and preparing one-click applications.
            This can take a while depending on volume.
          </p>

          <!-- Rotating micro-status -->
          <div class="ai-status" aria-hidden="true">
            <div class="ai-status__inner">
              <div>üîé Crawling sources & company boards</div>
              <div>üß† Vector-matching with your experience</div>
              <div>‚öñÔ∏è Scoring relevance & salary signals</div>
              <div>üì¨ Packaging one-click apply actions</div>
            </div>
          </div>

          <!-- Progress -->
          <div class="ai-progress" aria-label="Loading progress">
            <div class="ai-progress__bar" id="aiProgressBar"></div>
          </div>

          <!-- Steps -->
          <div class="ai-steps" id="aiSteps">
            <span class="ai-step is-active">Crawl</span>
            <span class="ai-step">Match</span>
            <span class="ai-step">Rank</span>
            <span class="ai-step">Prepare</span>
          </div>

          <!-- Optional informative chip -->
          <a class="ai-ghost" aria-disabled="true">
            <span class="dot" aria-hidden="true"></span>
            You‚Äôll be notified when it‚Äôs ready
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Lightweight, self-contained progress simulation + step highlighting.
  (function () {
    const bar = document.getElementById('aiProgressBar');
    const steps = Array.from(document.getElementById('aiSteps').children);
    if (!bar || !steps.length) return;

    let pct = 8; // start width
    let stepIndex = 0;

    const update = () => {
      // Ease towards 92% max (to avoid hitting 100% before backend is ready)
      const target = Math.min(92, pct + (Math.random() * 6 + 2));
      pct = target;
      bar.style.setProperty('--w', target.toFixed(1) + '%');

      // Step activation thresholds
      const thresholds = [0, 28, 56, 80];
      const idx = thresholds.filter(t => pct >= t).length - 1;
      if (idx !== stepIndex) {
        steps.forEach((s, i) => s.classList.toggle('is-active', i === idx));
        stepIndex = idx;
      }
    };

    const timer = setInterval(update, 1500);

    // In case the backend flips `user.ready` and the overlay disappears,
    // this script will be GC'ed naturally. If the page stays long, cap at 92%.
    setTimeout(() => clearInterval(timer), 180000);
  })();
</script>

{% else %}
  <!-- Normal interface -->
  {% include 'base/swipe_page.html' %}
{% endif %}
{% endblock %}
