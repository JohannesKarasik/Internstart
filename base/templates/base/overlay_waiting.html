{% extends 'main.html' %}
{% load static %}

{% block content %}
<style>
  :root{
    /* Light-first palette (modern SaaS) */
    --bg: #FBFCFE;                      /* page background */
    --card: rgba(255,255,255,0.9);      /* frosted card */
    --border: #E6E8EE;                  /* subtle stroke */
    --text: #101828;                    /* high-contrast body */
    --muted: #667085;                   /* secondary text */

    /* Accents */
    --accent: #3B82F6;                  /* primary (blue) */
    --accent-2: #FF2F5A;                /* secondary (requested) */
    --accent-3: #06B6D4;                /* tertiary (teal) */
    --success: #16A34A;                 /* success green */

    --shadow: 0 10px 30px rgba(16,24,40,0.08);
    --radius: 16px;
  }

  @media (prefers-color-scheme: dark) {
    :root{
      /* tasteful dark fallback */
      --bg: #0b0f19;
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --text: #e6e9f2;
      --muted: #a6aec9;
      --shadow: 0 10px 40px rgba(0,0,0,0.35);
      /* keep the same accents for brand consistency */
    }
  }

  /* --- OVERLAY --- */
  .ai-wait {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: grid;
    place-items: center;
    padding: clamp(16px, 3vw, 40px);
    color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Manrope", Arial, sans-serif;

    /* Light, airy aurora with brand tints */
    background:
      radial-gradient(1200px 800px at -10% -20%, rgba(59,130,246,0.16), transparent 60%),
      radial-gradient(900px 700px at 110% 0%, rgba(255,47,90,0.12), transparent 55%),
      radial-gradient(1200px 900px at 10% 120%, rgba(6,182,212,0.12), transparent 55%),
      var(--bg);
    overflow: hidden;
  }

  /* Soft animated highlight ribbons */
  .ai-wait::before,
  .ai-wait::after{
    content:"";
    position:absolute; inset:-15%;
    background: conic-gradient(from 180deg at 50% 50%,
      color-mix(in srgb, var(--accent) 35%, transparent),
      color-mix(in srgb, var(--accent-2) 28%, transparent),
      color-mix(in srgb, var(--accent-3) 24%, transparent),
      transparent 45%);
    filter: blur(80px) saturate(120%);
    animation: swirl 22s linear infinite;
    pointer-events: none;
  }
  .ai-wait::after{ animation-duration: 32s; mix-blend-mode: screen; opacity: .7; }
  @keyframes swirl { to { transform: rotate(360deg); } }

  /* --- CARD --- */
  .wait-card{
    position: relative;
    width: min(820px, 92vw);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background:
      linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.8));
    backdrop-filter: blur(14px) saturate(120%);
    box-shadow: var(--shadow);
    overflow: clip;
  }

  .wait-inner{
    display: grid;
    grid-template-columns: 1fr;
    gap: 22px;
    padding: clamp(20px, 3.5vw, 36px);
  }

  /* Header row */
  .wait-top{
    display:flex; align-items:center; justify-content:space-between; gap:16px;
  }
  .brand{
    display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px;
    color: var(--text);
  }
  .brand .logo{
    width:34px; height:34px; border-radius:10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow: 0 6px 18px rgba(255,47,90,.25);
  }
  .badge{
    font-size:12px; color: var(--muted);
    padding:6px 10px; border:1px dashed var(--border); border-radius:999px;
    background: #FFFFFFCC;
  }

  /* --- AI ORB LOADER --- */
  .ai-orb{
    width: 72px; height: 72px; margin: 6px auto 6px;
    border-radius: 50%;
    position: relative; isolation:isolate;
    background:
      radial-gradient(35% 35% at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0) 60%),
      conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent-3), var(--accent));
    animation: spin 2.8s linear infinite;
    filter: saturate(120%);
    border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent);
  }
  .ai-orb::after{
    content:""; position:absolute; inset:6px; border-radius:inherit;
    background: radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.9), rgba(255,255,255,.06) 70%);
    mix-blend-mode: screen;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* --- TEXT --- */
  .title{
    font-size: clamp(22px, 3.8vw, 34px);
    line-height: 1.15; font-weight: 800; letter-spacing: -0.02em;
    text-align: center; margin: 2px 0 4px; color: var(--text);
  }
  .subtitle{
    color: var(--muted);
    font-size: clamp(14px, 2.2vw, 16px);
    text-align:center; margin: 0 auto; max-width: 600px;
  }

  /* --- PROGRESS --- */
  .progress{
    margin: 18px auto 2px; width: min(520px, 88%); height: 10px;
    background: #F2F4F7;
    border: 1px solid var(--border);
    border-radius: 999px; overflow: hidden; position: relative;
  }
  .progress span{
    display:block; height:100%; width:18%;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    border-radius: inherit;
    animation: fill 2.2s ease-in-out infinite alternate;
  }
  .progress::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.7), transparent);
    transform: translateX(-100%);
    animation: shimmer 2.8s linear infinite;
  }
  @keyframes fill { from{width:16%} to{width:100%} }
  @keyframes shimmer { to { transform: translateX(100%); } }

  .progress-note{
    color: var(--muted); text-align:center; font-size: 13px; margin-top: 6px;
  }

  /* --- STEPS --- */
  .steps{
    display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    width: min(720px, 100%); margin: 14px auto 2px;
  }
  .step{
    display:flex; align-items:center; gap:10px;
    border:1px solid var(--border); border-radius: 12px;
    padding: 10px 12px;
    background: linear-gradient(180deg, #FFFFFF, #FAFBFF);
  }
  .step .dot{
    width:10px; height:10px; border-radius:50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow: 0 0 0 0 rgba(59,130,246,.35); transform: scale(.9);
  }
  .step.active .dot{ animation: ping 1.4s ease-out infinite; }
  .step.done .dot{ background: linear-gradient(135deg, var(--success), #22c55e); box-shadow:none; }
  .step span{ font-size:13px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  @keyframes ping {
    0%{ box-shadow: 0 0 0 0 rgba(59,130,246,.35); transform: scale(1); }
    80%{ box-shadow: 0 0 0 12px rgba(59,130,246,0); transform: scale(1); }
    100%{ box-shadow: 0 0 0 0 rgba(59,130,246,0); }
  }

  /* --- FOOT ROW --- */
  .foot{
    display:flex; align-items:center; justify-content:center; gap:12px; margin-top: 6px;
  }
  .hint{ color: var(--muted); font-size: 13px; }

  .sr-only{ position:absolute !important; clip: rect(1px,1px,1px,1px); padding:0; border:0; height:1px; width:1px; overflow:hidden; }

  /* RESPONSIVE */
  @media (max-width: 720px){
    .steps{ grid-template-columns: 1fr; }
    .foot{ flex-direction: column; align-items: stretch; gap:10px; }
  }

  /* Reduce motion accessibility */
  @media (prefers-reduced-motion: reduce){
    .ai-wait::before, .ai-wait::after, .ai-orb, .progress span, .progress::after, .step.active .dot { animation: none !important; }
  }
</style>

{% if not user.ready %}
  <section class="ai-wait" aria-busy="true" aria-live="polite">
    <div class="wait-card" role="status">
      <div class="wait-inner">

        <div class="wait-top">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>JobGenie<span style="opacity:.55"> ‚Ä¢ AI</span></div>
          </div>
          <div class="badge">Real-time search</div>
        </div>

        <div class="ai-orb" aria-hidden="true"></div>

        <h1 class="title">
          Gathering {{ user.desired_job_title|default:"new"|lower }} jobs that match your resume
          <span aria-hidden="true"> üîç</span>
        </h1>

        <p class="subtitle" id="statusLine" data-rotate='[
          "Scanning top boards and company sites",
          "Ranking roles by skill match and seniority",
          "Removing duplicates and low-quality posts",
          "Preparing one-click apply for you"
        ]'>
          Come back in a couple of hours ‚Äî our AI is gathering hundreds of new opportunities tailored to your background. Soon, you‚Äôll be able to apply to them all with a single click.
        </p>

        <div class="progress" aria-hidden="true"><span></span></div>
        <div class="progress-note" id="progressNote">Working‚Ä¶</div>

        <div class="steps" aria-label="Job gathering progress">
          <div class="step active" id="s1"><div class="dot"></div><span>Scanning sources</span></div>
          <div class="step" id="s2"><div class="dot"></div><span>Matching jobs to your resume</span></div>
          <div class="step" id="s3"><div class="dot"></div><span>Deduplicate & prep</span></div>
        </div>

        <div class="foot">
          <span class="hint">We‚Äôll notify you here when your personalized list is ready.</span>
        </div>

      </div>
    </div>
  </section>
{% else %}
  {# Normal experience when ready #}
  {% include 'base/swipe_page.html' %}
{% endif %}

<script>
  // 1) Rotate sub-status lines
  (function rotateLines(){
    const el = document.getElementById('statusLine');
    if(!el) return;
    try{
      const items = JSON.parse(el.getAttribute('data-rotate') || '[]');
      if(!items.length) return;
      let i = 0;
      setInterval(() => {
        i = (i + 1) % items.length;
        el.textContent = items[i];
      }, 2800);
    }catch(e){}
  })();

  // 2) Fake step progression (visual only; backend controls real "ready" state)
  (function stepper(){
    const s1 = document.getElementById('s1');
    const s2 = document.getElementById('s2');
    const s3 = document.getElementById('s3');
    const note = document.getElementById('progressNote');
    if(!s1 || !s2 || !s3 || !note) return;

    const stages = [
      {el: s1, text: 'Scanning sources‚Ä¶'},
      {el: s2, text: 'Matching to your resume‚Ä¶'},
      {el: s3, text: 'Cleaning & preparing results‚Ä¶'},
    ];
    let idx = 0;

    function tick(){
      stages.forEach((s, i) => {
        s.el.classList.toggle('active', i === idx);
        s.el.classList.toggle('done', i < idx);
      });
      note.textContent = stages[idx].text;
      idx = (idx + 1) % stages.length;
    }
    tick();
    setInterval(tick, 3800);
  })();
</script>
{% endblock %}
