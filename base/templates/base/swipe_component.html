{% load static %}
<link rel="stylesheet" href="{% static 'base/style.css' %}">


{% block content %}
{% if not partial %}


<main
  class="layout"
  data-user-id="{{ request.user.id|default_if_none:'anon' }}"
  data-first-login="{{ first_login|yesno:'true,false' }}"
  data-email-configured="{{ email_configured|yesno:'true,false' }}"
  data-plan="{{ request.user.subscription_tier|default:'free' }}"
  data-plan-label="{{ request.user.get_subscription_tier_display|default:'Free' }}"
  style="
    position: relative;
    height: 100dvh;
    min-height: 100dvh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    /* default: DARK, overridden in .theme-light below */
    background:
      radial-gradient(1100px 520px at 100% -10%, rgba(237,0,60,.10), transparent 60%),
      linear-gradient(135deg, #0b0f1a 0%, #0e162a 40%, #0b0f1a 100%);
    transition: background 1s ease;
    font-family: 'Inter', sans-serif;
    overflow: hidden;
  "
>

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <!-- ===== Collapsible Sidebar ===== -->
  <aside id="sidebar" class="sidebar" aria-label="Primary">
    <div class="sidebar__header">
      <div class="sidebar__brand">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
          <defs>
            <linearGradient id="sbG" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ed003c"/>
              <stop offset="100%" stop-color="#ed003c"/>
            </linearGradient>
          </defs>
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="none" stroke="url(#sbG)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
        </svg>

        <span class="logo-chip">
          <img class="sidebar__brand-img" src="{% static 'images/logolog.png' %}" alt="Internstart" loading="lazy">
        </span>
      </div>

      <button id="sidebarToggle" class="sidebar__toggle" aria-controls="sidebar" aria-expanded="true" aria-label="Toggle sidebar">
        <svg class="chev" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <nav class="sidebar__nav" role="navigation">
      <a class="sbi is-active" href="#" title="Discover">
        <span class="sbi__icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v9a2 2 0 0 1-2 2h-3v-7H8v7H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        <span class="sbi__label">Discover</span>
      </a>

      <a class="sbi" href="#" id="openSaved" title="Saved" style="display: none;">
        <span class="sbi__icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        <span class="sbi__label">Saved</span>
  <span class="sbi__badge" id="savedBadge">{{ request.user.savedjob_set.count|default:0 }}</span>
      </a>

      <a class="sbi" href="#" title="Applied" style="display: none;">
        <span class="sbi__icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        <span class="sbi__label">Applied</span>
      </a>

      <a class="sbi" href="#" title="Messages" style="display: none;">
        <span class="sbi__icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V5a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        <span class="sbi__label">Messages</span>
        <span class="sbi__dot" aria-hidden="true"></span>
      </a>

      <div class="sidebar__sep" role="separator" aria-hidden="true"></div>

<a class="sbi" href="{% url 'update-user' %}" title="Settings">
        <span class="sbi__icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm7.94-3a6.94 6.94 0 0 0-.12-1l2.12-1.65-2-3.46-2.56 1a7.1 7.1 0 0 0-1.7-1L13 2h-2l-.68 2.24a7.1 7.1 0 0 0-1.7 1l-2.56-1-2 3.46L5.5 11a6.94 6.94 0 0 0 0 2l-2.12 1.65 2 3.46 2.56-1a7.1 7.1 0 0 0 1.7 1L11 22h2l.68-2.24a7.1 7.1 0 0 0 1.7-1l2.56 1 2-3.46L19.82 13a6.94 6.94 0 0 0 .12-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        <span class="sbi__label">Settings</span>
      </a>

      <a class="sbi" href="{% url 'app_logout' %}" title="Logout">
        <span class="sbi__icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path d="M10 17l5-5-5-5M15 12H3M21 19V5a2 2 0 0 0-2-2h-7" 
                  fill="none" stroke="currentColor" stroke-width="2" 
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span class="sbi__label">Logout</span>
      </a>
    </nav>

    <div class="sidebar__footer">
      <div class="sidebar__plan">
        <span class="plan-dot" aria-hidden="true"></span>
        <span class="plan-text">{{ request.user.subscription_tier|default:'free'|title }}</span>
      </div>
      <button class="sidebar__upgrade" type="button" id="openPremium">Get more swipes</button>
    </div>
  </aside>
  <div id="sidebarBackdrop" class="sidebar-backdrop" hidden></div>
  <!-- ===== /Sidebar ===== -->

  <!-- ===== Header ===== -->
  <header class="custom-header">
    <div class="header-left">
      <!-- Theme switch -->
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle light mode" aria-pressed="false" title="Toggle light / dark">
        <span class="tt-knob"></span>
        <svg class="tt-sun" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm0 4a1 1 0 0 1-1-1v-1.2a1 1 0 1 1 2 0V21a1 1 0 0 1-1 1Zm0-19a1 1 0 0 1 1 1v1.2a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1Zm10 9a1 1 0 0 1-1 1h-1.2a1 1 0 1 1 0-2H21a1 1 0 0 1 1 1ZM4.2 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h1.2a1 1 0 0 1 1 1Zm13.96 6.04a1 1 0 0 1-1.41 0l-.85-.85a1 1 0 1 1 1.41-1.41l.85.85a1 1 0 0 1 0 1.41ZM8.1 7.22a1 1 0 0 1-1.41 0l-.85-.85A1 1 0 0 1 7.25 4.9l.85.85a1 1 0 0 1 0 1.41Zm9.46-2.9 0 0ZM7.24 18.1a1 1 0 0 1-1.41 0l-.85-.85a1 1 0 1 1 1.41-1.41l.85.85a1 1 0 0 1 0 1.41Zm11.32-11.32a1 1 0 0 1 0-1.41l .85-.85a1 1 0 1 1 1.41 1.41l-.85.85a1 1 0 0 1-1.41 0Z"/></svg>
        <svg class="tt-moon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79Z"/></svg>
      </button>
    </div>

    
    <button class="mobile-premium-btn" id="openPremiumMobile">Get more swipes</button>



<a class="header__account" href="{% url 'update-user' %}" aria-label="Account">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
    <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      d="M20 21a8 8 0 1 0-16 0M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"/>
  </svg>
</a>

  </header>

  <!-- ===== Background FX ===== -->
  <div class="bgFX" aria-hidden="true">
    <div class="bgFX__grid"></div>
    <div class="bgFX__beam b1"></div>
    <div class="bgFX__beam b2"></div>
    <div class="bgFX__orb o1"></div>
    <div class="bgFX__orb o2"></div>
    <div class="bgFX__orb o3"></div>
  </div>

<!-- ===== HUD ===== -->
<div class="hud hud--balanced">
  <div class="hud__left">
    <!-- Streak -->
    <div class="hud__streak">üî• Streak <span id="streakVal">0</span></div>
    <div class="hud__combo" id="comboBadge" aria-live="polite"></div>
  </div>


  <!-- new compact mobile HUD -->
<div class="hud-mobile">
  <div class="hud-mobile__swipes">
    <span id="swipesLeftMobile">{{ swipes_left }}</span> left
  </div>
  <div class="hud-mobile__applied">
    <span id="appliedCountMobile">0</span> applied
  </div>
</div>


  <div class="hud__right" title="Cards remaining / applied">
    <!-- Swipes left -->
    <div class="swipes-widget" id="swipesWidget" aria-live="polite" role="status">
      <div class="swipes-widget__icon" aria-hidden="true">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="swipes-widget__text">
        <span id="swipesLeft">{{ swipes_left }}</span>
        <small>Swipes left / <span id="swipeLimit">‚Äî</span></small>
      </div>
    </div>

    <!-- Applied -->
    <div class="applied-widget" id="appliedWidget" aria-live="polite" role="status">
      <div class="applied-widget__icon" aria-hidden="true">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
          <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="applied-widget__text">
        <span id="appliedCount">0</span>
        <small>Applied</small>
      </div>
    </div>

    <!-- Deck progress -->
    <div class="ring" role="img" aria-label="Deck progress">
      <svg viewBox="0 0 36 36">
        <path class="ring-track" d="M18 2 a16 16 0 0 1 0 32 a16 16 0 0 1 0 -32"/>
        <path class="ring-bar" id="ringBar" d="M18 2 a16 16 0 0 1 0 32 a16 16 0 0 1 0 -32"/>
      </svg>
      <div class="ring__label"><span id="cardsLeft">0</span></div>
    </div>
  </div>
</div>
<!-- ===== /HUD ===== -->





  <!-- Hidden topics -->
  <div class="topics" style="display:none;"></div>

  <!-- Premium upsell modal -->
<!-- Premium upsell modal -->
<!-- Premium upsell modal -->
<!-- Load the font -->
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* Keep borders visible on hover & avoid clipping */
  #noSwipesModal .modal__plans { overflow: visible !important; }
  #noSwipesModal .plan-card { position: relative; z-index: 1; }
  #noSwipesModal .plan-card:hover { z-index: 3; }
</style>

<div id="noSwipesModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__backdrop"></div>
  <!-- Ensure room for 3 cards side-by-side -->
  <div class="modal__dialog" role="document" aria-labelledby="noSwipesTitle"
       style="max-width: 980px; width: min(95vw, 980px);">
    <button class="modal__close" aria-label="Close">&times;</button>
    <div class="modal__content">
      <h2 id="noSwipesTitle">No more swipes</h2>
      <p>You‚Äôve used all your free swipes today. Upgrade to keep swiping üöÄ</p>

      <!-- Plans -->
      <div class="modal__plans"
           style="
             display:flex;
             gap:1rem;
             align-items:stretch;
             justify-content:space-between; /* spread evenly */
             flex-wrap:nowrap;               /* single row */
             margin:1rem 0;
           ">
        <!-- Starter -->
        <div class="plan-card"
             style="border:1px solid var(--border, #2a2f3a); border-radius:12px; padding:1rem;
                    box-sizing:border-box; flex:1 1 0; min-width:0;">
          <h3 style="margin:0 0 .25rem 0;">Starter</h3>
          <div style="font-size:1.25rem; font-weight:700;">99 DKK<span style="font-weight:400; font-size:.95rem;">/mo</span></div>
          <ul style="margin:.75rem 0 1rem 1rem; padding:0; line-height:1.5;">
            <li>10 daily swipes</li>
            <li>Unlimited Skips</li>
          </ul>
          <button class="btn-primary" id="subscribe-starter" aria-label="Subscribe to Starter (99 DKK per month)">Starter ‚Äî 99 DKK/mo</button>
        </div>

        <!-- Pro -->
        <div class="plan-card"
             style="border:1px solid var(--border, #2a2f3a); border-radius:12px; padding:1rem;
                    box-sizing:border-box; flex:1 1 0; min-width:0;">
          <h3 style="margin:0 0 .25rem 0;">Pro</h3>
          <div style="font-size:1.25rem; font-weight:700;">199 DKK<span style="font-weight:400; font-size:.95rem;">/mo</span></div>
          <ul style="margin:.75rem 0 1rem 1rem; padding:0; line-height:1.5;">
            <li>25 daily swipes</li>
            <li>Unlimited Skips</li>
          </ul>
          <button class="btn-primary" id="subscribe-pro" aria-label="Subscribe to Pro (199 DKK per month)">Pro ‚Äî 199 DKK/mo</button>
        </div>

        <!-- Elite -->
        <div class="plan-card"
             style="border:1px solid var(--border, #2a2f3a); border-radius:12px; padding:1rem;
                    box-sizing:border-box; flex:1 1 0; min-width:0;">
          <h3 style="margin:0 0 .25rem 0;">Elite</h3>
          <div style="font-size:1.25rem; font-weight:700;">299 DKK<span style="font-weight:400; font-size:.95rem;">/mo</span></div>
          <ul style="margin:.75rem 0 1rem 1rem; padding:0; line-height:1.5;">
            <li>40 daily swipes</li>
            <li>Unlimited Skips</li>
          </ul>
          <button class="btn-primary" id="subscribe-elite" aria-label="Subscribe to Elite (299 DKK per month)">Elite ‚Äî 299 DKK/mo</button>
        </div>
      </div>
    </div>
  </div>
</div>


<style>
  /* Keep borders visible on hover & avoid clipping */
  #noSwipesModal .modal__plans { overflow: visible !important; }
  #noSwipesModal .plan-card { position: relative; z-index: 1; }
  #noSwipesModal .plan-card:hover { z-index: 3; }

  #noSwipesModal,
  #noSwipesModal h2,
  #noSwipesModal p,
  #noSwipesModal button {
    font-family: 'Manrope', sans-serif !important;
  }

  /* üì± Mobile only: stack plans vertically */
  @media (max-width: 768px) {
    #noSwipesModal .modal__plans {
      flex-direction: column !important;
      justify-content: flex-start !important;
      align-items: stretch !important;
    }
    #noSwipesModal .plan-card {
      width: 100% !important;
      flex: none !important;
    }
  }
</style>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}"); // Django will inject your publishable key

  function startCheckout(tier) {
    fetch(`/billing/checkout/${tier}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: "{}"
    })
    .then(res => res.json())
    .then(data => {
      if (data.id) {
        stripe.redirectToCheckout({ sessionId: data.id });
      } else {
        alert("Error creating checkout session: " + (data.error || "Unknown"));
      }
    })
    .catch(err => console.error("Checkout error:", err));
  }

  // Attach event listeners (IDs kept the same)
  document.getElementById("subscribe-starter").addEventListener("click", () => startCheckout("starter"));
  document.getElementById("subscribe-pro").addEventListener("click", () => startCheckout("pro"));
  document.getElementById("subscribe-elite").addEventListener("click", () => startCheckout("elite"));
</script>


<style>
  #noSwipesModal,
  #noSwipesModal h2,
  #noSwipesModal p,
  #noSwipesModal button {
    font-family: 'Manrope', sans-serif !important;
  }
</style>



<script>

  
  // Add this AFTER your premium modal code has been defined
  (function () {
    const link = document.getElementById('getPremiumLink');
    if (!link) return;

    function csrf() {
      return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    link.addEventListener('click', async (e) => {
      // Prevent navigation to /upgrade/ and use the checkout session POST instead
      e.preventDefault();

      try {
        const res = await fetch('/billing/create-checkout-session/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf()
          },
          // üî¥ IMPORTANT: pass what your server expects
          body: JSON.stringify({
            // replace with your actual Stripe Price ID:
            price_id: 'price_XXXXXXXXXXXX',
            // optional but common:
            mode: 'subscription' // or 'payment'
          }),
          credentials: 'same-origin'
        });

        // If the view returns a plain 400 with no JSON, this will throw.
        let data = {};
        try { data = await res.json(); } catch (_) {}

        if (!res.ok) {
          const msg = data?.error || `Checkout failed (${res.status}).`;
          alert(msg);
          return;
        }

        // Expecting {url: "..."} OR {id: "..."} depending on your view
        if (data.url) {
          window.location.href = data.url; // redirect to Stripe Checkout
        } else if (data.id && window.Stripe) {
          // Alternate flow if you return a sessionId and use Stripe.js
          const stripe = Stripe('pk_live_or_test_xxx'); // your publishable key
          await stripe.redirectToCheckout({ sessionId: data.id });
        } else {
          alert('No redirect URL received from server.');
        }
      } catch (err) {
        console.error(err);
        alert('Network error starting checkout.');
      }
    });
  })();
</script>

<script>
  
  async function checkQuotaFresh() {
  try {
    const r = await fetch('/quota/?t=' + Date.now());
    const d = await r.json();
    const el = document.getElementById('swipesLeft');
    if (el) el.textContent = d.left;
    return (d.left > 0);
  } catch {
    return false;
  }
}


  document.getElementById('openPremium')?.addEventListener('click', () => {
    document.getElementById('premiumModal')?.classList.add('show');
    document.documentElement.style.overflow = 'hidden';
  });
</script>
        </div>





        <!-- ===== Deck / Cards ===== -->
        <div class="swipe-container" id="swipeDeck">

    
        {% for room in rooms %}
        <div class="swipe-card {% cycle 'card-color-pink' 'card-color-blue' 'card-color-yellow' %}"
             data-room-id="{{ room.id }}"
             role="button"
             aria-label="Flip card to see more info"
             tabindex="0"
             style="position:absolute; width:100%; height:100%; cursor:pointer; transform-style:preserve-3d;">
          <div class="card-inner" aria-live="polite">
            <!-- FRONT -->
            <div class="card-front">
              {% if room.logo %}
                <div class="logo-frame">
                  <img src="{{ room.logo.url }}" alt="{{ room.company_name }}" class="company-logo" loading="lazy">
                </div>
              {% else %}
                <div class="logo-frame">
                  <img src="/static/images/fallback-logo.png" alt="{{ room.company_name }}" class="company-logo" loading="lazy">
                </div>
              {% endif %}
    
              <div class="title-block">
                <h4>{{ room.job_title|default:"this position" }}</h4>
                <h3>{{ room.company_name }}</h3>
                <h2>{{ room.role }}</h2>
                <p class="meta"><span class="dot"></span> {{ room.location }}</p>
              </div>
    
              <div class="info-badges">
                <span class="badge badge--hot">üî• Hot</span>
                <span class="badge">Full-time</span>
                <span class="badge badge--brand">In-office</span>
              </div>
    
              <!-- Actions -->
              <div class="card-cta">
                <!-- Skip (X) -->
                <button class="swipe-btn swipe-left" aria-label="Dismiss job (left)" title="Skip">
                  <span class="btn-ripple"></span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"
                       viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"
                       stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
    
                <!-- Send / Apply (‚úì) -->
                <button class="swipe-btn swipe-right" aria-label="Apply to job (right)" title="Apply">
                  <span class="btn-ripple"></span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30"
                       viewBox="0 0 24 24" fill="none" stroke="#ed003c" stroke-width="2"
                       stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </button>
              </div>
    
              <div class="stamp stamp--apply" aria-hidden="true">APPLY</div>
              <div class="stamp stamp--dismiss" aria-hidden="true">SKIP</div>
              
            </div>
    
            <!-- BACK -->
            <div class="card-back">
              <h3>{{ room.company_name }}</h3>
              <h4>{{ room.role }}</h4>
              <p class="location">üìç {{ room.location }}</p>
              <div class="divider"></div>
              <p class="desc">{{ room.description }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
    
          <div id="loadMoreSentinel" style="height:1px;"></div>
        </div>
      

    

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <div id="onboarding-overlay" 
    style="position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; z-index:10000; font-family:'Manrope', sans-serif !important;">

 <div id="onboarding-dialog" role="dialog" aria-modal="true" aria-labelledby="onb-title" aria-describedby="onb-desc" 
      style="position:relative; margin:auto; max-width:380px; width:calc(100% - 32px); background:#0f1525; border-radius:14px; box-shadow:0 20px 50px rgba(0,0,0,0.45); padding:20px; border:1px solid rgba(148,163,184,.15); color:#e6eef8; font-family:'Manrope', sans-serif !important; left:0; right:0;">
      
   <!-- Step info -->
   <div style="font-size:12px; color:#94a3b8; margin-bottom:6px;">Step <span id="onb-step">1</span> of <span id="onb-total">3</span></div>
   
   <!-- Title + desc -->
   <h3 id="onb-title" style="margin:0 0 8px; font-size:19px; color:#fff; font-weight:700;">Welcome!</h3>
   <p id="onb-desc" style="margin:0 0 16px; font-size:14px; color:#cbd5e1;">
     Let‚Äôs get started by connecting your email so applications can be sent directly.
   </p>
   
   <!-- Guide box -->
   <div style="padding:14px 16px; margin-bottom:14px; border-radius:10px; background:linear-gradient(145deg, rgba(45,55,72,.6), rgba(26,32,44,.9)); border:1px solid rgba(99,102,241,.25); font-size:13px; line-height:1.55; color:#e6eaf2; text-align:left;">
     <div style="font-weight:600; color:#f8fafc; margin-bottom:6px; font-size:14px;">We‚Äôre in beta mode ‚Äî if you see a warning:</div>
     <ol style="padding-left:18px; margin:0;">
       <li>Click <strong>Advanced</strong> at the bottom of the warning screen.</li>
       <li>Select <strong>Go to Internstart</strong>.</li>
       <li>Choose your Google account.</li>
       <li>Allow access so your email can connect.</li>
     </ol>
     <p style="margin-top:10px; font-size:12px; color:#94a3b8;">
       This is expected during beta and safe to continue.
     </p>
   </div>

   <!-- Action buttons -->
   <div style="display:flex; gap:8px; justify-content:flex-end;">
     <button id="onb-prev" type="button" style="display:none; padding:6px 10px; font-size:13px; background:#0b1220; color:#e6eef8; border:1px solid rgba(148,163,184,.28); border-radius:6px;">Back</button>
     <button id="onb-next" type="button" style="padding:6px 12px; font-size:13px; background:#1b2337; color:#fff; border:1px solid rgba(148,163,184,.28); border-radius:6px;">Okay</button>
     <a id="onb-primary-link" href="{% url 'start_gmail_auth' %}" 
        style="padding:6px 12px; font-size:13px; background:#ed003c; color:#fff; border-radius:6px; text-decoration:none; font-weight:600;">
        Configure email
     </a>
   </div>
 </div>
</div>



  <div id="savedList" style="display:none; width:min(440px, 92vw);"></div>

  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">




  <style>




  </style>
  
  

  <!-- ===== Core JS ===== -->

  <script src="https://js.stripe.com/v3/"></script>

  <script>


    document.addEventListener('DOMContentLoaded', () => {
    // convenience
    const csrf = () => document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

    // attach to the upgrade button or any test button you have
    const upgradeBtn = document.getElementById('openPremium'); // or some dedicated test button

    // for demo: clicking "Upgrade" sets tier locally to starter without Stripe
    upgradeBtn?.addEventListener('dblclick', async (e) => {
      // üëÜ use dblclick so you don‚Äôt override your normal modal on click
      e.preventDefault();
      try {
        const res = await fetch('/debug/set-tier/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf()
          },
          body: JSON.stringify({ tier: 'starter' })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
        alert(`Tier changed to ${data.tier} with limit ${data.limit}`);
        // optionally update the UI:
        document.querySelector('.plan-text').textContent = data.tier;
        document.getElementById('swipeLimit').textContent = data.limit;
      } catch (err) {
        console.error(err);
        alert('Could not change tier');
      }
    });
  });
    
document.addEventListener('DOMContentLoaded', () => {
  const $  = (s, r=document) => r.querySelector(s);
  // === Persistently hide already-applied jobs (per user) ===
  const USER_ID = "{{ request.user.id|default_if_none:'anon' }}";
  const SWIPED_KEY = `swiped_jobs_${USER_ID}`;

  function getSwipedSet() {
    try { return new Set(JSON.parse(localStorage.getItem(SWIPED_KEY) || "[]")); }
    catch { return new Set(); }
  }
  function saveSwipedSet(set) {
    localStorage.setItem(SWIPED_KEY, JSON.stringify([...set]));
  }
  function markSwiped(roomId) {
    const s = getSwipedSet(); s.add(String(roomId)); saveSwipedSet(s);
  }
  function unmarkSwiped(roomId) {
    const s = getSwipedSet(); s.delete(String(roomId)); saveSwipedSet(s);
  }

  // On load, remove any cards the user already applied to (prevents flicker)
  (function hidePreviouslySwiped() {
    const swiped = getSwipedSet();
    if (!swiped.size) return;
    document.querySelectorAll('.swipe-card[data-room-id]').forEach(card => {
      if (swiped.has(String(card.dataset.roomId))) card.remove();
    });
  })();

  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const csrf = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

  /* === Theme toggle === */
  const THEME_KEY = 'theme_v1';
  const root = document.documentElement;
  function applyTheme(mode){
    const light = (mode === 'light');
    root.classList.toggle('theme-light', light);
    const btn = document.getElementById('themeToggle');
    if (btn) btn.setAttribute('aria-pressed', light ? 'true' : 'false');
  }
  applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
  const themeBtn = document.getElementById('themeToggle');
  themeBtn?.addEventListener('click', () => {
    const light = !root.classList.contains('theme-light');
    applyTheme(light ? 'light' : 'dark');
    localStorage.setItem(THEME_KEY, light ? 'light' : 'dark');
  });

  /* === Sidebar toggle === */
  const container = $('.swipe-container');
  const cards = () => $$('.swipe-card', container);
  const ringBar = $('#ringBar');
  const cardsLeftEl = $('#cardsLeft');
  const streakEl = $('#streakVal');
  const comboEl = $('#comboBadge');


  const sidebar = $('#sidebar');
  const sidebarToggle = $('#sidebarToggle');
  const sidebarBackdrop = $('#sidebarBackdrop');
  const SB_KEY = 'ai_sidebar_open';

  function setSidebar(open){
    sidebar.classList.toggle('is-open', open);
    sidebarToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    sidebarToggle.classList.toggle('rot', open);
    document.documentElement.classList.toggle('sb-open', open);

    const isMobile = matchMedia('(max-width: 900px)').matches;
    if (isMobile) {
      sidebarBackdrop.hidden = !open;
      sidebarBackdrop.classList.toggle('show', open);
    } else {
      sidebarBackdrop.hidden = true;
      sidebarBackdrop.classList.remove('show');
    }
    try { localStorage.setItem(SB_KEY, open ? '1' : '0'); } catch(e){}
  }
  const saved = localStorage.getItem(SB_KEY);
  const savedOpen = saved ? (saved === '1') : false;
  setSidebar(savedOpen);

  sidebarToggle.addEventListener('click', () => setSidebar(!sidebar.classList.contains('is-open')));
  sidebarBackdrop.addEventListener('click', () => setSidebar(false));
  addEventListener('resize', () => setSidebar(sidebar.classList.contains('is-open')));

  /* === Swipes left setup === */
  const swipesLeftEl = document.getElementById('swipesLeft');
  fetch('/quota/')
    .then(r => r.json())
    .then(data => swipesLeftEl.textContent = data.left);

  /* === Premium Modal setup === */

  // === Stripe Checkout wiring ===
const STRIPE_PK = "{{ STRIPE_PUBLISHABLE_KEY|default_if_none:'' }}"; // if using Django template context; otherwise inline
let stripe;
try { stripe = Stripe(STRIPE_PK); } catch(e) { console.error("Stripe init failed", e); }

async function startCheckout(tier){
  try{
    const r = await fetch("/billing/create-checkout-session/", {
      method:"POST",
      headers: {"Content-Type":"application/json", "X-CSRFToken": csrf()},
      body: JSON.stringify({ tier })
    });
    const data = await r.json();
    if (data.error) throw new Error(data.error);
    if (data.url) window.location.href = data.url;
  }catch(err){
    console.error(err);
    showToast("Could not start checkout");
  }
}

// Button in the modal
document.getElementById("btnGoPremium")?.addEventListener("click", (e)=>{
  const tier = e.currentTarget.dataset.tier || "pro";
  startCheckout(tier);
});




  const premiumModal = document.getElementById('premiumModal');
  function showPremiumModal(){
    premiumModal?.classList.add('show');
    document.documentElement.style.overflow = 'hidden';
  }
  function hidePremiumModal(){
    premiumModal?.classList.remove('show');
    document.documentElement.style.overflow = '';
  }
  premiumModal?.addEventListener('click', e=>{
    if (e.target.matches('.modal__close,[data-close],.modal__backdrop')) hidePremiumModal();
  });

  const appliedWidget = $('#appliedWidget');
  const appliedCountEl = $('#appliedCount');

  let totalCards = cards().length;
  function updateDeckHUD() {
    const left = cards().length;
    cardsLeftEl.textContent = left;
    const pct = (1 - (left / Math.max(1,totalCards))) * 100;
    const CIRC = 2 * Math.PI * 16;
    ringBar.style.strokeDasharray = CIRC;
    ringBar.style.strokeDashoffset = CIRC - (CIRC * pct / 100);
  }





  function styleStack() {
  const list = cards();

  // Hide all cards and reset their layers
  list.forEach(c => {
    c.style.display = 'none';
    c.style.zIndex = '';
    c.style.pointerEvents = 'none'; // prevent click/swipe on hidden or lower cards
    c.classList.remove('is-top', 'is-next');
  });

  const top = list[list.length - 1];
  const next = list[list.length - 2];

  // Make next card visible but not interactive
  if (next) {
    next.style.display = 'block';
    next.style.zIndex = 5;
    next.classList.add('is-next');
    next.style.transform = 'scale(0.97) translateY(5px)';
    next.style.opacity = '0.9';
    next.style.pointerEvents = 'none'; // key line ‚Äî disable clicking it
  }

  // Top card visible + clickable
  if (top) {
    top.style.display = 'block';
    top.style.zIndex = 10;
    top.classList.add('is-top');
    top.style.transform = 'scale(1) translateY(0)';
    top.style.opacity = '1';
    top.style.pointerEvents = 'auto'; // enable only the front card
  }
}


  styleStack(); updateDeckHUD();

  const toastEl = $('#toast');

  // Click anywhere on card (except buttons) to flip
  document.querySelector('.swipe-container').addEventListener('click', (e) => {
    if (e.target.closest('.swipe-btn')) return;
    const card = e.target.closest('.swipe-card');
    if (!card) return;
    card.querySelector('.card-inner')?.classList.toggle('is-flipped');
  });

  // Keyboard accessibility: Enter/Space flips focused card
  document.addEventListener('keydown', (e) => {
    const focusedCard = document.activeElement?.classList?.contains('swipe-card') ? document.activeElement : null;
    if (focusedCard && (e.key === 'Enter' || e.key === ' ')) {
      e.preventDefault();
      focusedCard.querySelector('.card-inner')?.classList.toggle('is-flipped');
    }
  });

  const userKey = (suffix) => `if_swipe_${('{{ request.user.id|default_if_none:"anon" }}')}_${suffix}`;
  const todayKey = () => new Date().toISOString().slice(0,10);
  const getNum = (k,d=0)=> Number(localStorage.getItem(k) ?? d);
  const setNum = (k,v)=> localStorage.setItem(k, String(v));
  function getStreak(){
    const lastDay = localStorage.getItem(userKey('last_day'));
    const today = todayKey();
    let streak = getNum(userKey('streak'), 0);
    if (lastDay && lastDay !== today) {
      const diff = (new Date(today) - new Date(lastDay)) / 86400000;
      if (diff !== 1) { streak = 0; setNum(userKey('streak'), streak); }
    }
    return streak;
  }
  function bumpStreak(){
    const today = todayKey();
    let s = getStreak();
    const lastDay = localStorage.getItem(userKey('last_day'));
    if (lastDay !== today) s++;
    localStorage.setItem(userKey('last_day'), today);
    setNum(userKey('streak'), s);
    document.getElementById('streakVal').textContent = s;
    return s;
  }

  document.getElementById('streakVal').textContent = getStreak();
  { const el = document.getElementById('xpVal'); if (el) el.textContent = getNum(userKey('xp'),0); }
  appliedCountEl.textContent = getNum(userKey('applied'), 0);

  let combo=0, lastActionAt=0;
  function registerCombo(){
    const now = Date.now();
    combo = (now - lastActionAt < 4000) ? combo+1 : 1;
    lastActionAt = now;
    const comboEl = document.getElementById('comboBadge');
    comboEl.textContent = combo>1 ? `Combo x${combo}!` : '';
    comboEl.classList.toggle('is-active', combo>1);
    setTimeout(()=> comboEl.classList.remove('is-active'), 1200);
  }

  function stamp(card, type){
    const el = card.querySelector(type==='right' ? '.stamp--apply' : '.stamp--dismiss');
    if (!el) return; el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
    setTimeout(()=> el.classList.remove('show'), 450);
  }

  function confettiBurst(x, y, n=18){
    const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
    canvas.width=innerWidth; canvas.height=innerHeight; canvas.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:9999';
    document.body.appendChild(canvas);
    const p=Array.from({length:n},()=>({x,y,vx:(Math.random()*2-1)*6,vy:(Math.random()*-4-2),g:.18+Math.random()*.2,s:4+Math.random()*3,c:`hsl(${Math.random()*360},85%,60%)`,life:60+Math.random()*20}));
    (function tick(){ ctx.clearRect(0,0,canvas.width,canvas.height); p.forEach(o=>{o.vy+=o.g;o.x+=o.vx;o.y+=o.vy;o.life--;ctx.fillStyle=o.c;ctx.fillRect(o.x,o.y,o.s,o.s);}); if(p.some(o=>o.life>0)) requestAnimationFrame(tick); else canvas.remove(); })();
  }

  function flyCardToAppliedCounter(fromCard){
    const target = appliedWidget;
    if (!fromCard || !target) return;
    const r = fromCard.getBoundingClientRect();
    const t = target.getBoundingClientRect();

    const ghost = document.createElement('div');
    ghost.className = 'fly-ghost';
    ghost.style.left = r.left + 'px';
    ghost.style.top = r.top + 'px';
    ghost.style.width = r.width + 'px';
    ghost.style.height = r.height + 'px';
    document.body.appendChild(ghost);

    const dx = (t.left + t.width/2) - (r.left + r.width/2);
    const dy = (t.top + t.height/2) - (r.top + r.height/2);
    requestAnimationFrame(()=> {
      ghost.classList.add('run');
      ghost.style.transform = `translate(${dx}px, ${dy}px) scale(.15) rotate(12deg)`;
      ghost.style.opacity = .05;
    });

    ghost.addEventListener('transitionend', () => {
      ghost.remove();
      appliedWidget.classList.remove('ping'); void appliedWidget.offsetWidth; appliedWidget.classList.add('ping','bump');
    }, { once:true });
  }

  function incrementApplied(){
    const prev = getNum(userKey('applied'), 0);
    const next = prev + 1;
    setNum(userKey('applied'), next);

    const start = Number(appliedCountEl.textContent || 0);
    const duration = 350; let t0=null;
    function step(ts){ if(!t0) t0 = ts; const p = Math.min(1, (ts - t0)/duration); appliedCountEl.textContent = String(Math.round(start + (next-start)*p)); if (p<1) requestAnimationFrame(step); }
    requestAnimationFrame(step);
  }

  /* === Undo history === */
  const undoStack = [];



  
  function throwCard(direction = 'right', { doFetch = false, save = false } = {}) {
  if (direction === 'right' && doFetch) {
    const left = parseInt(swipesLeftEl?.textContent || '0', 10);
    if (left <= 0) {
      const noSwipesModal = document.getElementById('noSwipesModal');
      noSwipesModal?.classList.add('show');
      document.documentElement.style.overflow = 'hidden';
      return;
    }
  }






    const list = cards();
    if (!list.length) return;
    const current = list[list.length - 1];

    // Snapshot for undo
    const clone = current.cloneNode(true);
    clone.classList.remove('leaving', 'is-top', 'is-next', 'is-third');
    clone.style.transform = '';
    clone.style.opacity = '';
    clone.style.transition = '';
    undoStack.push({ el: clone, direction, doFetch, save, time: Date.now() });

    // Visuals
    current.classList.add('leaving');
    stamp(current, direction);

    if (direction === 'right' && doFetch) {
      current.style.opacity = 0;
      flyCardToAppliedCounter(current);
    } else {
      const x = direction === 'right' ? innerWidth * 1.2 : -innerWidth * 1.2;
      const y = Math.random() * 80 - 40;
      const rot = direction === 'right' ? 22 : -22;
      current.style.transition = 'transform .7s cubic-bezier(0.22,1,0.36,1), opacity .7s ease';
      current.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg) scale(1.02)`;
      current.style.opacity = 0;
    }

    setTimeout(() => {
      current.remove();
      styleStack();
      updateDeckHUD();
    }, 680);

    if (doFetch) {
  const leftNow = parseInt(swipesLeftEl?.textContent || '0', 10);
  swipesLeftEl.textContent = String(Math.max(0, leftNow - 1));

  const roomId = current.dataset.roomId;
  markSwiped(roomId);

  fetch("{% url 'apply_swipe_job' %}", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "X-CSRFToken": csrftoken,
  },
  body: JSON.stringify({ room_id: roomId }),
})
.then(async r => {
  const text = await r.text();   // read body once
  try {
    return JSON.parse(text);     // try JSON
  } catch {
    console.error("Non-JSON response from server:", text);
    throw new Error("Server error, see logs.");
  }
})
.then(data => {
  if (data.error === "OAuth required" && data.redirect) {
    unmarkSwiped(roomId);
    window.location.href = data.redirect;
  } else if (data.error) {
    unmarkSwiped(roomId);
    alert("Error: " + data.error);
  } else {
    swipesLeftEl.textContent = String(data.left ?? swipesLeftEl.textContent);
  }
})
.catch(err => {
  console.error("Fetch error:", err);
  unmarkSwiped(roomId);
});


}




    // Gamification + counters
    if (direction === 'right' || save) {
      const xp = direction === 'right' ? 15 : 8;
      registerCombo();

      if (direction === 'right' && doFetch) {
        const s = bumpStreak();
        incrementApplied();
        showToast(`Applied! +${xp} XP ¬∑ üî• Streak ${s}`);
        const t = appliedWidget.getBoundingClientRect();
        confettiBurst(t.left + t.width / 2, t.top + t.height / 2, 22);
      } else if (save) {
        showToast(`Saved! +${xp} XP`);
      }
    } else if (direction === 'left') {
      combo = 0;
      showToast('Skipped');
    }
  }

  function undoLast(){
    const last = undoStack.pop();
    if (!last) { showToast('Nothing to undo'); return; }

    const el = last.el;
    container.appendChild(el);

    el.style.opacity = '0';
    el.style.transform = 'translateY(14px) scale(.98)';
    el.style.transition = 'transform .26s ease, opacity .26s ease';

    requestAnimationFrame(() => {
      el.style.opacity = '1';
      el.style.transform = 'translateY(0) scale(1)';
    });

    el.addEventListener('transitionend', () => {
      el.style.transition = '';
      styleStack(); updateDeckHUD();
    }, { once:true });

    showToast('Brought back');
  }

  document.querySelector('.swipe-container').addEventListener('click', (e) => {
    const btn = e.target.closest('.swipe-btn');
    if (!btn) return;
    e.stopPropagation();
    const ripple = btn.querySelector('.btn-ripple'); 
    if (ripple){ ripple.classList.remove('run'); void ripple.offsetWidth; ripple.classList.add('run'); }

    if (btn.classList.contains('swipe-left'))     return void throwCard('left');
    if (btn.classList.contains('swipe-right'))    return void throwCard('right', {doFetch:true});
    if (btn.classList.contains('swipe-lightning'))return void throwCard('right', {doFetch:true});
    if (btn.classList.contains('swipe-return'))   return void undoLast();
  });


  document.querySelector('.swipe-container').addEventListener('click', (e) => {
    const favBtn = e.target.closest('.swipe-favorite');
    if (!favBtn) return;
    e.stopPropagation();

    const top = document.querySelectorAll('.swipe-card');
    const card = top[top.length-1];
    if (!card) return;
    const roomId = card.dataset.roomId;

    fetch('/save-job/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
      body: JSON.stringify({ room_id: roomId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }
      const badge = document.getElementById('savedBadge');
      if (badge) badge.textContent = String(parseInt(badge.textContent||'0',10)+1);
      // after saving animate the card away as saved
      throwCard('right', {save:true});
    })
    .catch(console.error);
  });

  

  document.addEventListener('keydown', (e) => {
    const topCard = cards().slice(-1)[0];
    if (!topCard) return;
    if (e.key === 'ArrowLeft')  throwCard('left');
    if (e.key === 'ArrowRight') throwCard('right', {doFetch:true});
    if (e.key.toLowerCase() === 's') throwCard('right', {save:true});
    if (e.key === 'Backspace')  undoLast();
    if (e.key === '\\') setSidebar(!sidebar.classList.contains('is-open'));
  });

  document.querySelector('.swipe-container').addEventListener('mousemove', (e) => {
    const c = cards().slice(-1)[0]; if (!c) return;
    const inner = c.querySelector('.card-inner'); const r=c.getBoundingClientRect();
    const rx=((e.clientY-r.top)/r.height - .5)*-6; const ry=((e.clientX-r.left)/r.width - .5)*6;
    inner.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
  });
  document.querySelector('.swipe-container').addEventListener('mouseleave', () => {
    const c=cards().slice(-1)[0]; if (!c) return; c.querySelector('.card-inner').style.transform='';
  });

  let toastTimer; 
  function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove('show'), 1400); }
});



const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

document.addEventListener('DOMContentLoaded', () => {
  // grab CSRF token once
  const csrftoken =
    document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

  document.getElementById('selectStarter')?.addEventListener('click', async e => {
    e.preventDefault();
    try {
      const r = await fetch('/debug/set-tier/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin',  // sends your session cookie
        body: JSON.stringify({ tier: 'starter' })
      });

      const data = await r.json();
      if (!r.ok) throw new Error(data.error || r.statusText);

      alert(`Tier changed to ${data.tier} with limit ${data.limit}`);

      // update plan label + limit
      document.querySelector('.plan-text').textContent = data.tier;
      document.getElementById('swipeLimit').textContent = data.limit;

      // update swipes left either from server response or fresh fetch
      if (typeof data.left === 'number') {
        document.getElementById('swipesLeft').textContent = data.left;
      } else {
        const quotaRes = await fetch('/quota/?t=' + Date.now(), { credentials:'same-origin' });
        const quota = await quotaRes.json();
        document.getElementById('swipesLeft').textContent = quota.left;
      }

      document.getElementById('premiumModal')?.classList.remove('show');
      document.documentElement.style.overflow = '';
    } catch (err) {
      console.error(err);
      alert('Could not change tier');
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const noSwipesModal = document.getElementById('noSwipesModal');
  if (!noSwipesModal) return;

  const closeModal = () => {
    noSwipesModal.classList.remove('show');
    document.documentElement.style.overflow = '';
  };

  noSwipesModal.querySelector('.modal__close')?.addEventListener('click', closeModal);
  noSwipesModal.querySelector('[data-close]')?.addEventListener('click', closeModal);
  noSwipesModal.querySelector('.modal__backdrop')?.addEventListener('click', closeModal);

  // Bonus: support Escape key
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && noSwipesModal.classList.contains('show')) {
      closeModal();
    }
  });
});


</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // read the "first_login" flag from the <main> element
  const main = document.querySelector('main.layout');
  const firstLogin = main?.dataset.firstLogin === 'true';

  if (!firstLogin) return; // nothing to do

  const overlay = document.getElementById('onboarding-overlay');
  const dialog  = document.getElementById('onboarding-dialog');
  const title   = document.getElementById('onb-title');
  const desc    = document.getElementById('onb-desc');
  const stepEl  = document.getElementById('onb-step');
  const totalEl = document.getElementById('onb-total');
  const prevBtn = document.getElementById('onb-prev');
  const nextBtn = document.getElementById('onb-next');

  // your steps:
  const steps = [
    {title: 'Welcome!', desc: "Let's get started by connecting your email so applications can be sent directly."},
    {title: 'Save jobs', desc: 'Tap the star to save a job for later.'},
    {title: 'Undo / Skip', desc: 'Swipe left to skip, undo to bring back.'},
  ];

  let step = 0;

  function renderStep() {
    const s = steps[step];
    title.textContent = s.title;
    desc.textContent = s.desc;
    stepEl.textContent = step + 1;
    totalEl.textContent = steps.length;
    prevBtn.style.display = step === 0 ? 'none' : 'inline-block';
    nextBtn.textContent = step === steps.length - 1 ? 'Finish' : 'Okay';
  }

  prevBtn.addEventListener('click', () => {
    if (step > 0) step--;
    renderStep();
  });

  nextBtn.addEventListener('click', () => {
    if (step < steps.length - 1) {
      step++;
      renderStep();
    } else {
      // finished ‚Äî hide overlay
      overlay.style.display = 'none';
      // optionally mark in localStorage so you don‚Äôt show again
      try { localStorage.setItem('if_seen_onboarding', '1'); } catch(e){}
    }
  });

  // don‚Äôt show if we already marked it
  if (localStorage.getItem('if_seen_onboarding') === '1') return;

  overlay.style.display = 'flex';
  renderStep();
});

// Mirror counts into the mobile HUD
function updateMobileHUD() {
  const left = document.getElementById('swipesLeft')?.textContent;
  const applied = document.getElementById('appliedCount')?.textContent;
  if (left !== null) document.getElementById('swipesLeftMobile').textContent = left;
  if (applied !== null) document.getElementById('appliedCountMobile').textContent = applied;
}

// call once and on any update
updateMobileHUD();
setInterval(updateMobileHUD, 1500); // cheap polling, or call inside your existing fetch.then()s



</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let page = 1;
  let loading = false;
  const deck = document.getElementById("swipeDeck");
  const sentinel = document.getElementById("loadMoreSentinel");

  async function loadMore() {
    if (loading) return;
    loading = true;

    page++;
    try {
      const res = await fetch(`/swipe/?page=${page}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!res.ok) return;
      const data = await res.text();

      // Stop observing if no new data
      if (!data.trim()) {
        observer.disconnect();
        return;
      }

      // Append new cards
      deck.insertAdjacentHTML("beforeend", data);

      // Re-run card styling and HUD updates
      if (typeof styleStack === "function") styleStack();
      if (typeof updateDeckHUD === "function") updateDeckHUD();

      // Reconnect observer to sentinel after DOM change
      observer.observe(sentinel);
    } catch (err) {
      console.error("Error loading more cards:", err);
    } finally {
      loading = false;
    }
  }

  // Create the observer
  const observer = new IntersectionObserver(
    (entries) => {
      if (entries[0].isIntersecting && !loading) {
        loadMore();
      }
    },
    { rootMargin: "300px" }
  );

  observer.observe(sentinel);

  // üß† Ensure continuous load if few cards left after swiping
  const container = document.querySelector(".swipe-container");
  const mutationObserver = new MutationObserver(() => {
    const visibleCards = container.querySelectorAll(".swipe-card").length;
    if (visibleCards <= 3 && !loading) {
      // preload next batch if we're about to run out
      loadMore();
    }
  });

  mutationObserver.observe(deck, { childList: true });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const openBtn = document.getElementById("openPremium");
  const modal = document.getElementById("noSwipesModal");

  if (openBtn && modal) {
    openBtn.addEventListener("click", () => {
      modal.classList.add("show");
      document.documentElement.style.overflow = "hidden";
    });
  }
});


document.addEventListener("DOMContentLoaded", () => {
  const openBtn = document.getElementById("openPremiumMobile");
  const modal = document.getElementById("noSwipesModal");

  if (openBtn && modal) {
    openBtn.addEventListener("click", () => {
      modal.classList.add("show");
      document.documentElement.style.overflow = "hidden";
    });
  }
});

</script>


{% endif %}
{% endblock %}

