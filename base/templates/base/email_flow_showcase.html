<!-- email_flow_showcase.html -->
<div id="emailFlowShowcase" class="efs" role="dialog" aria-modal="true" aria-labelledby="efs-title" hidden>
    <div class="efs__backdrop" data-efs-close aria-hidden="true"></div>
  
    <div class="efs__dialog" role="document">
      <!-- Header -->
      <div class="efs__head">
        <h3 id="efs-title">How applying works</h3>
        <button class="efs__close" type="button" aria-label="Close" data-efs-close>×</button>
      </div>
  
      <!-- Timeline progress -->
      <div class="efs__progress" aria-hidden="true">
        <span class="efs__bar"></span>
      </div>
  
      <!-- Stage -->
      <div class="efs__stage">
        <!-- Card stack (both demo cards occupy the same slot, shown sequentially) -->
        <div class="efs-card-stack" aria-hidden="true">
          <!-- Swipe demo card #1 (swipe LEFT) -->
          <div class="efs-card efs-card--1">
            <div class="efs-card__logo"></div>
            <div class="efs-card__meta">
              <div class="l l1"></div>
              <div class="l l2"></div>
            </div>
            <div class="efs-hand">
              <svg viewBox="0 0 64 64" width="54" height="54" aria-hidden="true">
                <path fill="currentColor" d="M38 6a6 6 0 0 0-6 6v10h-1V9a5 5 0 0 0-10 0v16h-1V14a5 5 0 0 0-10 0v24c0 9 7 16 16 16h13c8 0 13-6 13-13V20a5 5 0 0 0-10 0v3h-1V12a6 6 0 0 0-6-6z"/>
              </svg>
            </div>
            <div class="efs-swipe-arrow">←</div>
          </div>
  
          <!-- Swipe demo card #2 (swipe RIGHT) -->
          <div class="efs-card efs-card--2">
            <div class="efs-card__logo"></div>
            <div class="efs-card__meta">
              <div class="l l1"></div>
              <div class="l l2"></div>
            </div>
            <div class="efs-hand">
              <svg viewBox="0 0 64 64" width="54" height="54" aria-hidden="true">
                <path fill="currentColor" d="M38 6a6 6 0 0 0-6 6v10h-1V9a5 5 0 0 0-10 0v16h-1V14a5 5 0 0 0-10 0v24c0 9 7 16 16 16h13c8 0 13-6 13-13V20a5 5 0 0 0-10 0v3h-1V12a6 6 0 0 0-6-6z"/>
              </svg>
            </div>
            <div class="efs-swipe-arrow">→</div>
          </div>
        </div>
  
        <!-- Phone compose mock -->
        <div class="efs-phone" aria-label="Email compose demo">
          <div class="efs-phone__top">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
  
          <div class="efs-compose">
            <div class="efs-row"><span class="k">To</span><span class="v">hiring@company.com</span></div>
            <div class="efs-row">
              <span class="k">Subject</span>
              <span class="v">Application: {{ request.user.first_name|default:"You" }}</span>
            </div>
  
            <!-- AI drafting -->
            <div class="efs-ai">
              <div class="efs-ai__chip">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                  <path d="M12 2l3 4 5 1-3 4 .5 5-5-2-5 2 .5-5-3-4 5-1 3-4z" fill="currentColor" />
                </svg>
                <span>AI drafting…</span>
                <span class="sparkle" aria-hidden="true"></span>
              </div>
              <div class="efs-typed" aria-live="polite">
                <div class="t" style="--chars:38">Dear Hiring Team, I’m excited to apply for</div>
                <div class="t" style="--chars:44">the {{ rooms.0.role|default:"role" }} at {{ rooms.0.company_name|default:"your company" }}.</div>
                <div class="t" style="--chars:36">My background in {{ rooms.0.job_title|default:"the field" }}</div>
                <div class="t" style="--chars:30">aligns with your needs. Please find</div>
                <div class="t" style="--chars:25">my resume attached below.</div>
              </div>
            </div>
  
            <!-- attachment chip -->
            <div class="efs-attach">
              <div class="chip">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                  <path d="M21 12.5V7a5 5 0 1 0-10 0v9a3 3 0 1 0 6 0V8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>Resume.pdf</span>
              </div>
            </div>
  
          </div>
        </div>
  
        <!-- “Sent” toast -->
        <div class="efs-sent" role="status" aria-live="polite">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          <span>Application sent!</span>
        </div>
      </div>
  
      <!-- Actions -->
      <div class="efs__actions">
        <button class="efs__btn efs__btn--ghost" type="button" data-efs-close>Skip</button>
        <button class="efs__btn efs__btn--primary" type="button" data-efs-close>Start swiping</button>
      </div>
    </div>
  </div>
  
  <style>
  /* ===== AI Email Flow Showcase ===== */
  .efs{position:fixed;inset:0;display:none;place-items:center;z-index:10050;font-family:'Manrope',sans-serif;}
  .efs[aria-modal="true"]{outline:0}
  .efs.show{display:grid}
  .efs__backdrop{position:absolute;inset:0;background:rgba(2,6,23,.65);backdrop-filter:blur(8px)}
.efs__dialog{
  position:relative;z-index:1;
  width:min(760px,92vw);
  max-height:92vh;              /* keep dialog inside viewport */
  display:flex;                 /* allow the stage to center vertically */
  flex-direction:column;
  border-radius:20px;
  padding:22px 22px 16px;
  background:var(--panel,#0f1525);
  border:1px solid var(--border,rgba(148,163,184,.22));
  box-shadow:0 40px 80px rgba(0,0,0,.5);
  color:var(--ink,#e6eef8)
}
  .theme-light .efs__dialog{background:#f6f8fb;border-color:rgba(15,23,42,.12);color:#0e1320}
  
  .efs__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .efs__head h3{margin:0;font:800 18px/1.3 Manrope}
  .efs__close{background:none;border:0;color:inherit;opacity:.7;cursor:pointer;font-size:22px}
  .efs__close:hover{opacity:1}
  
  .efs__progress{height:4px;background:var(--border-subtle,rgba(148,163,184,.12));border-radius:999px;overflow:hidden;margin:6px 0 16px}
  .efs__bar{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand,#ed003c),#ff4f7a);border-radius:inherit;transition:width .35s ease}
  
.efs__stage{
  flex:1 1 auto;            /* take remaining height in the dialog */
  min-height:0;             /* allow shrinking below content height */
  display:flex;
  flex-direction:column;    /* single column stack */
  align-items:center;       /* horizontal centering */
  justify-content:center;   /* vertical centering */
  gap:22px;
  overflow:auto;            /* if content gets taller, allow scroll instead of clipping */
}
  @media (max-width:900px){
    .efs__stage{grid-template-columns:1fr;gap:16px}
  }
  
/* Card stack — bigger/taller like Tinder cards */
.efs-card-stack{
  position:relative;
  /* wider + notably taller */
  width:clamp(360px, 56vw, 580px);
  height:clamp(580px, 74vh, 840px);
  justify-self:center;
  display:grid;
  place-items:center;
  margin-inline:auto;
}
.efs-card-stack .efs-card{position:absolute; inset:0; margin:auto}

/* Card look */
.efs-card{
  border-radius:28px;
  background:linear-gradient(180deg,#0f1527,#0c1426);
  border:1px solid rgba(148,163,184,.18);
  box-shadow:0 24px 64px rgba(2,6,23,.6);
  overflow:hidden;
}


  .theme-light .efs-card{background:linear-gradient(180deg,#f6f8fc,#eef2f7);border-color:#d5dbe6;box-shadow:0 18px 40px rgba(15,23,42,.14)}
  .efs-card__logo{width:68px;height:68px;border-radius:14px;background:#fff;box-shadow:0 6px 14px rgba(0,0,0,.12);position:absolute;left:18px;top:18px}
  .efs-card__meta{position:absolute;left:18px;bottom:18px;right:18px}
  .efs-card__meta .l{height:10px;border-radius:8px;background:rgba(255,255,255,.14);margin:8px 0}
  .theme-light .efs-card__meta .l{background:rgba(15,23,42,.10)}
  .efs-card__meta .l1{width:70%}.efs-card__meta .l2{width:46%}
  .efs-hand{position:absolute;right:12px;bottom:10px;color:#ffd6de;opacity:.85;filter:drop-shadow(0 8px 18px rgba(0,0,0,.35))}
  .theme-light .efs-hand{color:#ed003c}
  .efs-swipe-arrow{position:absolute;right:16px;top:14px;font-weight:800;letter-spacing:.12em;color:#ffd6de;opacity:.9}
  .theme-light .efs-swipe-arrow{color:#ed003c}
  
  /* Initial stacking states */
  .efs-card--1{opacity:1;transform:none}
  .efs-card--2{opacity:0;transform:scale(.96) translateY(10px);pointer-events:none}
  
  /* phone mock */
.efs-phone{
  position:relative;
  width:min(420px,42vw);
  height:auto;
  min-height:460px;                 /* a bit shorter so it fits */
  max-height:70vh;                  /* never exceed the visible area */
  border-radius:24px;
  border:1px solid rgba(148,163,184,.18);
  background:linear-gradient(180deg,#0f1527,#0c1426);
  box-shadow:0 20px 48px rgba(2,6,23,.45);
  padding:18px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  opacity:0;
  transform:translateY(8px) scale(.98);
  pointer-events:none;
  justify-self:center;
  margin-inline:auto;
}
  .theme-light .efs-phone{background:linear-gradient(180deg,#f6f8fc,#eef2f7);border-color:#d5dbe6}
  .efs-phone__top{display:flex;gap:6px;margin-bottom:10px}
  .efs-phone__top .dot{width:8px;height:8px;border-radius:999px;background:#e2e8f5;opacity:.6}
  .theme-light .efs-phone__top .dot{background:#8da0ba}
  
  .efs-compose{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(148,163,184,.18);
    border-radius:16px;
    padding:20px 22px 28px; /* balanced padding */
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    gap:10px;
    min-height:360px;
    box-sizing:border-box;
    position:relative;
    overflow:hidden; /* keeps all content neatly inside */
}


  .theme-light .efs-compose{background:rgba(2,6,23,.04);border-color:rgba(15,23,42,.12)}
  .efs-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .efs-row .k{font-weight:800;font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#cbd5e1}
  .theme-light .efs-row .k{color:#51607a}
  .efs-row .v{font-weight:700}
  
  .efs-ai__chip{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,rgba(237,0,60,.16),rgba(237,0,60,.10));border:1px solid rgba(237,0,60,.32);color:#ffd6de;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px;position:relative}
  .theme-light .efs-ai__chip{color:#0e1320;background:linear-gradient(135deg,rgba(237,0,60,.10),rgba(237,0,60,.06));border-color:rgba(237,0,60,.25)}
  .efs-ai__chip svg{color:var(--brand,#ed003c)}
  .efs-ai{margin-bottom:8px}
  .efs-typed{
    margin-top:8px;
    font:600 15px/1.6 ui-monospace,Menlo,monospace; /* smaller, denser text */
    color:#e6eef8;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    width:100%;
    max-width:100%;
    overflow:hidden;
}

  
  .theme-light .efs-typed{color:#0e1320}
  .efs-typed .t{
    width:0ch;
    display:block;
    white-space:nowrap;           /* keep one line during typing */
    overflow:hidden;              /* clip during typing (no horizontal scroll) */
    border-right:2px solid rgba(255,255,255,.75);
    border-right-color:transparent; /* hide caret until typing starts */
    margin:6px 0 0 0;
  }
  .efs-typed .t.done{
    border-right:0;
    animation:none!important; /* stop caret */
    width:auto !important;    /* preserve text width once typed */
    white-space:normal;        /* allow wrapping after the line has finished */
  }
  
  .efs-typed .t + .t{margin-top:2px}
  .theme-light .efs-typed .t{border-right:2px solid rgba(15,23,42,.7)}
  
  .efs-attach{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    margin-top:16px; /* adds separation from text */
}

  .efs-attach .chip{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.08);border:1px solid rgba(148,163,184,.2);color:#e6eef8;border-radius:10px;padding:6px 10px;font-weight:700;opacity:0;transform:translateY(16px) scale(.96)}
  .theme-light .efs-attach .chip{background:rgba(2,6,23,.04);border-color:rgba(15,23,42,.12);color:#0e1320}
  
  
  .efs-sent{position:absolute;inset:auto 22px 18px auto;display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#0b1220,#0e1729);color:#fff;border:1px solid var(--border,rgba(148,163,184,.22));padding:8px 12px;border-radius:12px;box-shadow:0 14px 36px rgba(2,6,23,.36);opacity:0;transform:translateY(8px)}
  .theme-light .efs-sent{background:#0e1320;color:#fff;border-color:rgba(15,23,42,.25)}
  
.efs__actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px;flex:0 0 auto}
  .efs__btn{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .efs__btn--ghost{background:rgba(255,255,255,.06);border:1px solid var(--border,rgba(148,163,184,.22));color:var(--ink,#e6eef8)}
  .theme-light .efs__btn--ghost{background:rgba(2,6,23,.04);border-color:rgba(15,23,42,.12);color:#0e1320}
  .efs__btn--primary{background:var(--brand,#ed003c);color:#fff}
  
  /* ===== Animations (timeline driven by .play class) ===== */
  @keyframes efs-swipe-right{
  0%{opacity:1;visibility:visible}
  100%{transform:translateX(640px) rotate(10deg);opacity:0;visibility:hidden;pointer-events:none}
}
@keyframes efs-swipe-left{
  0%{opacity:1;visibility:visible}
  100%{transform:translateX(-640px) rotate(-10deg);opacity:0;visibility:hidden;pointer-events:none}
}

  @keyframes efs-card-in{from{opacity:0;transform:scale(.9) translateY(30px)}to{opacity:1;transform:scale(1) translateY(0)}}
  @keyframes efs-hand-left{to{transform:translateX(-70px) translateY(-6px)}}
  @keyframes efs-hand-right{to{transform:translateX(70px) translateY(-6px)}}
  @keyframes efs-typing{
    from{width:0ch}
    to{width:calc(var(--chars) * 1ch)}
  }
  @keyframes efs-caret{50%{border-right-color:transparent}}
  @keyframes efs-spark{0%{transform:scale(.8) rotate(0);opacity:.4}50%{transform:scale(1.12) rotate(180deg);opacity:1}100%{transform:scale(.8) rotate(360deg);opacity:.4}}
  @keyframes efs-chip{to{opacity:1;transform:translateY(0) scale(1)}}
  @keyframes efs-pulse{0%,100%{box-shadow:0 0 0 0 rgba(237,0,60,.35)}50%{box-shadow:0 0 0 8px rgba(237,0,60,0)}}
  @keyframes efs-plane{to{transform:translateX(240px);opacity:1}}
  @keyframes efs-sent{to{opacity:1;transform:translateY(0)}}
  @keyframes efs-bar{to{width:100%}}
  @keyframes efs-showphone{to{opacity:1;transform:none}}
  
  /* Progress bar spans the whole sequence */
  .efs.play .efs__bar{animation:efs-bar 8.8s linear forwards}
  
  /* Sequence:
     0) Card #1 visible
     1) Card #1 swipes LEFT (and disappears)
     2) Card #2 appears, then swipes RIGHT (and disappears)
     3) Phone shows, then typing/attach/send
  */
  
  /* Step 1: first card swipe left + hand hint */
  .efs.play .efs-card--1{
    animation:efs-swipe-left 1s .2s cubic-bezier(.22,1,.36,1) forwards;
    overflow:visible
  }
  .efs.play .efs-card--1 .efs-hand{animation:efs-hand-left .9s .25s ease forwards}
  
  /* Step 2: second card enters then swipes right + hand hint */
  .efs.play .efs-card--2{
    animation:
      efs-card-in .5s 1.35s ease forwards,
      efs-swipe-right 1s 2.0s cubic-bezier(.22,1,.36,1) forwards;
    pointer-events:auto;
  }
  .efs.play .efs-card--2 .efs-hand{animation:efs-hand-right .9s 2.05s ease forwards}
  
  /* Step 3: show phone after both swipes complete */
  .efs.play .efs-phone{animation:efs-showphone .45s 3.1s ease forwards; pointer-events:auto}
  
  /* Step 4: typing lines (staggered) */
  .efs.play .efs-ai__chip .sparkle{
    position:absolute;right:-6px;top:-6px;width:10px;height:10px;
    background:radial-gradient(circle,#ffd6de 0,#ed003c 70%,transparent 72%);
    border-radius:999px;animation:efs-spark 1.4s 3.1s linear infinite
  }
  .efs.play .efs-typed .t{
    animation:
      efs-typing 1.05s steps(var(--chars)) var(--delay,0s) forwards,
      efs-caret .9s steps(1) var(--delay,0s) infinite;
  }

  
  /* Attach chip */
/* Attach chip appears right after last line finishes typing */
.efs.play .efs-attach .chip{animation:efs-chip .45s 7.9s cubic-bezier(.22,1,.36,1) forwards}
  
  /* Sent toast */
  .efs.play .efs-sent{animation:efs-sent .35s 8.5s ease forwards}
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    .efs__bar,.efs-card,.efs-hand,.efs-typed .t,.efs-attach .chip,.efs-plane,.efs-sent{animation:none!important;transition:none!important}
    .efs-card--2{opacity:1;transform:none}
    .efs.play .efs-typed .t{width:auto;border-right:0}
    .efs.play .efs-attach .chip{opacity:1;transform:none}
    .efs.play .efs-sent{opacity:1;transform:none}
    .efs-phone{opacity:1;transform:none;pointer-events:auto}
  }
  </style>
  
  <script>
  /**
   * Email Flow Showcase controller
   * Exposes window.EFS.open()/close()/reset()
   * Auto-opens after onboarding if email is configured (reads from <main data-email-configured="true">).
   */
  (function () {
    const overlay = document.getElementById('emailFlowShowcase');
    if (!overlay) return;

    const SEEN_KEY = 'if_email_flow_demo_shown';
    const qs = (sel, root = document) => root.querySelector(sel);

    function setupCaretCleanup(){
      const lines = overlay.querySelectorAll('.efs-typed .t');
      lines.forEach((line)=>{
        line.addEventListener('animationend', (e)=>{
          if (e.animationName === 'efs-typing') {
            line.classList.add('done');
          }
        });
      });
    }

    function open() {
      // restart the timeline each time we open
      reset();
      overlay.hidden = false;
      overlay.classList.add('show');
      setupCaretCleanup();
      // kick the animation one frame later so CSS sees .show already applied
      requestAnimationFrame(() => overlay.classList.add('play'));
    }

    function close() {
      overlay.classList.remove('play', 'show');
      overlay.hidden = true;
      try { localStorage.setItem(SEEN_KEY, '1'); } catch {}
    }

    function reset() {
      // remove play to reset animated elements (progress bar, typing, etc.)
      overlay.classList.remove('play');
      overlay.querySelectorAll('.efs-typed .t.done').forEach(el=>el.classList.remove('done'));
      // force reflow to clear animations
      void overlay.offsetHeight;
    }

    // Close handlers (backdrop, X button, footer buttons)
    overlay.addEventListener('click', (e) => {
      if (e.target.matches('[data-efs-close], .efs__backdrop, .efs__close')) {
        close();
      }
    });

    // Esc key closes
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !overlay.hidden) close();
    });

    // Public API (handy for debugging or manual triggers)
    window.EFS = {
      open, close, reset,
      shown: () => localStorage.getItem(SEEN_KEY) === '1'
    };

    // Optional manual trigger if a debug button exists
    document.getElementById('showEFSNow')?.addEventListener('click', () => {
      try { localStorage.removeItem(SEEN_KEY); } catch {}
      open();
    });

    // Auto-open logic:
    // - Only if email is configured AND not shown before.
    // - If onboarding is in progress, wait for custom event 'onboarding:finished'.
    const main = qs('main.layout');
    const emailConfigured = (main?.dataset.emailConfigured === 'true');
    const alreadySeen = (localStorage.getItem(SEEN_KEY) === '1');
    const onboardingSeen = (localStorage.getItem('if_seen_onboarding') === '1');

    function tryAutoOpen() {
      if (emailConfigured && !alreadySeen) open();
    }

    if (emailConfigured && !alreadySeen) {
      if (!onboardingSeen) {
        // wait for onboarding overlay to finish (your app should dispatch this event)
        document.addEventListener('onboarding:finished', tryAutoOpen, { once: true });
      } else {
        // open immediately on first paint
        requestAnimationFrame(tryAutoOpen);
      }
    }
  })();


      // --- Ensure resume chip appears after last line is done typing ---
      const lastLine = overlay.querySelector('.efs-typed .t:last-child');
    const resumeChip = overlay.querySelector('.efs-attach .chip');

    if (lastLine && resumeChip) {
      lastLine.addEventListener('animationend', (e) => {
        if (e.animationName === 'efs-typing') {
          resumeChip.style.animation = 'efs-chip 0.45s cubic-bezier(.22,1,.36,1) forwards';
        }
      });
    }

    requestAnimationFrame(() => {
        overlay.classList.add('play');

        // Sequential typing logic: start each line only when the previous finishes
        const lines = [...overlay.querySelectorAll('.efs-typed .t')];
        let totalDelay = 0;
        const typeDurationPerChar = 0.028; // typing speed per character (in seconds)

        lines.forEach((line, i) => {
          const charCount = parseInt(line.style.getPropertyValue('--chars')) || 30;
          const duration = charCount * typeDurationPerChar;

          // Assign dynamic delays so typing happens strictly in sequence
          line.style.setProperty('--delay', `${3.4 + totalDelay}s`);
          line.style.animation = `
            efs-typing ${duration}s steps(${charCount}) ${3.4 + totalDelay}s forwards,
            efs-caret .9s steps(1) ${3.4 + totalDelay}s infinite
          `;
          totalDelay += duration + 0.35; // include slight pause between lines
        });

        // Schedule resume chip after last line finishes
        const lastLine = lines.at(-1);
        const resumeChip = overlay.querySelector('.efs-attach .chip');
        if (lastLine && resumeChip) {
          const totalTypingTime = 3.4 + totalDelay;
          resumeChip.style.animation = `efs-chip 0.45s ${totalTypingTime}s cubic-bezier(.22,1,.36,1) forwards`;
        }
      });


  </script>