<!-- =========================
     EMAIL FLOW SHOWCASE MODAL (FIXED)
     ========================= -->
<div id="emailFlowShowcase"
     class="efs"
     role="dialog"
     aria-modal="true"
     aria-labelledby="efs-title"
     hidden>
  <!-- Backdrop -->
  <div class="efs__backdrop" data-efs-close aria-hidden="true"></div>

  <!-- Modal content -->
  <div class="efs__dialog" role="document">
    <!-- Header -->
    <div class="efs__head">
      <h3 id="efs-title">How applying works</h3>
      <button class="efs__close" type="button" aria-label="Close" data-efs-close>×</button>
    </div>

    <!-- Progress bar -->
    <div class="efs__progress" aria-hidden="true">
      <span class="efs__bar"></span>
    </div>

    <!-- Stage (all animations inside here) -->
    <div class="efs__stage">
      {% include "base/email_flow_cards.html" %}
      {% include "base/email_flow_compose.html" %}
    </div>

    <!-- Footer actions -->
    <div class="efs__actions">
      <button class="efs__btn efs__btn--ghost" type="button" data-efs-close>Skip</button>
      <button class="efs__btn efs__btn--primary" type="button" data-efs-close>Start swiping</button>
    </div>
  </div>
</div>

<style>
/* =========================
   EMAIL FLOW SHOWCASE MODAL
   ========================= */
.efs {
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  z-index: 10050;
  font-family: 'Manrope', sans-serif;
}
.efs.show { display: grid; }

.efs__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(2, 6, 23, 0.65);
  backdrop-filter: blur(8px);
}

.efs__dialog {
  position: relative;
  z-index: 1;
  width: min(1100px, 94vw);
  height: min(90vh, 900px) !important;
  overflow: hidden !important;
  display: flex;
  flex-direction: column;
  border-radius: 20px;
  padding: 30px 22px 10px;
  background: var(--panel, #0f1525);
  border: 1px solid var(--border, rgba(148,163,184,.22));
  box-shadow: 0 30px 70px rgba(0, 0, 0, 0.45);
  color: var(--ink, #e6eef8);
  justify-content: flex-start;
}

.theme-light .efs__dialog {
  background: #f6f8fb;
  border-color: rgba(15,23,42,.12);
  color: #0e1320;
}

.efs__head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
  flex: 0 0 auto;
}
.efs__head h3 {
  margin: 0;
  font: 800 18px/1.3 Manrope;
}
.efs__close {
  background: none;
  border: 0;
  color: inherit;
  opacity: .7;
  cursor: pointer;
  font-size: 22px;
}
.efs__close:hover { opacity: 1; }

.efs__progress {
  height: 4px;
  background: rgba(148,163,184,.12);
  border-radius: 999px;
  overflow: hidden;
  margin: 6px 0 16px;
  flex: 0 0 auto;
}
.efs__bar {
  display: block;
  height: 100%;
  width: 0;
  background: linear-gradient(90deg, var(--brand,#ed003c), #ff4f7a);
  border-radius: inherit;
  transition: width .35s ease;
}

.efs__stage {
  flex: 1 1 auto;
  width: 100%;
  height: auto !important;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  overflow: visible !important;
  gap: 18px;
  padding-top: 10px; /* reduced top spacing */
}

.efs__actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 14px;
  flex: 0 0 auto;
}
.efs__btn {
  border: 0;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 800;
  cursor: pointer;
}
.efs__btn--ghost {
  background: rgba(255,255,255,.06);
  border: 1px solid var(--border, rgba(148,163,184,.22));
  color: var(--ink, #e6eef8);
}
.theme-light .efs__btn--ghost {
  background: rgba(2,6,23,.04);
  border-color: rgba(15,23,42,.12);
  color: #0e1320;
}
.efs__btn--primary {
  background: var(--brand, #ed003c);
  color: #fff;
}

/* Progress bar animation */
@keyframes efs-bar { to { width: 100%; } }
.efs.play .efs__bar {
  animation: efs-bar 8.8s linear forwards;
}

/* Adjusted card sizing */
.efs-card {
  padding: 140px 36px 260px !important;
  height: auto !important;
  min-height: 760px; /* reduced height so email fits higher */
  box-sizing: border-box;
}

.efs-card-stack {
  height: clamp(760px, 70vh, 960px) !important; /* fit better within modal */
}


/* Let the dialog scroll instead of clipping the email */
.efs__dialog{
  overflow-y: auto !important;   /* was overflow: hidden */
  overflow-x: hidden !important;
  height: min(96vh, 1050px) !important; /* you can keep your cap, just not smaller than the stack+email */
}

/* Make the card stack leave room for the email below */
.efs-card-stack{
  height: clamp(520px, 52vh, 740px) !important;  /* reduce a bit so both fit */
}

/* Cards still fill their stack, but don’t demand excessive height */
.efs-card{
  min-height: 560px !important;
  height: 100% !important;
  padding-bottom: 160px !important; /* enough room for tags/meta */
}

/* If you still have the sequencing hide rule somewhere, neutralize it */
.efs__stage > :nth-child(2){
  opacity: 1 !important;
  transform: none !important;
  pointer-events: auto !important;
}

/* === Pull the email up (place after your existing CSS) === */

/* Make the stack shorter so the email appears higher */
.efs-card-stack{
  height: clamp(420px, 46vh, 620px) !important;  /* was ~520–960px */
  margin: 0 !important;
}

/* Cards still fill the stack but with less bottom padding */
.efs-card{
  min-height: 460px !important;                  /* was 560–760px */
  height: 100% !important;
  padding: 140px 32px 120px !important;          /* reduce bottom space */
  box-sizing: border-box !important;
}

/* Keep the stage tight and content starting at the top */
.efs__stage{
  justify-content: flex-start !important;
  gap: 12px !important;                           /* smaller gap between cards & email */
  padding-top: 6px !important;
}

/* Ensure the email block doesn’t add extra spacing */
.efs-phone{
  margin: 0 !important;                           /* no stray margins */
}

/* Keep scrolling available if needed (don’t clip) */
.efs__dialog{
  overflow-y: auto !important;
  overflow-x: hidden !important;
}


/* === Pack cards + email at the very top of the modal === */

/* Make the stage a "packed" grid (no leftover space above/between) */
.efs__stage{
  display: grid !important;
  grid-auto-flow: row !important;
  grid-auto-rows: max-content !important;  /* each child is only as tall as it needs */
  align-content: start !important;         /* pack to the top */
  justify-items: center !important;        /* center each child horizontally */
  gap: 12px !important;                    /* small space between cards and email */
  height: auto !important;
  padding-top: 6px !important;
}

/* Kill vertical margins any child might add */
.efs__stage > *{
  margin: 0 !important;
}

/* Let the stack size itself to its content instead of reserving big space */
.efs-card-stack{
  height: auto !important;                 /* was a clamp(...) */
}

/* Cards still look the same but don’t inflate the stack */
.efs-card{
  height: auto !important;
  min-height: 520px !important;            /* adjust to taste */
  padding: 140px 32px 140px !important;    /* keep your interior spacing */
  box-sizing: border-box !important;
}

/* Ensure email block doesn’t push itself down */
.efs-phone{
  margin: 0 !important;
}

/* If any sequencing rule was hiding the email, neutralize it */
.efs__stage > :nth-child(2){
  opacity: 1 !important;
  transform: none !important;
  pointer-events: auto !important;
}

/* Keep the dialog scrollable if things get tall */
.efs__dialog{
  overflow-y: auto !important;
  overflow-x: hidden !important;
}

/* === Center the cards + email in the modal (both axes) === */

.efs__stage{
  /* make the stage fill the available space and use a 1-column grid */
  height: 100% !important;
  min-height: 0 !important;
  display: grid !important;
  grid-auto-flow: row !important;
  grid-auto-rows: max-content !important;

  /* center the whole stack of rows (cards + email) vertically & horizontally */
  place-content: center center !important;  /* shorthand for align-content & justify-content */
  place-items: center center !important;    /* center each child item */

  gap: 16px !important;
  padding-top: 0 !important;                /* remove extra offset */
}

/* ensure each child centers within the grid cell */
.efs-card-stack,
.efs-phone{
  justify-self: center !important;
  align-self: center !important;
  margin: 0 !important;
}

/* let the stack size to its content so centering is exact */
.efs-card-stack{
  height: auto !important;
}

/* cards: size to content, keep your interior padding */
.efs-card{
  height: auto !important;
  min-height: 520px !important;             /* tweak if you want more/less height */
  padding: 140px 32px 140px !important;
  box-sizing: border-box !important;
}

/* keep the dialog scrollable if content gets taller than the viewport */
.efs__dialog{
  overflow-y: auto !important;
  overflow-x: hidden !important;
}


/* === Vertically center cards + email as a group, then nudge down === */
:root{
  /* increase --efs-top-fr to push content further DOWN (e.g. 1.4, 1.6, 2) */
  --efs-top-fr: 1.35;
  --efs-bottom-fr: 1;
}

.efs__stage{
  /* full height area to center within */
  height: 100% !important;
  min-height: 0 !important;

  /* 4-row grid: [spacer][cards][email][spacer] */
  display: grid !important;
  grid-template-rows:
    minmax(0, var(--efs-top-fr)fr)
    max-content
    max-content
    minmax(0, var(--efs-bottom-fr)fr) !important;

  /* center each child horizontally */
  justify-items: center !important;

  /* no extra offsets */
  gap: 16px !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
}

/* put the cards in row 2, email in row 3 */
.efs-card-stack{ grid-row: 2 !important; }
.efs-phone{ grid-row: 3 !important; }

/* ensure the stack sizes to its content (so vertical math is precise) */
.efs-card-stack{ height: auto !important; }

/* cards still size to content */
.efs-card{
  height: auto !important;
  min-height: 520px !important;
  padding: 140px 32px 140px !important;
  box-sizing: border-box !important;
}


/* === FINAL POSITIONING OVERRIDES — put LAST === */
:root{
  /* Bigger top spacer pushes the group down inside the modal */
  --efs-top-fr: 2.2fr;   /* try 2.4fr or 2.8fr if you want lower */
  --efs-bottom-fr: 1fr;

  /* Fine-tune nudge for the cards only (email stays put) */
  --efs-cards-shift: 32px; /* increase to move further down */
}

.efs__stage{
  height: 100% !important;
  display: grid !important;
  grid-template-rows:
    minmax(0, var(--efs-top-fr))
    max-content
    max-content
    minmax(0, var(--efs-bottom-fr)) !important;
  justify-items: center !important;  /* center horizontally */
  align-content: stretch !important; /* respect the spacer rows */
  gap: 16px !important;
  padding: 0 !important;
}

.efs-card-stack{
  grid-row: 2 !important;
  margin: 0 auto !important;                   /* kill earlier margins */
  height: auto !important;                     /* let content decide */
  transform: translateY(var(--efs-cards-shift)) !important; /* nudge down */
}

.efs-phone{
  grid-row: 3 !important;                      /* email stays centered */
}

.efs-card{
  height: auto !important;
  min-height: 520px !important;
  padding: 140px 32px 140px !important;
  box-sizing: border-box !important;
}


/* Reserve vertical space for the absolute cards */
:root { --efs-cards-h: 560px; } /* adjust to your card height */

.efs-card-stack{
  position: relative !important;
}

.efs-card-stack::before{
  content: "" !important;
  display: block !important;
  height: var(--efs-cards-h) !important;  /* gives the stack a footprint */
}




</style>

<script>
(function(){
  const overlay = document.getElementById('emailFlowShowcase');
  if (!overlay) return;

  const SEEN_KEY = 'if_email_flow_demo_shown';
  const qs = (sel, root=document) => root.querySelector(sel);

  function setupCaretCleanup(){
    const lines = overlay.querySelectorAll('.efs-typed .t');
    lines.forEach((line)=>{
      line.addEventListener('animationend',(e)=>{
        if(e.animationName==='efs-typing') line.classList.add('done');
      });
    });
  }

  function open(){
    reset();
    overlay.hidden = false;
    overlay.classList.add('show');
    setupCaretCleanup();
    requestAnimationFrame(()=>{
      overlay.classList.add('play');
      if(window.EmailDemo) window.EmailDemo.runTypingAnimation();
    });
  }

  function close(){
    overlay.classList.remove('play','show');
    overlay.hidden = true;
    try{localStorage.setItem(SEEN_KEY,'1');}catch{}
  }

  function reset(){
    overlay.classList.remove('play');
    overlay.querySelectorAll('.efs-typed .t.done').forEach(el=>el.classList.remove('done'));
    void overlay.offsetHeight;
  }

  overlay.addEventListener('click',(e)=>{
    if(e.target.matches('[data-efs-close], .efs__backdrop, .efs__close')) close();
  });
  document.addEventListener('keydown',(e)=>{
    if(e.key==='Escape' && !overlay.hidden) close();
  });

  window.EFS={open,close,reset,shown:()=>localStorage.getItem(SEEN_KEY)==='1'};

  document.getElementById('showEFSNow')?.addEventListener('click',()=>{
    try{localStorage.removeItem(SEEN_KEY);}catch{}
    open();
  });

  const main=qs('main.layout');
  const emailConfigured=(main?.dataset.emailConfigured==='true');
  const alreadySeen=(localStorage.getItem(SEEN_KEY)==='1');
  const onboardingSeen=(localStorage.getItem('if_seen_onboarding')==='1');

  function tryAutoOpen(){
    if(emailConfigured && !alreadySeen) open();
  }

  if(emailConfigured && !alreadySeen){
    if(!onboardingSeen){
      document.addEventListener('onboarding:finished',tryAutoOpen,{once:true});
    }else{
      requestAnimationFrame(tryAutoOpen);
    }
  }
})();
</script>
