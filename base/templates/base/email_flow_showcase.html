<!-- email_flow_showcase.html -->
<div id="emailFlowShowcase" class="efs" role="dialog" aria-modal="true" aria-labelledby="efs-title" hidden>
    <div class="efs__backdrop" data-efs-close aria-hidden="true"></div>
  
    <div class="efs__dialog" role="document">
      <!-- Header -->
      <div class="efs__head">
        <h3 id="efs-title">How applying works</h3>
        <button class="efs__close" type="button" aria-label="Close" data-efs-close>×</button>
      </div>
  
      <!-- Timeline progress -->
      <div class="efs__progress" aria-hidden="true">
        <span class="efs__bar"></span>
      </div>
  
      <!-- Stage -->
      <div class="efs__stage">
        <!-- Swipe demo card + hand -->
        <div class="efs-card" aria-hidden="true">
          <div class="efs-card__logo"></div>
          <div class="efs-card__meta">
            <div class="l l1"></div>
            <div class="l l2"></div>
          </div>
          <div class="efs-hand">
            <svg viewBox="0 0 64 64" width="54" height="54" aria-hidden="true">
              <path fill="currentColor" d="M38 6a6 6 0 0 0-6 6v10h-1V9a5 5 0 0 0-10 0v16h-1V14a5 5 0 0 0-10 0v24c0 9 7 16 16 16h13c8 0 13-6 13-13V20a5 5 0 0 0-10 0v3h-1V12a6 6 0 0 0-6-6z"/>
            </svg>
          </div>
          <div class="efs-swipe-arrow">→</div>
        </div>
  
        <!-- Phone compose mock -->
        <div class="efs-phone" aria-label="Email compose demo">
          <div class="efs-phone__top">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
  
          <div class="efs-compose">
            <div class="efs-row"><span class="k">To</span><span class="v">hiring@company.com</span></div>
            <div class="efs-row"><span class="k">Subject</span>
              <span class="v">Application: {{ request.user.first_name|default:"You" }}</span>
            </div>
  
            <!-- AI drafting -->
            <div class="efs-ai">
              <div class="efs-ai__chip">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                  <path d="M12 2l3 4 5 1-3 4 .5 5-5-2-5 2 .5-5-3-4 5-1 3-4z" fill="currentColor" />
                </svg>
                <span>AI drafting…</span>
                <span class="sparkle" aria-hidden="true"></span>
              </div>
              <div class="efs-typed">
                <div class="t" style="--ch:38">Dear Hiring Team, I’m excited to apply for</div>
                <div class="t" style="--ch:44">the {{ rooms.0.role|default:"role" }} at {{ rooms.0.company_name|default:"your company" }}.</div>
                <div class="t" style="--ch:36">My background in {{ rooms.0.job_title|default:"the field" }}</div>
                <div class="t" style="--ch:30">aligns with your needs. Please find</div>
                <div class="t" style="--ch:25">my resume attached below.</div>
              </div>
            </div>
  
            <!-- attachment chip -->
            <div class="efs-attach">
              <div class="chip">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                  <path d="M21 12.5V7a5 5 0 1 0-10 0v9a3 3 0 1 0 6 0V8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>Resume.pdf</span>
              </div>
            </div>
  
            <!-- send button / plane -->
            <div class="efs-sendrow">
              <button class="send" type="button" aria-label="Send email" disabled>
                <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                  <path d="M22 2 11 13" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                  <path d="M22 2 15 22 11 13 2 9 22 2z" stroke="currentColor" stroke-width="2" fill="none" stroke-linejoin="round"/>
                </svg>
                <span>Send</span>
              </button>
              <div class="efs-plane" aria-hidden="true">
                <svg viewBox="0 0 64 24" width="120" height="48">
                  <path d="M4 12h30" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".35"/>
                  <path d="M36 12l18-8-5 8 5 8-18-8z" fill="currentColor"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
  
        <!-- “Sent” toast -->
        <div class="efs-sent" role="status" aria-live="polite">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
          <span>Application sent!</span>
        </div>
      </div>
  
      <!-- Actions -->
      <div class="efs__actions">
        <button class="efs__btn efs__btn--ghost" type="button" data-efs-close>Skip</button>
        <button class="efs__btn efs__btn--primary" type="button" data-efs-close>Start swiping</button>
      </div>
    </div>
  </div>
  
  <style>
  /* ===== AI Email Flow Showcase ===== */
  .efs{position:fixed;inset:0;display:none;place-items:center;z-index:10050;font-family:'Manrope',sans-serif;}
  .efs[aria-m
  </style>
  
  <script>
  /**
   * Email Flow Showcase controller
   * Exposes window.EFS.open()/close()/reset()
   * Auto-opens after onboarding if email is configured (reads from <main data-email-configured="true">).
   */
  (function () {
    const overlay = document.getElementById('emailFlowShowcase');
    if (!overlay) return;
  
    const SEEN_KEY = 'if_email_flow_demo_shown';
    const qs = (sel, root = document) => root.querySelector(sel);
  
    function open() {
      // restart the timeline each time we open
      reset();
      overlay.hidden = false;
      overlay.classList.add('show');
      // kick the animation one frame later so CSS sees .show already applied
      requestAnimationFrame(() => overlay.classList.add('play'));
    }
  
    function close() {
      overlay.classList.remove('play', 'show');
      overlay.hidden = true;
      try { localStorage.setItem(SEEN_KEY, '1'); } catch {}
    }
  
    function reset() {
      // remove play to reset animated elements (progress bar, typing, etc.)
      overlay.classList.remove('play');
      // force reflow to clear animations
      void overlay.offsetHeight;
    }
  
    // Close handlers (backdrop, X button, footer buttons)
    overlay.addEventListener('click', (e) => {
      if (e.target.matches('[data-efs-close], .efs__backdrop, .efs__close')) {
        close();
      }
    });
  
    // Esc key closes
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !overlay.hidden) close();
    });
  
    // Public API (handy for debugging or manual triggers)
    window.EFS = {
      open, close, reset,
      shown: () => localStorage.getItem(SEEN_KEY) === '1'
    };
  
    // Optional manual trigger if a debug button exists
    document.getElementById('showEFSNow')?.addEventListener('click', () => {
      try { localStorage.removeItem(SEEN_KEY); } catch {}
      open();
    });
  
    // Auto-open logic:
    // - Only if email is configured AND not shown before.
    // - If onboarding is in progress, wait for custom event 'onboarding:finished'.
    const main = qs('main.layout');
    const emailConfigured = (main?.dataset.emailConfigured === 'true');
    const alreadySeen = (localStorage.getItem(SEEN_KEY) === '1');
    const onboardingSeen = (localStorage.getItem('if_seen_onboarding') === '1');
  
    function tryAutoOpen() {
      if (emailConfigured && !alreadySeen) open();
    }
  
    if (emailConfigured && !alreadySeen) {
      if (!onboardingSeen) {
        // wait for onboarding overlay to finish (your app should dispatch this event)
        document.addEventListener('onboarding:finished', tryAutoOpen, { once: true });
      } else {
        // open immediately on first paint
        requestAnimationFrame(tryAutoOpen);
      }
    }
  })();
  </script>