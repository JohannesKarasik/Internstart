{% extends 'main.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}

<!-- Manrope to match landing -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<main class="auth">

  {% if page == 'login' %}
  <!-- =======================
       LOGIN
  ======================== -->
  <section class="auth-shell">
    <div class="auth-card auth-card--split">
      <!-- Brand / intro -->
      <aside class="auth-side">
        <div class="auth-side__inner">
          <h2 class="auth-side__title">Welcome back üëã</h2>
          <p class="auth-side__copy">
            Pick up where you left off. Save roles, auto-apply, and track your progress ‚Äî all in one place.
          </p>
          <ul class="auth-side__bullets">
            <li>üîî Role alerts that match your skills</li>
            <li>‚≠ê Save & shortlist internships</li>
            <li>‚ö° One-tap applications</li>
          </ul>
        </div>
      </aside>

      <!-- Form -->
      <div class="auth-form">
        <header class="auth-form__header">
          {% if messages %}
  <div class="form__messages" style="margin:10px 0;">
    {% for message in messages %}
      <p class="form__error">{{ message }}</p>
    {% endfor %}
  </div>
{% endif %}
          <h1 class="auth-title">Login</h1>
          <p class="auth-sub">Your future internship awaits.</p>
        </header>

        <form method="POST" novalidate>
          {% csrf_token %}
          <div class="form-grid">
            <div class="form__group">
              <label class="form__label" for="username">Email</label>
              <input id="username" name="username" type="email" autocomplete="username" placeholder="you@school.edu" class="form__control" required>
                  </div>

            <div class="form__group">
              <label class="form__label" for="password">Password</label>
              <div class="form__controlWrap">
                <input id="password" name="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="form__control" required>
                <!-- low-key eye icon -->
                <button class="togglePwd" type="button" aria-label="Show password" title="Show password" data-state="show">
                  <!-- eye -->
                  <svg class="icon-eye" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                  <!-- eye-off -->
                  <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M3 3l18 18M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.08A10.46 10.46 0 0 1 12 5c7 0 11 7 11 7a18.46 18.46 0 0 1-3.22 3.72M6.12 6.12A18.42 18.42 0 0 0 1 12s4 7 11 7a10.6 10.6 0 0 0 3.88-.72"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <button class="btn btn--primary btn--block" type="submit">Login</button>
        </form>

        <footer class="auth-alt">
          <span>New to Internstart?</span>
          <a href="{% url 'register' %}" class="link">Create an account</a>
        </footer>
      </div>
    </div>
  </section>

  {% else %}
  <!-- =======================
       REGISTER (2-step) ‚Äî Split layout like Login
       Left: brand/benefits + subtle AI visuals
       Right: two-stage form
  ======================== -->
  <section class="auth-shell">
    <div class="auth-card auth-card--split">
      <!-- Left side -->
      <aside class="auth-side auth-side--register">
        <div class="auth-side__inner">
          <div class="ai-badge">AI-powered profile</div>
          <h2 class="auth-side__title">Create your profile ‚ú®</h2>
          <p class="auth-side__copy">
            One profile. Smarter matches. Lightning-fast applications.
          </p>
          <ul class="auth-side__bullets">
            <li>ü§ñ Tailored role matches</li>
            <li>üìÑ Parse your resume in seconds</li>
            <li>üì¨ Track every application</li>
          </ul>

          <!-- Decorative "AI nodes" -->
          <div class="ai-orbit">
            <span class="node n1"></span>
            <span class="node n2"></span>
            <span class="node n3"></span>
            <span class="node n4"></span>
          </div>
        </div>
      </aside>

      <!-- Right side (Form) -->
      <div class="auth-form">
        <header class="auth-form__header auth-form__header--card">
          {% if messages %}
          <div class="form__messages" style="margin:10px 0;">
            {% for message in messages %}
              <p class="form__error">{{ message }}</p>
            {% endfor %}
          </div>
        {% endif %}
          <h1 class="auth-title">Join Internstart</h1>
          <p class="auth-sub">It takes under a minute ‚Äî we‚Äôll guide you.</p>

          <!-- stepper + progress -->
          <div class="stepper stepper--tight" aria-label="Registration progress">
            <div class="stepper__item is-active" data-step-index="1">
              <span class="stepper__dot"></span><span class="stepper__label">Account</span>
            </div>
            <div class="stepper__sep"></div>
            <div class="stepper__item" data-step-index="2">
              <span class="stepper__dot"></span><span class="stepper__label">Resume</span>
            </div>
          </div>
          <div class="progressbar" aria-hidden="true"><span id="regProgress" style="width:50%"></span></div>
        </header>

        <form method="POST" enctype="multipart/form-data" class="auth-form" id="registerForm" novalidate>
          {% csrf_token %}

          <!-- ========== STEP 1: Account ========== -->
          <div class="form-step is-active" id="step-1" data-step="1" role="group" aria-labelledby="step1label">
            <h2 id="step1label" class="sr-only">Account details</h2>
            <div class="form-grid form-grid--2">
              <!-- Full name (support both field names) -->
              {% if student_form.full_name %}
                <div class="form__group{% if student_form.full_name.errors %} form__group--error{% endif %}">
                  <label class="form__label" for="{{ student_form.full_name.id_for_label }}">{{ student_form.full_name.label }}</label>
                  {{ student_form.full_name|add_class:"form__control"|attr:"placeholder=Your full name"|attr:"autocomplete=name" }}
                  {% if student_form.full_name.errors %}
                    <small class="form__error">{{ student_form.full_name.errors|striptags }}</small>
                  {% endif %}
                </div>
              {% else %}
                {% if student_form.name %}
                  <div class="form__group{% if student_form.name.errors %} form__group--error{% endif %}">
                    <label class="form__label" for="{{ student_form.name.id_for_label }}">{{ student_form.name.label }}</label>
                    {{ student_form.name|add_class:"form__control"|attr:"placeholder=Your full name"|attr:"autocomplete=name" }}
                    {% if student_form.name.errors %}
                      <small class="form__error">{{ student_form.name.errors|striptags }}</small>
                    {% endif %}
                  </div>
                {% endif %}
              {% endif %}

              <!-- Email -->
              <div class="form__group{% if student_form.email.errors %} form__group--error{% endif %}">
                <label class="form__label" for="{{ student_form.email.id_for_label }}">{{ student_form.email.label }}</label>
                {{ student_form.email|add_class:"form__control"|attr:"placeholder=you@school.edu"|attr:"autocomplete=email" }}
                {% if student_form.email.errors %}
                  <small class="form__error">{{ student_form.email.errors|striptags }}</small>
                {% endif %}
              </div>

              <!-- Password -->
              <div class="form__group{% if student_form.password1.errors %} form__group--error{% endif %}">
                <label class="form__label" for="{{ student_form.password1.id_for_label }}">{{ student_form.password1.label }}</label>
                <div class="form__controlWrap">
                  {{ student_form.password1|add_class:"form__control"|attr:"placeholder=Create a password"|attr:"autocomplete=new-password" }}
                  <button class="togglePwd" type="button" aria-label="Show password" title="Show password" data-state="show">
                    <svg class="icon-eye" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M3 3l18 18M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.08A10.46 10.46 0 0 1 12 5c7 0 11 7 11 7a18.46 18.46 0 0 1-3.22 3.72M6.12 6.12A18.42 18.42 0 0 0 1 12s4 7 11 7a10.6 10.6 0 0 0 3.88-.72"/>
                    </svg>
                  </button>
                </div>
                {% if student_form.password1.help_text %}
                  <small class="form__help">{{ student_form.password1.help_text }}</small>
                {% endif %}
                {% if student_form.password1.errors %}
                  <small class="form__error">{{ student_form.password1.errors|striptags }}</small>
                {% endif %}
              </div>

              <!-- Confirm Password -->
              <div class="form__group{% if student_form.password2.errors %} form__group--error{% endif %}">
                <label class="form__label" for="{{ student_form.password2.id_for_label }}">{{ student_form.password2.label }}</label>
                <div class="form__controlWrap">
                  {{ student_form.password2|add_class:"form__control"|attr:"placeholder=Confirm password"|attr:"autocomplete=new-password" }}
                  <button class="togglePwd" type="button" aria-label="Show password" title="Show password" data-state="show">
                    <svg class="icon-eye" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M3 3l18 18M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.08A10.46 10.46 0 0 1 12 5c7 0 11 7 11 7a18.46 18.46 0 0 1-3.22 3.72M6.12 6.12A18.42 18.42 0 0 0 1 12s4 7 11 7a10.6 10.6 0 0 0 3.88-.72"/>
                    </svg>
                  </button>
                </div>
                {% if student_form.password2.errors %}
                  <small class="form__error">{{ student_form.password2.errors|striptags }}</small>
                {% endif %}
              </div>
            </div>

            <div class="wizard-actions">
              <button type="button" class="btn btn--primary btn--block" id="toStep2">
                Continue
              </button>
            </div>
          </div>

          <!-- ========== STEP 2: Resume ========== -->
          <div class="form-step" id="step-2" data-step="2" role="group" aria-labelledby="step2label">
            <h2 id="step2label" class="sr-only">Upload resume</h2>

            <!-- Drag-drop styled wrapper -->
            <div class="form-grid">
              {% if student_form.resume %}
                <div class="form__group{% if student_form.resume.errors %} form__group--error{% endif %}">
                  <label class="form__label" for="{{ student_form.resume.id_for_label }}">{{ student_form.resume.label }}</label>

                  <div class="dropzone" id="resumeDrop">
                    <div class="dz-icon">üìÑ</div>
                    <div class="dz-copy">
                      <strong>Drag & drop</strong> your resume here<br>
                      <span class="dz-sub">or click to browse (PDF/DOCX)</span>
                    </div>
                    <!-- Use the actual Django field; we visually style the container -->
                    {{ student_form.resume|add_class:"form__control dz-input"|attr:"accept=.pdf,.doc,.docx" }}
                  </div>

                  <small class="form__help" id="resumeFileName">No file chosen</small>

                  {% if student_form.resume.help_text %}
                    <small class="form__help">{{ student_form.resume.help_text }}</small>
                  {% endif %}
                  {% if student_form.resume.errors %}
                    <small class="form__error">{{ student_form.resume.errors|striptags }}</small>
                  {% endif %}
                </div>
              {% else %}
                <p class="form__help">Resume field missing from form ‚Äî add it to your Django form to enable uploads.</p>
              {% endif %}
            </div>

            <input type="hidden" name="step" id="regStep" value="1">

            <div class="wizard-actions wizard-actions--split">
              <button type="button" class="btn btn--ghost" id="backToStep1">Back</button>
              <button type="submit" class="btn btn--primary">Create account</button>
            </div>
          </div>

          <p class="auth-legal">By continuing you agree to our <a href="#" class="link">Terms</a> and <a href="#" class="link">Privacy Policy</a>.</p>

          <footer class="auth-alt auth-alt--center">
            <span>Already have an account?</span>
            <a href="{% url 'app_login' %}" class="link">Login</a>
          </footer>
        </form>
      </div>
    </div>
  </section>
  {% endif %}

</main>

<style>
/* ===== Theme (match landing) ===== */
:root{
  --brand:#FF2F5A;
  --brand-700:#e92650;
  --ink:#111;
  --ink-2:#1f2937;
  --muted:#667085;
  --bg:#0b0c10;
  --card:#ffffff;
  --ring: 0 0 0 3px rgba(255,47,90,.25);
  --radius:14px;
  --shadow-lg: 0 24px 60px rgba(16,24,40,.12);
  --shadow-md: 0 14px 28px rgba(16,24,40,.10);
  --font:'Manrope', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  --nav-h: 72px;

  /* AI gradient accents */
  --ai-1:#6366f1;
  --ai-2:#60a5fa;
  --ai-3:#34d399;
}
*{box-sizing:border-box}
body{font-family:var(--font); color:var(--ink)}

/* ===== Page shell ===== */
.auth{
  min-height: 100vh;
  background:
    radial-gradient(1200px 600px at 85% -10%, rgba(255,47,90,.06), transparent 60%),
    radial-gradient(1000px 500px at -10% 90%, rgba(59,130,246,.06), transparent 60%),
    #fafafb;
  padding-top: calc(var(--nav-h) + clamp(0px, 1vh, 12px));
}
.auth-shell{
  max-width: 1100px;
  padding-inline: clamp(24px, 4vw, 48px);
  margin: -10px auto clamp(40px, 6vh, 80px);
}

/* ===== Card ===== */
.auth-card{
  background: var(--card);
  border-radius: 18px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  border: 1px solid #f1f2f6;
}
.auth-card--split{
  display: grid;
  grid-template-columns: 1.05fr 1fr;
}
@media (max-width: 980px){
  .auth-card--split{ grid-template-columns: 1fr; }
}

/* ===== Left side / intro ===== */
.auth-side{
  position: relative;
  background:
    radial-gradient(1200px 500px at 10% -20%, rgba(255,47,90,.15), transparent 60%),
    linear-gradient(135deg, #fff 0%, #fff 35%, #FFE7EC 100%);
  padding: clamp(24px, 5vw, 40px);
  border-right: 1px solid #f1f2f6;
}
.auth-side--register{
  background:
    radial-gradient(900px 500px at 0% 0%, rgba(99,102,241,.18), transparent 60%),
    radial-gradient(900px 500px at 100% 100%, rgba(52,211,153,.15), transparent 60%),
    linear-gradient(135deg, #ffffff 0%, #ffffff 30%, #f8fafc 100%);
}
.auth-side__inner{ max-width: 500px }
.auth-side__title{
  font-size: clamp(24px, 3.4vw, 34px);
  font-weight: 800;
  margin: 8px 0 10px 0;
}
.ai-badge{
  display:inline-block; font-weight:800; letter-spacing:.2px;
  background: linear-gradient(135deg, var(--ai-1), var(--ai-2), var(--ai-3));
  -webkit-background-clip: text; background-clip: text; color: transparent;
  border: 1px solid rgba(99,102,241,.25);
  padding:6px 10px; border-radius: 999px; font-size:12px; background-color: rgba(99,102,241,.08);
}
.auth-side__copy{ color:var(--muted); margin: 0 0 14px }
.auth-side__bullets{ padding:0; margin:0; list-style:none; color:var(--ink-2); display:grid; gap:8px }

/* AI orbit decoration */
.ai-orbit{ position:absolute; right:24px; bottom:24px; width:160px; height:160px; border-radius:50%; filter: drop-shadow(0 20px 40px rgba(2,6,23,.15)); }
.ai-orbit .node{
  position:absolute; width:12px; height:12px; border-radius:999px; background: linear-gradient(135deg, var(--ai-2), var(--ai-3));
  box-shadow: 0 0 0 6px rgba(96,165,250,.18);
}
.n1{ left:0; top:50%; transform: translate(-30%, -50%); }
.n2{ right:10%; top:-6%; }
.n3{ right:-8%; bottom:30%; }
.n4{ left:20%; bottom:-8%; }

/* ===== Form container ===== */
.auth-form{ padding: clamp(22px, 4.2vw, 36px); background:#fff; }
.auth-form__header--card{
  padding: 24px clamp(20px, 4vw, 32px) 14px;
  border-bottom: 1px solid #f3f4f6;
}
.auth-title{ margin:0 0 6px 0; font-size: clamp(26px, 3.2vw, 32px); font-weight: 800; }
.auth-sub{ margin:0; color:var(--muted) }

/* Stepper + progress */
.stepper{ display:flex; align-items:center; justify-content:flex-start; gap:12px; margin-top:12px; }
.stepper--tight{ margin-top:8px; }
.stepper__sep{ flex:0 0 56px; height:2px; background:#eee; border-radius:2px; }
.stepper__item{ display:flex; align-items:center; gap:8px; color:#98a1b3; font-weight:800; font-size:13px; text-transform:uppercase; letter-spacing:.3px }
.stepper__dot{ width:10px; height:10px; border-radius:50%; background:#e5e7eb; box-shadow: inset 0 0 0 2px #fff, 0 0 0 2px #e5e7eb; }
.stepper__item.is-active{ color:#111; }
.stepper__item.is-active .stepper__dot{ background:var(--brand); box-shadow: inset 0 0 0 2px #fff, 0 0 0 2px rgba(255,47,90,.55); }

.progressbar{ margin-top:10px; width:100%; height:8px; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #eef0f3;}
.progressbar > span{
  display:block; height:100%; width:0%;
  background: linear-gradient(90deg, var(--ai-1), var(--ai-2), var(--ai-3));
  transition: width .25s ease;
}

/* Steps */
.form-step{ display:none; }
.form-step.is-active{ display:block; }
.wizard-actions{ margin-top:10px; }
.wizard-actions--split{ display:flex; gap:12px; justify-content:space-between; align-items:center; }

/* ===== Grid ===== */
.form-grid{ display:grid; gap:14px }
.form-grid--2{ grid-template-columns: repeat(2, minmax(220px,1fr)); gap:16px }
@media (max-width: 720px){ .form-grid--2{ grid-template-columns: 1fr } }

/* ===== Inputs ===== */
.form__group{ display:flex; flex-direction:column; gap:6px }
.form__label{ font-weight:700; font-size:13px; color:#2b2f36 }
.form__control{
  width:100%; height:46px; padding:0 12px;
  border-radius: 12px; border:1px solid #e5e7eb; background:#fff;
  font: 500 15px/1.2 var(--font); color: var(--ink);
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.form__control:hover{ background:#f9fafb }
.form__control:focus{ outline:none; border-color: var(--brand); box-shadow: var(--ring) }
.form__control::placeholder{ color:#9aa1ad }

.form__controlWrap{ position:relative }
.form__controlWrap .form__control{ padding-right: 44px }
.togglePwd{
  position:absolute; right:8px; top:50%; transform: translateY(-50%);
  width:34px; height:34px; border-radius:10px; border:none; background:transparent; cursor:pointer;
  display:grid; place-items:center;
}
.togglePwd svg{ width:20px; height:20px; stroke:#9aa1ad; }
.togglePwd:hover svg{ stroke:#6b7280; }
.icon-eye-off{ display:none; }
.togglePwd[data-state="hide"] .icon-eye{ display:none; }
.togglePwd[data-state="hide"] .icon-eye-off{ display:block; }

textarea.form__control{ height:auto; min-height:110px; padding:10px 12px; resize: vertical; }
.form__group textarea{ grid-column: 1 / -1 }

/* File/Dropzone */
.dropzone{
  position: relative;
  display:flex; align-items:center; justify-content:flex-start; gap:14px;
  border:1.5px dashed #d7dbe2; border-radius: 14px; padding:16px 14px;
  background: linear-gradient(180deg, #fff, #fbfcff);
  transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
}
.dropzone:hover{ border-color:#c9cfda; box-shadow: 0 10px 24px rgba(16,24,40,.06); }
.dz-icon{ font-size:24px }
.dz-copy{ font-size:14px; color:#475569 }
.dz-sub{ color:#94a3b8; font-weight:600; }
.dz-input{
  position:absolute; inset:0; opacity:0; cursor:pointer; height:100% !important; width:100% !important; padding:0 !important;
}

/* Help & error text */
.form__help{ color:#80889a; font-size:12px; margin-top:6px }
.form__help.is-hidden{ display:none !important; }
.form__error{ color:#dc2626; font-size:13px; margin-top:-2px }
.form__group--error .form__control{ border-color:#dc2626; box-shadow: 0 0 0 3px rgba(220,38,38,.1) }

/* Buttons & links */
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  height:52px; padding:0 20px; border-radius: 12px;
  font-weight: 800; letter-spacing:.2px; border:1px solid transparent; cursor:pointer;
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
}
.btn--primary{ background:var(--brand); color:#fff; box-shadow: 0 12px 24px rgba(255,47,90,.20) }
.btn--primary:hover{ transform: translateY(-1px); box-shadow: 0 16px 32px rgba(255,47,90,.28); background: var(--brand-700) }
.btn--ghost{ background:#f5f5f5; color:#111; }
.btn--ghost:hover{ background:#efefef; }
.btn--block{ width:100%; margin-top: 8px }
.link{ color: var(--brand); font-weight: 700; text-decoration: none }
.link:hover{ text-decoration: underline }
.auth-legal{ margin: 12px 0 0 0; text-align:center; color:var(--muted); font-size:14px; }
.auth-alt{ margin-top: 14px; display:flex; gap:8px; align-items:center; justify-content:center; color:var(--muted); }

/* Accessibility helper */
.sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
</style>

<script>
/* Add classes to Django widgets if the add_class filter isn't installed site-wide */
(function(){
  document.querySelectorAll('.form__group :is(input,select,textarea):not(.form__control)')
    .forEach(el => el.classList.add('form__control'));
})();

/* Password visibility toggle(s) */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.togglePwd');
  if (!btn) return;
  const input = btn.previousElementSibling;
  if (!input) return;
  const isPwd = input.type === 'password';
  input.type = isPwd ? 'text' : 'password';
  btn.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
  btn.setAttribute('title', isPwd ? 'Hide password' : 'Show password');
  btn.dataset.state = isPwd ? 'hide' : 'show';
});

/* Hide password help until needed */
(function(){
  const pwdInputs = document.querySelectorAll('#step-1 input[type="password"]');
  pwdInputs.forEach((input) => {
    const help = input.closest('.form__group')?.querySelector('.form__help');
    if (!help) return;
    help.classList.add('is-hidden');
    const validate = () => {
      const v = input.value || '';
      const tooShort = v.length > 0 && v.length < 8;
      const numericOnly = /^\d+$/.test(v) && v.length > 0;
      help.classList.toggle('is-hidden', !(tooShort || numericOnly));
    };
    input.addEventListener('input', validate);
    input.addEventListener('blur', validate);
  });
})();

/* Wizard logic (client-side 2-step) */
/* Wizard logic (client-side 2-step) */
(function(){
  const form   = document.getElementById('registerForm');
  const step1  = document.getElementById('step-1');
  const step2  = document.getElementById('step-2');
  const toStep2Btn = document.getElementById('toStep2');
  const backBtn    = document.getElementById('backToStep1');
  const stepper = document.querySelectorAll('.stepper__item');
  const progress = document.getElementById('regProgress');
  const stepInput = document.getElementById('regStep'); // <input name="step" id="regStep" value="1">

  const goTo = (step) => {
    step1.classList.toggle('is-active', step === 1);
    step2.classList.toggle('is-active', step === 2);
    stepper.forEach(el => el.classList.toggle('is-active', Number(el.dataset.stepIndex) === step));
    if (progress) progress.style.width = step === 1 ? '50%' : '100%';
    if (stepInput) stepInput.value = String(step); // <-- keep hidden step in sync
    const first = (step === 1 ? step1 : step2).querySelector('input,select,textarea,button');
    if (first) setTimeout(() => first.focus({preventScroll:true}), 50);
  };
  window.__authWizardGoTo = goTo;

  const step1Valid = () => {
    const controls = step1.querySelectorAll('input,select,textarea');
    for (const el of controls) {
      if (!el.checkValidity()) { el.reportValidity(); return false; }
    }
    const p1 = step1.querySelector('input[name$="password1"]');
    const p2 = step1.querySelector('input[name$="password2"]');
    if (p1 && p2 && p1.value !== p2.value) {
      p2.setCustomValidity("Passwords don't match");
      p2.reportValidity();
      p2.addEventListener('input', () => p2.setCustomValidity(''), { once:true });
      return false;
    }
    return true;
  };

  // Make the "Continue" button switch to step 2 (no submit here)
  toStep2Btn?.addEventListener('click', (e) => {
    e.preventDefault();
    if (step1Valid()) goTo(2);
  });

  // Back button
  backBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    goTo(1);
  });

  // If user presses Enter on step 1, go to step 2 instead of submitting
  form?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && step1.classList.contains('is-active')) {
      e.preventDefault();
      toStep2Btn?.click();
    }
  });

  // If server wants to land on step 2 (e.g., errors)
  const goToStep2 = "{{ show_step2|default:'False' }}" === "True";
  if (goToStep2) goTo(2); else goTo(1);
})();

/* Resume dropzone filename preview + drag hover */
(function(){
  const dz = document.getElementById('resumeDrop');
  if (!dz) return;
  const input = dz.querySelector('input[type="file"]');
  const label = document.getElementById('resumeFileName');

  input.addEventListener('change', () => {
    const f = input.files && input.files[0];
    label.textContent = f ? `Selected: ${f.name}` : 'No file chosen';
  });

  ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => {
    e.preventDefault(); e.stopPropagation();
    dz.style.borderColor = '#9aa7b7';
    dz.style.background = 'linear-gradient(180deg, #fff, #f6f9ff)';
  }));
  ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => {
    e.preventDefault(); e.stopPropagation();
    dz.style.borderColor = '#d7dbe2';
    dz.style.background = 'linear-gradient(180deg, #fff, #fbfcff)';
  }));
  dz.addEventListener('drop', (e) => {
    if (!e.dataTransfer?.files?.length) return;
    input.files = e.dataTransfer.files;
    input.dispatchEvent(new Event('change', {bubbles:true}));
  });
})();
</script>

{% endblock content %}
