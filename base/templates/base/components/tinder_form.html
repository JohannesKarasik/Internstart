{# base/templates/components/tinder_form.html #}
{% load static i18n %}

<!-- Font (safe to include inside component; browsers dedupe) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">

<!-- =========================
     APPLY DEMO (Tinder cards + AI Form)
========================= -->
<section class="social-proof" id="social-proof">
  <div class="sp__inner">
    <header class="sp__head">
      <h2 class="sp__title">
        <span id="spTitle"
              data-default="{% trans 'Do like everyone else — apply with AI' %}"
              data-left="{% trans 'Swipe left to dismiss' %}"
              data-right="{% trans 'Swipe right to apply' %}">
          {% trans "Do like everyone else — apply with AI" %}
        </span>
      </h2>
      <p class="sp__sub">
        {% trans "Real students auto-applying to dozens of roles in minutes." %}
      </p>
    </header>

    <div class="demo-stage">
      <!-- floating explainer that moves depending on what’s visible -->
      <div class="demo-overlay" aria-live="polite">
        <span class="demo-overlay__text" role="status" aria-atomic="true"></span>
      </div>

      <!-- Tinder-style card deck -->
      <div class="tinder-section" hidden aria-label="{% trans 'Automatic swipe demo' %}">
        <div class="tinder-deck" data-autoplay="true">
          <!-- Card 1 -->
          <article class="card card--pink">
            <div class="card__body">
              <div class="card__info">
                <img src="{% static 'images/Goldman-Sachs-1869.png' %}" alt="Goldman Sachs logo" class="card__logo">
                <h4 class="card__role">{% trans "Investment Banking Intern" %}</h4>
                <h3 class="card__company">Goldman Sachs</h3>
                <p class="card__meta">{% trans "Location: New York, NY" %}</p>
              </div>
              <div class="card__actions" aria-label="{% trans 'Card actions' %}">
                <button type="button" class="action action--dismiss" aria-label="{% trans 'Dismiss' %}">{% trans "Dismiss" %}</button>
                <button type="button" class="action action--apply"   aria-label="{% trans 'Apply' %}">{% trans "Apply" %}</button>
              </div>
            </div>
          </article>

          <!-- Card 2 -->
          <article class="card card--blue">
            <div class="card__body">
              <div class="card__info">
                <img src="{% static 'images/danske-bank.png' %}" alt="Danske Bank logo" class="card__logo">
                <h4 class="card__role">{% trans "Corporate Finance Intern" %}</h4>
                <h3 class="card__company">Danske Bank</h3>
                <p class="card__meta">{% trans "Location: Copenhagen, Denmark" %}</p>
              </div>
              <div class="card__actions" aria-label="{% trans 'Card actions' %}">
                <button type="button" class="action action--dismiss" aria-label="{% trans 'Dismiss' %}">{% trans "Dismiss" %}</button>
                <button type="button" class="action action--apply"   aria-label="{% trans 'Apply' %}">{% trans "Apply" %}</button>
              </div>
            </div>
          </article>

          <!-- Card 3 -->
          <article class="card card--yellow">
            <div class="card__body">
              <div class="card__info">
                <img src="{% static 'images/deutsche-bank.png' %}" alt="Deutsche Bank logo" class="card__logo">
                <h4 class="card__role">{% trans "Global Markets Intern" %}</h4>
                <h3 class="card__company">Deutsche Bank</h3>
                <p class="card__meta">{% trans "Location: Frankfurt, Germany" %}</p>
              </div>
              <div class="card__actions" aria-label="{% trans 'Card actions' %}">
                <button type="button" class="action action--dismiss" aria-label="{% trans 'Dismiss' %}">{% trans "Dismiss" %}</button>
                <button type="button" class="action action--apply"   aria-label="{% trans 'Apply' %}">{% trans "Apply" %}</button>
              </div>
            </div>
          </article>
        </div>
      </div>

      <!-- AI Autofill Form -->
      <div class="ai-demo" hidden role="region" aria-label="{% trans 'AI auto-filling a job application' %}">
        <div class="ai-demo__window">
          <div class="ai-demo__chrome">
            <div class="ai-demo__dots"><span></span><span></span><span></span></div>
            <div class="ai-demo__title">
              {% trans "Job Application — Preview" %}
              <span id="ai-chip" class="ai-chip">{% trans "AI" %}</span>
            </div>
            <div class="ai-demo__progress">
              <div class="ai-demo__bar"></div><span class="ai-demo__pct">0%</span>
            </div>
          </div>

          <form class="ai-form" autocomplete="off" aria-describedby="ai-status">
            <div class="ai-field">
              <label for="ai-name">{% trans "Full name" %}</label>
              <input id="ai-name" type="text" placeholder="{% trans 'e.g., Ava Jensen' %}" inputmode="text" />
              <div class="ai-field__check" aria-hidden="true">✓</div>
            </div>

            <div class="ai-field">
              <label for="ai-email">{% trans "Email" %}</label>
              <input id="ai-email" type="email" placeholder="name@university.dk" />
              <div class="ai-field__check" aria-hidden="true">✓</div>
            </div>

            <div class="ai-field">
              <label for="ai-portfolio">{% trans "Portfolio / LinkedIn" %}</label>
              <input id="ai-portfolio" type="url" placeholder="https://…" />
              <div class="ai-field__check" aria-hidden="true">✓</div>
            </div>

            <div class="ai-field ai-field--file">
              <label for="ai-resume">{% trans "Resume" %}</label>
              <input id="ai-resume" type="file" accept=".pdf,.doc,.docx,.rtf" hidden>
              <div class="ai-file">
                <button type="button" class="ai-file__btn">{% trans "Attach resume" %}</button>
                <span class="ai-file__name" data-empty="{% trans 'No file selected' %}">{% trans "No file selected" %}</span>
              </div>
              <div class="ai-upload" aria-hidden="true"><div class="ai-upload__bar"></div></div>
              <div class="ai-field__check" aria-hidden="true">✓</div>
            </div>

            <div class="ai-field ai-field--textarea">
              <label for="ai-cover">{% trans "Short cover note" %}</label>
              <textarea id="ai-cover" rows="4" placeholder="{% trans 'A few sentences…' %}"></textarea>
              <div class="ai-field__check" aria-hidden="true">✓</div>
            </div>

            <div class="ai-consent">
              <input id="ai-consent" type="checkbox" />
              <label for="ai-consent">{% trans "I consent to submit this application." %}</label>
            </div>

            <div class="ai-actions">
              <button type="button" class="btn btn--primary ai-submit" disabled>{% trans "Apply now" %}</button>
            </div>

            <p id="ai-status" class="ai-status" aria-live="polite">{% trans "AI is preparing your application…" %}</p>
          </form>
        </div>
      </div>
    </div><!-- /.demo-stage -->
  </div>
</section>

<style>
/* ===== Base tokens (scoped-friendly) ===== */
:root{
  --font:'Manrope',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --brand:#FF2F5A; --accent:#3B82F6; --ok:#10B981;
  --text:#111; --muted:#667085; --line:#e7edf5;
  --container-max: 1480px;
  --card-w: clamp(360px, 30vw, 440px);
  --card-h: 600px;
  --card-pad: 28px;
  --action-gap: 14px;
}

/* ===== Section chrome / background ===== */
.social-proof{
  position:relative; isolation:isolate;
  padding: clamp(56px,8vw,110px) 0 clamp(40px,6vw,80px);
  background: linear-gradient(180deg,#fff 0%,#fbfcff 55%,#f6f8fc 100%);
  border-top:1px solid #eef2f7;
}
.sp__inner{ max-width: var(--container-max); margin:0 auto; padding:0 16px; display:flex; flex-direction:column; align-items:center; position:relative; }
.sp__head{ text-align:center; margin-bottom:22px; }
.sp__title{ margin:0; font: 900 clamp(22px,3vw,34px)/1 var(--font); color:#101828; letter-spacing:-.3px; }
.sp__sub{ margin:.5rem 0 0; color:var(--muted); font: 500 clamp(14px,1.6vw,16px)/1.5 var(--font); }

/* subtle grid + glows */
.social-proof::before,
.social-proof::after{
  content:""; position:absolute; inset:0; pointer-events:none; z-index:-1;
}
.social-proof::before{
  background-image:
    linear-gradient(to right, #e9edf5 1px, transparent 1px),
    linear-gradient(to bottom, #e9edf5 1px, transparent 1px);
  background-size:64px 64px,64px 64px; opacity:.35;
  mask-image: radial-gradient(130% 120% at 50% 10%, #000 55%, transparent 100%);
}
.social-proof::after{
  background-image:
    linear-gradient(to right, #eef2f7 1px, transparent 1px),
    linear-gradient(to bottom, #eef2f7 1px, transparent 1px);
  background-size:16px 16px,16px 16px; opacity:.12;
  mask-image: radial-gradient(140% 120% at 50% 0%, #000 40%, transparent 100%);
}

/* ===== Demo stage ===== */
.demo-stage{ position:relative; width:100%; min-height: var(--card-h); }
.demo-overlay{
  position:absolute; z-index:5; pointer-events:none; color:#667085; font: 700 14px/1.35 var(--font); max-width:220px;
}
.demo-overlay__text{ display:block; opacity:0; transform:translateY(-4px); transition:.35s; }
.demo-overlay__text.is-visible{ opacity:1; transform:none; }
/* beside deck (left/right) */
.demo-overlay.is-deck-left{ top:50%; right:50%; margin-right: calc(var(--card-w)/2 + 22px); transform: translateY(-50%); text-align:right; }
.demo-overlay.is-deck-right{ top:50%; left:50%; margin-left: calc(var(--card-w)/2 + 22px); transform: translateY(-50%); text-align:left; }
/* over form */
.demo-overlay.is-form{ left:50%; top: calc(50% - var(--card-h)/2 - 28px); transform: translateX(-50%); width:100%; text-align:center; }

/* ===== Tinder cards ===== */
.tinder-section{ margin:0; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2; }
.tinder-deck{ position:relative; width: var(--card-w); min-height: var(--card-h); margin:0 auto; perspective:1200px; }
.card{ width:var(--card-w); height:var(--card-h); background:#fff; border-radius:24px; box-shadow:0 24px 50px rgba(0,0,0,.22); }
.card__body{ height:100%; padding:var(--card-pad); display:flex; flex-direction:column; align-items:center; justify-content:space-between; text-align:center; }
.card__info{ display:flex; flex-direction:column; align-items:center; margin-top:40px; flex:1 0 auto; }
.card__logo{ max-width:240px; max-height:140px; object-fit:contain; margin-bottom:22px; }
.card__role{ font:600 18px/1.3 var(--font); color:#4b5563; margin:8px 0 6px; }
.card__company{ font:800 22px/1.2 var(--font); color:#2F4858; margin:2px 0; }
.card__meta{ font:500 15px/1.2 var(--font); color:#6b7280; }
.card--pink{ background:#FFE7EC; }
.card--blue{ background:#E7F0FF; }
.card--yellow{ background:#FFF9E6; }
.tinder-deck .card{ position:absolute; top:0; left:50%; transform:translateX(-50%); opacity:0; pointer-events:none; transition: transform .6s ease, opacity .35s ease, filter .35s ease; }
.tinder-deck .card.is-top{ opacity:1; pointer-events:auto; z-index:3; transform: translateX(-50%); }
.tinder-deck .card.is-next{ opacity:1; z-index:2; transform: translateX(-50%) translateY(12px) scale(.992); box-shadow:0 14px 32px rgba(0,0,0,.14); }
@keyframes tSwipeLeft{ to{ transform: translateX(calc(-50% - 740px)); opacity:0; } }
@keyframes tSwipeRight{ to{ transform: translateX(calc(-50% + 740px)); opacity:0; } }
.tinder-deck{ --swipe-duration:1.8s; }
.tinder-deck .card.swipe-left{ animation: tSwipeLeft var(--swipe-duration) cubic-bezier(.22,.61,.36,1) forwards; }
.tinder-deck .card.swipe-right{ animation: tSwipeRight var(--swipe-duration) cubic-bezier(.22,.61,.36,1) forwards; }
.card__actions{ display:flex; gap:var(--action-gap); justify-content:center; margin-top:auto; padding-bottom:22px; }
.action{ height:48px; min-width:116px; padding:0 16px; border-radius:999px; background:#fff; border:1.5px solid #e5e7eb; box-shadow:0 2px 6px rgba(0,0,0,.12); font:800 14px/1 var(--font); color:#111; transition:.15s; }
.action.is-pressed{ transform:scale(.96); box-shadow: inset 0 2px 0 rgba(0,0,0,.02), 0 1px 2px rgba(0,0,0,.06); }
.action--dismiss{ color:#EF4444; border-color:#FECACA; }
.action--apply{ color:#10B981; border-color:#A7F3D0; }

/* ===== AI form ===== */
.ai-demo{ --ai-w:760px; --ai-pad:18px; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1; }
@media (max-width:900px){ .ai-demo{ --ai-w:520px; } }
@media (max-width:600px){ .ai-demo{ --ai-w:100%; left:0; transform:none; } }
.ai-demo__window{ width:100%; max-width:var(--ai-w); border:1px solid #e5e7eb; border-radius:16px; background:#fff; box-shadow:0 18px 40px rgba(0,0,0,.12); overflow:hidden; transition: opacity .35s ease, transform .35s ease; }
.ai-demo__chrome{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; padding:8px 10px; background:linear-gradient(180deg,#f8fafc 0%, #eef2f7 100%); border-bottom:1px solid #e5e7eb; }
.ai-demo__dots span{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; background:#ff5f56; }
.ai-demo__dots span:nth-child(2){ background:#ffbd2e; } .ai-demo__dots span:nth-child(3){ background:#27c93f; }
.ai-demo__title{ font:700 14px/1 var(--font); color:#111; display:flex; align-items:center; gap:8px; }
.ai-demo__progress{ display:flex; align-items:center; gap:8px; }
.ai-demo__bar{ --pct:0%; width:96px; height:6px; border-radius:999px; background:#e5e7eb; position:relative; overflow:hidden; }
.ai-demo__bar::after{ content:""; position:absolute; inset:0 auto 0 0; width:var(--pct); background:linear-gradient(90deg,var(--ok),var(--accent)); transition:width .25s ease; }
.ai-demo__pct{ font:500 11px/1 var(--font); color:#374151; min-width:32px; text-align:right; }
.ai-form{ padding:14px var(--ai-pad) 18px; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px 16px; font-family:var(--font); }
.ai-field{ position:relative; display:grid; grid-template-columns:1fr 28px; grid-template-rows:auto auto; gap:6px 8px; }
.ai-field label{ grid-column:1/-1; font:600 12px/1 var(--font); color:#6b7280; }
.ai-field input,.ai-field textarea{ grid-column:1; width:100%; padding:12px; font: 500 14px/1.35 var(--font); border-radius:12px; border:1px solid #e5e7eb; outline:none; transition:.2s; }
.ai-field--textarea{ grid-column:1/-1; }
.ai-field--textarea textarea{ min-height:140px; resize:vertical; padding:16px 16px 20px 14px; }
.ai-field.is-active input,.ai-field.is-active textarea{ border-color: rgba(59,130,246,.6); box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
.ai-field.is-done input,.ai-field.is-done textarea{ border-color: rgba(16,185,129,.6); box-shadow: 0 0 0 3px rgba(16,185,129,.12); background:#f7fffb; }
.ai-field__check{ grid-column:2; width:22px; height:22px; border-radius:50%; background:var(--ok); color:#fff; display:grid; place-items:center; font-weight:700; transform:scale(.6); opacity:0; transition:.18s; }
.ai-field.is-done .ai-field__check{ transform:scale(1); opacity:1; }
.ai-file{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.ai-file__btn{ height:36px; padding:0 14px; border-radius:10px; background:#fff; border:1.5px solid #e5e7eb; color:#111; font:700 13px/1 var(--font); box-shadow:0 1px 3px rgba(0,0,0,.08); transition:.15s; }
.ai-file__btn.is-pressed{ transform:scale(.97); background:#ECFDF5; border-color:#A7F3D0; color:#059669; }
.ai-file__name{ flex:1; text-align:right; font: 500 13px/1 var(--font); color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ai-upload{ --up:0%; height:6px; border-radius:999px; background:#eef2f7; overflow:hidden; margin-top:8px; opacity:0; transition:.2s; }
.ai-upload.is-visible{ opacity:1; }
.ai-upload__bar{ width:var(--up); height:100%; background:linear-gradient(90deg,var(--ok),var(--accent)); transition:width .08s linear; }
.ai-consent{ grid-column:1/-1; display:flex; gap:10px; align-items:flex-start; margin:6px 0 10px; font:500 13px/1.4 var(--font); color:#374151; }
.ai-actions{ grid-column:1/-1; display:flex; gap:10px; flex-wrap:wrap; }
.btn{ display:inline-flex; align-items:center; justify-content:center; height:48px; padding:0 18px; border-radius:12px; font:700 16px/1 var(--font); border:1px solid transparent; text-decoration:none; }
.btn--primary{ background:var(--brand); color:#fff; box-shadow:0 4px 12px rgba(0,0,0,.08); }
.ai-status{ grid-column:1/-1; margin-top:12px; font: 600 12px/1.4 var(--font); color:#475467; }
.ai-status::before{ content:""; display:inline-block; width:6px; height:6px; border-radius:50%; background:#22c55e; margin-right:8px; box-shadow:0 0 0 0 rgba(34,197,94,.7); animation:pulse 1.6s infinite; }
@keyframes pulse{ 70%{ box-shadow:0 0 0 8px rgba(34,197,94,0) } }
.ai-demo__window.is-fading{ opacity:0; transform: translateY(8px) scale(.98); }
.ai-success{ position:absolute; inset:0; display:grid; place-items:center; background: rgba(255,255,255,.55); backdrop-filter:blur(4px); opacity:0; visibility:hidden; pointer-events:none; transition:.25s; border-radius:16px; }
.ai-success.is-visible{ opacity:1; visibility:visible; pointer-events:auto; }
.ai-success__card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:24px 28px; width:min(92%,380px); text-align:center; box-shadow:0 12px 30px rgba(0,0,0,.14); }
.ai-success__icon svg{ width:56px; height:56px; }
.ai-success__icon .ring{ stroke:#A7F3D0; stroke-width:5; fill:none; opacity:.9; }
.ai-success__icon .mark{ stroke:#10B981; stroke-width:5; fill:none; stroke-linecap:round; stroke-linejoin:round; stroke-dasharray:60; stroke-dashoffset:60; animation: aiCheck .6s ease forwards .15s; }
@keyframes aiCheck{ to{ stroke-dashoffset:0; } }
.ai-demo__window.is-success{ border-color: rgba(16,185,129,.6); box-shadow: 0 0 0 3px rgba(16,185,129,.18), 0 18px 40px rgba(0,0,0,.12); }
.ai-form.is-success input,.ai-form.is-success textarea{ border-color: rgba(16,185,129,.7); background:#F0FDF4; }

@media (max-width:1024px){
  .demo-overlay{ top:auto !important; bottom:-18px; left:50% !important; right:auto !important; margin:0 !important; transform: translateX(-50%) !important; text-align:center; max-width:90vw; }
}
@media (max-width:640px){
  :root{ --card-w: 332px; --card-h: 520px; }
  .demo-stage{ border-radius:18px; }
}
@media (max-width:600px){
  .demo-overlay{ display:none; }
}
</style>

<script>
/* =========================
   A) Tinder controller (auto swipes + explainer)
========================= */
(() => {
  const ready = (fn) => (document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', fn, { once:true })
    : fn());

  ready(() => {
    const section = document.querySelector('.tinder-section');
    const deck    = document.querySelector('.tinder-deck');
    const overlay = document.querySelector('.demo-overlay');
    const overlayTextEl = document.querySelector('.demo-overlay__text');
    const titleSpan = document.getElementById('spTitle');
    if (!deck || !section || !overlay || !overlayTextEl || !titleSpan) return;

    const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
    const PAUSE = 1600, PRESS = 220;
    const pause = (ms) => new Promise(r => setTimeout(r, ms));

    const setExplainer = (key = 'default') => {
      const next = titleSpan.dataset[key] || titleSpan.dataset.default || titleSpan.textContent;
      titleSpan.textContent = next;
    };
    const setDeckSide = (side) => {
      overlay.classList.remove('is-form','is-deck-left','is-deck-right');
      overlay.classList.add(side === 'left' ? 'is-deck-left' : 'is-deck-right');
    };
    const showOverlayText = (text) => {
      overlayTextEl.textContent = text;
      overlayTextEl.classList.remove('is-visible');
      void overlayTextEl.offsetWidth; // restart transition
      overlayTextEl.classList.add('is-visible');
    };

    const setStack = () => {
      const cards = [...deck.querySelectorAll('.card')];
      cards.forEach(c => c.classList.remove('is-top','is-next'));
      cards.forEach((c,i) => c.style.zIndex = String(cards.length - i));
      if (cards[0]) cards[0].classList.add('is-top');
      if (cards[1]) cards[1].classList.add('is-next');
    };

    const swipeOnce = async (stepIndex, totalSteps) => {
      const top = deck.querySelector('.card.is-top') || deck.querySelector('.card');
      if (!top) return;

      const btnDismiss = top.querySelector('.action--dismiss');
      const btnApply   = top.querySelector('.action--apply');

      const direction = (stepIndex < totalSteps - 1) ? 'left' : 'right';
      const pressBtn  = direction === 'right' ? btnApply : btnDismiss;

      if (stepIndex < 1) {
        setDeckSide('left');
        showOverlayText('{{ _("Swipe left to dismiss") }}');
        setExplainer('left');
      }

      if (pressBtn) {
        pressBtn.classList.add('is-pressed');
        pressBtn.setAttribute('aria-pressed','true');
        await pause(PRESS);
        pressBtn.classList.remove('is-pressed');
        pressBtn.removeAttribute('aria-pressed');
      }

      top.classList.add(direction === 'right' ? 'swipe-right' : 'swipe-left');
      await new Promise(res => top.addEventListener('animationend', res, { once:true }));

      top.classList.remove('swipe-left','swipe-right','is-top');
      top.style.opacity = '0';
      deck.appendChild(top);
      setStack();

      if (stepIndex === 1) {
        await pause(500);
        setDeckSide('right');
        showOverlayText('{{ _("Swipe right to apply") }}');
        setExplainer('right');
      }
    };

    setStack();
    setDeckSide('left');
    setExplainer('default');

    window.TinderDemo = {
      count: () => deck.querySelectorAll('.card').length,
      setVisible: (show) => {
        if (show) {
          section.removeAttribute('hidden'); section.removeAttribute('aria-hidden');
          setDeckSide('left'); setExplainer('left');
        } else {
          section.setAttribute('hidden',''); section.setAttribute('aria-hidden','true');
        }
      },
      play: async (swipes = 3) => {
        if (prefersReduced) return true;
        window.TinderDemo.setVisible(true);
        setStack();
        await pause(600);
        for (let i = 0; i < swipes; i++) {
          await swipeOnce(i, swipes);
          if (i < swipes - 1) await pause(PAUSE);
        }
        return true;
      }
    };
  });
})();
</script>

<script>
/* =========================
   B) AI Form controller (type, upload, success)
========================= */
(() => {
  const ready = (fn) => (document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', fn, { once:true })
    : fn());

  ready(() => {
    const root = document.querySelector('.ai-demo');
    if (!root) return;

    const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
    const pause = (ms) => new Promise(r => setTimeout(r, ms));

    const fields = {
      name:      root.querySelector('#ai-name'),
      email:     root.querySelector('#ai-email'),
      portfolio: root.querySelector('#ai-portfolio'),
      resume:    root.querySelector('#ai-resume'),
      cover:     root.querySelector('#ai-cover'),
      consent:   root.querySelector('#ai-consent'),
    };

    const resumeBtn  = root.querySelector('.ai-file__btn');
    const winEl      = root.querySelector('.ai-demo__window');
    const formEl     = root.querySelector('.ai-form');

    const progressBar = root.querySelector('.ai-demo__bar');
    const progressPct = root.querySelector('.ai-demo__pct');
    const statusText  = root.querySelector('#ai-status');
    const chip        = root.querySelector('#ai-chip');

    const showChip = (ms = 2200) => {
      if (!chip) return;
      chip.classList.add('is-on');
      setTimeout(() => chip.classList.remove('is-on'), ms);
    };

    const ensureSuccessUI = () => {
      let overlay = winEl.querySelector('.ai-success');
      if (!overlay) {
        winEl.insertAdjacentHTML('beforeend', `
          <div class="ai-success" hidden>
            <div class="ai-success__card" role="dialog" aria-modal="true" aria-label="{{ _('Application sent') }}">
              <div class="ai-success__icon" aria-hidden="true">
                <svg viewBox="0 0 52 52">
                  <circle class="ring" cx="26" cy="26" r="24"></circle>
                  <path class="mark" d="M16 27l7 7 13-13"></path>
                </svg>
              </div>
              <h4>{{ _('Application sent!') }}</h4>
              <p>{{ _('Your application was sent successfully.') }}</p>
              <button type="button" class="btn btn--primary ai-success__ok">{{ _('Nice!') }}</button>
            </div>
          </div>
        `);
        overlay = winEl.querySelector('.ai-success');
      }
      return { overlay, ok: overlay.querySelector('.ai-success__ok') };
    };
    const success = ensureSuccessUI();

    const setProgress = (v) => {
      const pct = Math.min(100, Math.max(0, Math.round(v)));
      progressBar.style.setProperty('--pct', pct + '%');
      progressPct.textContent = pct + '%';
    };

    const typeInto = (el, text, speed = 22, onTick) => new Promise((resolve) => {
      if (prefersReduced) { el.value = text; onTick?.(text.length); resolve(); return; }
      let i = 0; el.value = '';
      const tick = () => {
        if (i > text.length) return resolve();
        el.value = text.slice(0, i);
        onTick?.(1);
        i++;
        setTimeout(tick, speed + Math.random() * 18);
      };
      tick();
    });

    const RESUME_WEIGHT = prefersReduced ? 1 : 60;
    const steps = [
      { el: fields.name,      text: 'Ava Jensen' },
      { el: fields.email,     text: 'ava.jensen@uni.dk' },
      { el: fields.portfolio, text: 'https://ava.work' },
      { el: fields.resume,    upload: true, focusEl: resumeBtn },
      { el: fields.cover,     text: "{{ 'I’m excited to apply for the Investment Banking Intern role. At CBS Finance Club, I led a 4-member team on DCF/LBO case prep and placed top 3 in a regional valuation challenge. I’m comfortable with Excel, PowerPoint, and Bloomberg, and I’m eager to contribute from day one.'|escapejs }}" },
      { el: fields.consent,   check: true }
    ];

    const showSuccess = () => {
      winEl.classList.add('is-success');
      formEl.classList.add('is-success');
      success.overlay.removeAttribute('hidden');
      success.overlay.classList.add('is-visible');
      success.ok?.focus();
    };
    const hideSuccess = () => {
      success.overlay.classList.remove('is-visible');
      success.overlay.setAttribute('hidden','');
      winEl.classList.remove('is-success');
      formEl.classList.remove('is-success');
    };
    const fadeOutAndHide = async (delay = 1100) => {
      if (prefersReduced) { root.setAttribute('hidden',''); root.setAttribute('aria-hidden','true'); return; }
      await pause(delay);
      winEl.classList.add('is-fading');
      await new Promise(res => winEl.addEventListener('transitionend', res, { once:true }));
      root.setAttribute('hidden',''); root.setAttribute('aria-hidden','true');
      winEl.classList.remove('is-fading');
    };
    const autoPressAndCelebrate = async () => {
      statusText.textContent = "{{ _('Submitting…') }}";
      await pause(prefersReduced ? 120 : 600);
      showSuccess();
      await fadeOutAndHide(prefersReduced ? 0 : 1100);
    };

    let isRunning = false;
    const run = async () => {
      if (isRunning) return;
      isRunning = true;

      hideSuccess();
      root.removeAttribute('hidden'); root.removeAttribute('aria-hidden');

      statusText.textContent = "{{ _('AI is preparing your application…') }}";
      showChip();

      Object.values(fields).forEach((el) => {
        if (!el) return;
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
        el.closest('.ai-field')?.classList.remove('is-active','is-done');
      });
      const resumeName = root.querySelector('.ai-file__name');
      const uploadWrap = root.querySelector('.ai-upload');
      const uploadBar  = root.querySelector('.ai-upload__bar');
      resumeName && (resumeName.textContent = resumeName.getAttribute('data-empty') || '');
      uploadWrap?.classList.remove('is-visible'); uploadBar?.style.setProperty('--up','0%');

      const totalChars = steps.reduce((n, s) => n + (s.text ? s.text.length : 0), 0) + RESUME_WEIGHT || 1;
      let typed = 0; setProgress(0);

      const focusField = (el) => {
        const wrap = el.closest('.ai-field');
        root.querySelectorAll('.ai-field').forEach(w => w.classList.remove('is-active'));
        wrap?.classList.add('is-active');
        wrap?.scrollIntoView?.({ block:'nearest', behavior: prefersReduced ? 'auto' : 'smooth' });
      };
      const checkField = (el) => el.closest('.ai-field')?.classList.add('is-done');

      const attachResume = async () => {
        statusText.textContent = "{{ _('AI is uploading your CV…') }}";
        const D = prefersReduced ? 40 : 1200; let used = 0;
        const btn = root.querySelector('.ai-file__btn');
        const upW = root.querySelector('.ai-upload');
        const upB = root.querySelector('.ai-upload__bar');
        btn?.classList.add('is-pressed'); await new Promise(r=>setTimeout(r,200)); btn?.classList.remove('is-pressed');
        upW?.classList.add('is-visible'); upB?.style.setProperty('--up','0%');
        await new Promise((resolve) => {
          const start = performance.now();
          const step = (now) => {
            const t = Math.min(1,(now-start)/D);
            upB?.style.setProperty('--up', Math.round(t*100)+'%');
            const add = Math.round(RESUME_WEIGHT * t) - used;
            if (add > 0){ used += add; typed += add; setProgress(typed/totalChars*100); }
            t<1 ? requestAnimationFrame(step) : resolve();
          }; requestAnimationFrame(step);
        });
        const nameEl = root.querySelector('.ai-file__name');
        if (nameEl) nameEl.textContent = 'Ava_Jensen_Resume.pdf';
        upW?.classList.remove('is-visible');
      };

      const pauseStep = prefersReduced ? 40 : 180;

      for (const s of steps) {
        if (!s.el) continue;
        focusField(s.focusEl || s.el);

        if (s.upload){ await attachResume(); checkField(s.el); await new Promise(r=>setTimeout(r,pauseStep)); continue; }
        if (s.check){ if (!prefersReduced) await new Promise(r=>setTimeout(r,300)); s.el.checked = true; if (!prefersReduced) await new Promise(r=>setTimeout(r,200)); checkField(s.el); continue; }

        const label = (s.el.labels?.[0]?.innerText || '').trim();
        statusText.textContent = `{{ _('AI is filling') }} “${label}”…`;
        await typeInto(s.el, s.text, 22, () => { typed += 1; setProgress(typed/totalChars*100); });
        checkField(s.el);
        await new Promise(r=>setTimeout(r,pauseStep));
      }

      setProgress(100);
      statusText.textContent = "{{ _('Ready to submit — optimized by AI.') }}";
      await autoPressAndCelebrate();
      isRunning = false;
      return true;
    };

    root.querySelector('.ai-replay')?.addEventListener('click', run);

    window.AIDemo = {
      runOnce: run,
      hide: () => { root.setAttribute('hidden',''); root.setAttribute('aria-hidden','true'); },
      show: () => { root.removeAttribute('hidden'); root.removeAttribute('aria-hidden'); }
    };
  });
})();
</script>

<script>
/* =========================
   C) Orchestrator (switches deck → form → repeat)
========================= */
(() => {
  const ready = (fn) => (document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', fn, { once:true })
    : fn());

  ready(() => {
    const stage  = document.querySelector('.demo-stage');
    const tinder = document.querySelector('.tinder-section');
    const deck   = document.querySelector('.tinder-deck');
    const form   = document.querySelector('.ai-demo');
    const overlay = document.querySelector('.demo-overlay');
    const overlayText = document.querySelector('.demo-overlay__text');
    if (!stage || !tinder || !form || !deck || !overlay || !overlayText) return;

    const pause = (ms) => new Promise(r => setTimeout(r, ms));

    const measure = () => {
      const tHidden = tinder.hasAttribute('hidden');
      const fHidden = form.hasAttribute('hidden');
      if (tHidden) tinder.removeAttribute('hidden');
      if (fHidden) form.removeAttribute('hidden');
      const h = Math.max(tinder.offsetHeight || 0, form.offsetHeight || 0, 420);
      stage.style.minHeight = h + 'px';
      if (tHidden) tinder.setAttribute('hidden','');
      if (fHidden) form.setAttribute('hidden','');
    };
    measure();
    addEventListener('resize', measure);

    const resetDeck = () => {
      const cards = [...deck.querySelectorAll('.card')];
      const order = ['card--pink','card--blue','card--yellow'];
      cards.sort((a,b) =>
        order.indexOf([...a.classList].find(c => order.includes(c))) -
        order.indexOf([...b.classList].find(c => order.includes(c)))
      );
      deck.innerHTML = '';
      cards.forEach(c => {
        c.style.opacity = '';
        c.classList.remove('swipe-left','swipe-right','is-top','is-next');
        deck.appendChild(c);
      });
      if (cards[0]) cards[0].classList.add('is-top');
      if (cards[1]) cards[1].classList.add('is-next');
    };

    (async function loop(){
      // wait until this section is visible
      await new Promise(res => {
        const io = new IntersectionObserver((entries) => {
          if (entries.some(e => e.isIntersecting)) { io.disconnect(); res(); }
        }, { threshold: 0.3 });
        io.observe(stage);
      });

      while (true) {
        resetDeck();
        overlayText.classList.remove('is-visible');
        overlay.classList.add('is-deck');
        overlay.classList.remove('is-form');

        form.setAttribute('hidden',''); form.setAttribute('aria-hidden','true');
        tinder.removeAttribute('hidden'); tinder.removeAttribute('aria-hidden');
        measure();

        const swipes = Math.max(3, window.TinderDemo?.count?.() || 3);
        await window.TinderDemo?.play?.(swipes);

        // switch to form
        tinder.setAttribute('hidden',''); tinder.setAttribute('aria-hidden','true');
        form.removeAttribute('hidden');   form.removeAttribute('aria-hidden');
        overlay.classList.remove('is-deck-left','is-deck-right');
        overlay.classList.add('is-form');
        measure();

        overlayText.textContent = '{{ _("AI applies for you") }}';
        overlayText.classList.add('is-visible');

        await window.AIDemo?.runOnce?.();
        await pause(800);

        resetDeck();
        await pause(800);
      }
    })();
  });
})();
</script>
